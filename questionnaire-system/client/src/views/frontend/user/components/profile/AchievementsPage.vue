<template>
  <div class="achievements-page">
    <!-- ç§¯åˆ†æœºåˆ¶è¯´æ˜é¢æ¿ -->
    <el-card class="points-guide-card">
      <template #header>
        <div class="guide-header">
          <el-icon :size="20"><InfoFilled /></el-icon>
          <span class="guide-title">ç§¯åˆ†æœºåˆ¶è¯´æ˜</span>
        </div>
      </template>
      <el-collapse v-model="activeGuide">
        <el-collapse-item name="earn" title="ğŸ’° å¦‚ä½•è·å¾—ç§¯åˆ†">
          <div class="guide-content">
            <div class="guide-section">
              <h4>ğŸ“ å®Œæˆé—®å·</h4>
              <ul>
                <li><strong>å®Œæˆé—®å·:</strong> æ¯å®Œæˆä¸€ä»½é—®å·è·å¾— <el-tag type="success" size="small">10ç§¯åˆ†</el-tag></li>
                <li><strong>é¦–æ¬¡å®Œæˆ:</strong> é¦–æ¬¡å®Œæˆé—®å·é¢å¤–å¥–åŠ± <el-tag type="warning" size="small">20ç§¯åˆ†</el-tag></li>
              </ul>
            </div>
            <div class="guide-section">
              <h4>âœï¸ åˆ›å»ºä¸å‘å¸ƒ</h4>
              <ul>
                <li><strong>åˆ›å»ºé—®å·:</strong> æ¯åˆ›å»ºä¸€ä»½é—®å·è·å¾— <el-tag type="success" size="small">50ç§¯åˆ†</el-tag></li>
                <li><strong>å‘å¸ƒé—®å·:</strong> æäº¤å®¡æ ¸æ—¶è·å¾— <el-tag type="success" size="small">30ç§¯åˆ†</el-tag></li>
                <li><strong>å®¡æ ¸é€šè¿‡:</strong> é—®å·å®¡æ ¸é€šè¿‡è·å¾— <el-tag type="success" size="small">20ç§¯åˆ†</el-tag></li>
              </ul>
            </div>
            <div class="guide-section">
              <h4>ğŸ¯ äº’åŠ¨è¡Œä¸º</h4>
              <ul>
                <li><strong>æ”¶è—é—®å·:</strong> æ¯æ”¶è—ä¸€ä»½é—®å·è·å¾— <el-tag type="success" size="small">3ç§¯åˆ†</el-tag></li>
                <li><strong>å‘è¡¨è¯„è®º:</strong> æ¯å‘è¡¨ä¸€æ¡è¯„è®ºè·å¾— <el-tag type="success" size="small">5ç§¯åˆ†</el-tag></li>
                <li><strong>åˆ†äº«é—®å·:</strong> æ¯åˆ†äº«ä¸€æ¬¡é—®å·è·å¾— <el-tag type="success" size="small">5ç§¯åˆ†</el-tag></li>
              </ul>
            </div>
            <div class="guide-section">
              <h4>ğŸŒŸ æ¯æ—¥ç™»å½•</h4>
              <ul>
                <li><strong>æ¯æ—¥ç™»å½•:</strong> æ¯å¤©é¦–æ¬¡ç™»å½•è·å¾— <el-tag type="success" size="small">5ç§¯åˆ†</el-tag></li>
                <li><strong>è¿ç»­3å¤©:</strong> é¢å¤–å¥–åŠ± <el-tag type="warning" size="small">5ç§¯åˆ†</el-tag></li>
                <li><strong>è¿ç»­7å¤©:</strong> é¢å¤–å¥–åŠ± <el-tag type="warning" size="small">10ç§¯åˆ†</el-tag></li>
                <li><strong>è¿ç»­30å¤©:</strong> é¢å¤–å¥–åŠ± <el-tag type="danger" size="small">50ç§¯åˆ†</el-tag></li>
              </ul>
            </div>
            <div class="guide-section">
              <h4>ğŸ‘¤ å®Œå–„èµ„æ–™</h4>
              <ul>
                <li><strong>å®Œå–„èµ„æ–™:</strong> é¦–æ¬¡å®Œå–„æ‰€æœ‰å¿…å¡«ä¿¡æ¯è·å¾— <el-tag type="success" size="small">15ç§¯åˆ†</el-tag></li>
                <li class="info-note">å¿…å¡«ä¿¡æ¯åŒ…æ‹¬ï¼šç”¨æˆ·åã€é‚®ç®±ã€æ‰‹æœºã€æ€§åˆ«ã€å¹´é¾„ã€åŸå¸‚ã€èŒä¸šã€ç®€ä»‹ã€æ ‡ç­¾</li>
              </ul>
            </div>
          </div>
        </el-collapse-item>
        <el-collapse-item name="level" title="ğŸ† ç­‰çº§ç³»ç»Ÿ">
          <div class="guide-content">
            <div class="level-formula">
              <p><strong>ç­‰çº§è®¡ç®—å…¬å¼:</strong></p>
              <div class="formula-box">
                ç­‰çº§ = âŒŠç§¯åˆ† Ã· 500âŒ‹ + 1
              </div>
            </div>
            <div class="level-table">
              <el-table :data="levelData" stripe border size="small">
                <el-table-column prop="level" label="ç­‰çº§" width="80" align="center" />
                <el-table-column prop="points" label="æ‰€éœ€ç§¯åˆ†" align="center" />
                <el-table-column prop="badge" label="å¾½ç« " width="100" align="center">
                  <template #default="{ row }">
                    <span style="font-size: 24px">{{ row.badge }}</span>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>
        </el-collapse-item>
        <el-collapse-item name="badges" title="ğŸ–ï¸ æˆå°±å¾½ç« ">
          <div class="guide-content">
            <p class="badge-intro">é€šè¿‡å®Œæˆç‰¹å®šä»»åŠ¡å¯ä»¥è§£é”æˆå°±å¾½ç« å¹¶è·å¾—é¢å¤–ç§¯åˆ†å¥–åŠ±ï¼</p>
            <div class="badge-categories">
              <el-tag type="primary" effect="plain">æ¯æ—¥ç™»å½•</el-tag>
              <el-tag type="success" effect="plain">å®Œæˆé—®å·</el-tag>
              <el-tag type="warning" effect="plain">åˆ›å»ºå‘å¸ƒ</el-tag>
              <el-tag type="danger" effect="plain">äº’åŠ¨è¡Œä¸º</el-tag>
              <el-tag type="info" effect="plain">ç§¯åˆ†ç­‰çº§</el-tag>
            </div>
            <p class="badge-note">è§£é”å¾½ç« çš„åŒæ—¶ä¼šè‡ªåŠ¨è·å¾—å¯¹åº”çš„ç§¯åˆ†å¥–åŠ±ï¼Œå¿«å»æ¢ç´¢å§ï¼</p>
          </div>
        </el-collapse-item>
      </el-collapse>
    </el-card>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <el-row :gutter="20" class="stats-row">
      <!-- ç§¯åˆ†æ€»æ•° -->
      <el-col :xs="24" :sm="12" :md="8">
        <el-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon points-icon">ğŸ’°</div>
            <div class="stat-info">
              <div class="stat-value">{{ userStats.points }}</div>
              <div class="stat-label">ç§¯åˆ†æ€»æ•°</div>
            </div>
          </div>
        </el-card>
      </el-col>

      <!-- å·²å®Œæˆé—®å· -->
      <el-col :xs="24" :sm="12" :md="8">
        <el-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon completed-icon">ğŸ“</div>
            <div class="stat-info">
              <div class="stat-value">{{ userStats.completedSurveys }}</div>
              <div class="stat-label">å·²å®Œæˆé—®å·</div>
            </div>
          </div>
        </el-card>
      </el-col>

      <!-- å·²è·å¾—å¾½ç« æ•° -->
      <el-col :xs="24" :sm="12" :md="8">
        <el-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon badge-count-icon">ğŸ…</div>
            <div class="stat-info">
              <div class="stat-value">{{ unlockedBadgesCount }}/{{ allBadges.length }}</div>
              <div class="stat-label">å·²è·å¾—å¾½ç« </div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- æˆå°±å¾½ç« åˆ—è¡¨ -->
    <el-card class="badges-section">
      <template #header>
        <div class="section-header">
          <span class="section-title">æˆå°±å¾½ç« </span>
          <el-radio-group v-model="badgeFilter" size="small">
            <el-radio-button value="unlocked">å·²è§£é”</el-radio-button>
            <el-radio-button value="locked">æœªè§£é”</el-radio-button>
          </el-radio-group>
        </div>
      </template>
      <div class="badges-grid">
        <!-- å·²è§£é”å¾½ç«  -->
        <div 
          v-for="badge in displayBadges" 
          :key="badge.id"
          class="badge-item"
          :class="badgeFilter === 'unlocked' ? 'unlocked' : 'locked'"
        >
          <div class="badge-image-wrapper">
            <div class="badge-image" :class="{ 'locked-image': badgeFilter === 'locked' }">
              <img v-if="badge.image" :src="badge.image" :alt="badge.name" @error="handleImageError" />
              <div v-else class="badge-icon-fallback">{{ badge.icon }}</div>
            </div>
            <div v-if="badgeFilter === 'locked'" class="lock-overlay">
              <el-icon :size="40"><Lock /></el-icon>
            </div>
          </div>
          
          <div class="badge-info">
            <h3 class="badge-name">{{ badge.name }}</h3>
            <p class="badge-description">{{ badge.description }}</p>
            <el-tag 
              :type="badgeFilter === 'unlocked' ? 'success' : 'info'" 
              size="small" 
              effect="plain"
            >
              {{ badgeFilter === 'unlocked' ? 'å·²è§£é”' : 'æœªè§£é”' }}
            </el-tag>
            <div v-if="badgeFilter === 'unlocked'" class="badge-reward">
              <el-icon><Star /></el-icon>
              +{{ badge.points }} ç§¯åˆ†
            </div>
            <div v-else class="badge-progress">
              <span>è¿›åº¦ï¼š{{ getCurrentProgress(badge) }}/{{ badge.requirement }}</span>
            </div>
          </div>
        </div>
      </div>
      <el-empty 
        v-if="displayBadges.length === 0" 
        :description="badgeFilter === 'unlocked' ? 'æš‚æ— å·²è§£é”å¾½ç« ' : 'æ­å–œï¼å·²è§£é”æ‰€æœ‰å¾½ç« '" 
      />
    </el-card>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useUserStore } from '@/store/user';
import { getUserAnsweredSurveysApi } from '@/api/user';
import apiClient from '@/api/index.js';
import { ElMessage } from 'element-plus';
import { Lock, Star, InfoFilled } from '@element-plus/icons-vue';

const userStore = useUserStore();

// ç§¯åˆ†æŒ‡å—æŠ˜å é¢æ¿
const activeGuide = ref(['earn']);

// ç­‰çº§æ•°æ®
const levelData = [
  { level: 1, points: '0-499', badge: 'ğŸ¯' },
  { level: 2, points: '500-999', badge: 'ğŸ¥‰' },
  { level: 3, points: '1000-1499', badge: 'ğŸ¥ˆ' },
  { level: 4, points: '1500-1999', badge: 'ğŸ¥‡' },
  { level: 5, points: '2000-2499', badge: 'ğŸ†' },
  { level: 10, points: '4500-4999', badge: 'ğŸ‘‘' },
];

// ç”¨æˆ·ç»Ÿè®¡æ•°æ®
const userStats = ref({
  points: 0,
  completedSurveys: 0
});

// å¾½ç« è¿‡æ»¤å™¨
const badgeFilter = ref('unlocked');

// ç”¨æˆ·å·²è§£é”çš„å¾½ç« IDåˆ—è¡¨ï¼ˆä»json-serverè¯»å–ï¼‰
const userUnlockedBadgeIds = ref([]);

// æ‰€æœ‰å¾½ç« å®šä¹‰ï¼ˆä»json-serverè¯»å–ï¼‰
const allBadges = ref([]);

// ç”¨æˆ·ç­”é¢˜ç»Ÿè®¡
const answerStats = ref({
  perfectScoreCount: 0,
  highScoreCount: 0,
  speedPerfectCount: 0,
  fastCompleteCount: 0,
  consecutiveDays: 0,
  categoryCount: 0,
  earlyBirdCount: 0,
  registerDays: 0,
  shareCount: 0,
  loginCount: 0,
  continuousLoginDays: 0,
  createCount: 0,
  publishCount: 0,
  approvedCount: 0,
  favoriteCount: 0,
  commentCount: 0,
  profileComplete: 0
});

// å·²è§£é”å¾½ç« åˆ—è¡¨ï¼ˆä»json-serverè¯»å–ï¼‰
const unlockedBadges = computed(() => {
  return allBadges.value.filter(badge => userUnlockedBadgeIds.value.includes(badge.id));
});

// æœªè§£é”å¾½ç« åˆ—è¡¨
const lockedBadges = computed(() => {
  return allBadges.value.filter(badge => !userUnlockedBadgeIds.value.includes(badge.id));
});

// å·²è§£é”å¾½ç« æ•°é‡
const unlockedBadgesCount = computed(() => {
  return unlockedBadges.value.length;
});

// æ ¹æ®è¿‡æ»¤å™¨æ˜¾ç¤ºçš„å¾½ç« 
const displayBadges = computed(() => {
  return badgeFilter.value === 'unlocked' ? unlockedBadges.value : lockedBadges.value;
});

// è·å–å½“å‰è¿›åº¦
const getCurrentProgress = (badge) => {
  // æ ¹æ®å¾½ç« ç±»å‹è¿”å›å¯¹åº”çš„è¿›åº¦
  if (!badge.type) return 0;
  
  switch (badge.type) {
    case 'survey_count':
      return userStats.value.completedSurveys;
    case 'perfect_score':
      return answerStats.value.perfectScoreCount;
    case 'high_score':
      return answerStats.value.highScoreCount;
    case 'speed_perfect':
      return answerStats.value.speedPerfectCount;
    case 'fast_complete':
      return answerStats.value.fastCompleteCount;
    case 'consecutive_days':
      return answerStats.value.consecutiveDays;
    case 'category_count':
      return answerStats.value.categoryCount;
    case 'early_bird':
      return answerStats.value.earlyBirdCount;
    case 'total_points':
      return userStats.value.points;
    case 'register_days':
      return answerStats.value.registerDays;
    case 'share_count':
      return answerStats.value.shareCount;
    case 'login_count':
      return answerStats.value.loginCount;
    case 'continuous_login':
      return answerStats.value.continuousLoginDays;
    case 'create_count':
      return answerStats.value.createCount;
    case 'publish_count':
      return answerStats.value.publishCount;
    case 'approved_count':
      return answerStats.value.approvedCount;
    case 'favorite_count':
      return answerStats.value.favoriteCount;
    case 'comment_count':
      return answerStats.value.commentCount;
    case 'profile_complete':
      return answerStats.value.profileComplete;
    case 'user_level':
      return userStore.profile?.level || 1;
    default:
      return 0;
  }
};

// åŠ è½½ç”¨æˆ·æ•°æ®
const loadUserData = async () => {
  try {
    const userId = userStore.userId;
    if (!userId) {
      ElMessage.warning('è¯·å…ˆç™»å½•');
      return;
    }

    // åŠ è½½æ‰€æœ‰å¾½ç« å®šä¹‰
    const badgesData = await apiClient.get('/badges');
    allBadges.value = badgesData;

    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    const userInfo = await apiClient.get(`/users/${userId}`);
    userStats.value.points = userInfo.points || 0;
    
    // è·å–ç”¨æˆ·å·²è§£é”çš„å¾½ç« IDåˆ—è¡¨
    userUnlockedBadgeIds.value = userInfo.unlockedBadges || [];

    // è·å–æ‰€æœ‰é—®å·,ç»Ÿè®¡ç”¨æˆ·çš„ç­”é¢˜è®°å½•
    const allSurveys = await apiClient.get('/surveys');
    let userAnswers = [];
    
    // ä»æ‰€æœ‰é—®å·çš„ answers ä¸­æå–è¯¥ç”¨æˆ·çš„ç­”æ¡ˆ
    allSurveys.forEach(survey => {
      if (Array.isArray(survey.answers)) {
        const answers = survey.answers.filter(answer => answer.userId == userId);
        answers.forEach(answer => {
          userAnswers.push({
            ...answer,
            survey: {
              title: survey.title,
              duration: survey.duration,
              category: survey.category
            },
            category: survey.category
          });
        });
      }
    });

    userStats.value.completedSurveys = userAnswers.length;

    // ç»Ÿè®¡å„ç§æˆå°±
    answerStats.value.perfectScoreCount = userAnswers.filter(a => a.score === 100).length;
    answerStats.value.highScoreCount = userAnswers.filter(a => a.score >= 90).length;
    
    // ç»Ÿè®¡é€Ÿé€šæ»¡åˆ†æ¬¡æ•°ï¼ˆå‡è®¾é—®å·é¢„è®¡æ—¶é—´çš„70%å†…å®Œæˆä¸”æ»¡åˆ†ï¼‰
    const speedPerfects = userAnswers.filter(a => {
      if (!a.survey || !a.survey.duration || !a.duration) return false;
      const expectedTime = a.survey.duration * 60;
      const actualTime = a.duration;
      return a.score === 100 && actualTime <= expectedTime * 0.7;
    });
    answerStats.value.speedPerfectCount = speedPerfects.length;

    // ç»Ÿè®¡å¿«é€Ÿå®Œæˆæ¬¡æ•°ï¼ˆå‡è®¾é—®å·é¢„è®¡æ—¶é—´çš„80%å†…å®Œæˆï¼‰
    const fastCompletes = userAnswers.filter(a => {
      if (!a.survey || !a.survey.duration || !a.duration) return false;
      const expectedTime = a.survey.duration * 60;
      const actualTime = a.duration;
      return actualTime <= expectedTime * 0.8;
    });
    answerStats.value.fastCompleteCount = fastCompletes.length;

    // ç»Ÿè®¡ä¸åŒåˆ†ç±»æ•°é‡
    const categories = new Set(userAnswers.map(a => a.category).filter(Boolean));
    answerStats.value.categoryCount = categories.size;

    // ç»Ÿè®¡æ—©èµ·é¸Ÿæ¬¡æ•°(6-8ç‚¹)
    const earlyBirds = userAnswers.filter(a => {
      if (!a.submittedAt) return false;
      const hour = new Date(a.submittedAt).getHours();
      return hour >= 6 && hour < 8;
    });
    answerStats.value.earlyBirdCount = earlyBirds.length;

    // è®¡ç®—è¿ç»­ç­”é¢˜å¤©æ•°
    if (userAnswers.length > 0) {
      const sortedDates = userAnswers
        .map(a => new Date(a.submittedAt).toDateString())
        .sort()
        .reverse();
      
      let consecutive = 1;
      let currentStreak = 1;
      
      for (let i = 1; i < sortedDates.length; i++) {
        const date1 = new Date(sortedDates[i - 1]);
        const date2 = new Date(sortedDates[i]);
        const diffDays = Math.floor((date1 - date2) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
          currentStreak++;
          consecutive = Math.max(consecutive, currentStreak);
        } else if (diffDays > 1) {
          currentStreak = 1;
        }
      }
      
      answerStats.value.consecutiveDays = consecutive;
    }

    // è®¡ç®—æ³¨å†Œå¤©æ•°
    if (userInfo.joinedDate) {
      const joinDate = new Date(userInfo.joinedDate);
      const now = new Date();
      const diffTime = Math.abs(now - joinDate);
      answerStats.value.registerDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // åˆ†äº«æ¬¡æ•°ï¼ˆä»ç”¨æˆ·æ•°æ®è·å–ï¼‰
    answerStats.value.shareCount = userInfo.shareCount || 0;
    
    // è¿ç»­ç™»å½•å¤©æ•°
    answerStats.value.continuousLoginDays = userInfo.continuousLoginDays || 0;
    
    // ç™»å½•æ¬¡æ•°ï¼ˆå¯ä»¥æ ¹æ®lastLoginAtè®¡ç®—ï¼‰
    answerStats.value.loginCount = userInfo.loginCount || 0;
    
    // è·å–ç”¨æˆ·åˆ›å»ºçš„é—®å·æ•°é‡
    const userCreatedSurveys = allSurveys.filter(s => s.authorId == userId || s.creatorId == userId);
    answerStats.value.createCount = userCreatedSurveys.length;
    
    // ç»Ÿè®¡å‘å¸ƒæ•°é‡ï¼ˆstatusä¸ºpendingæˆ–publishedï¼‰
    answerStats.value.publishCount = userCreatedSurveys.filter(s => 
      s.status === 'pending' || s.status === 'published'
    ).length;
    
    // ç»Ÿè®¡å®¡æ ¸é€šè¿‡æ•°é‡
    answerStats.value.approvedCount = userCreatedSurveys.filter(s => 
      s.status === 'published'
    ).length;
    
    // è·å–æ”¶è—æ•°é‡
    try {
      const favorites = await apiClient.get('/favorites');
      answerStats.value.favoriteCount = favorites.filter(f => f.userId == userId).length;
    } catch (error) {
      console.error('è·å–æ”¶è—æ•°æ®å¤±è´¥:', error);
    }
    
    // ç»Ÿè®¡è¯„è®ºæ•°é‡ï¼ˆä»Surveysä¸­çš„commentsç»Ÿè®¡ï¼‰
    let commentCount = 0;
    allSurveys.forEach(survey => {
      if (Array.isArray(survey.comments)) {
        commentCount += survey.comments.filter(c => c.userId == userId).length;
      }
    });
    answerStats.value.commentCount = commentCount;
    
    // æ£€æŸ¥èµ„æ–™æ˜¯å¦å®Œå–„
    const isProfileComplete = userInfo.username && userInfo.email && userInfo.phone && 
                             userInfo.gender && userInfo.age && userInfo.city && 
                             userInfo.profession && userInfo.bio && 
                             Array.isArray(userInfo.tags) && userInfo.tags.length > 0;
    answerStats.value.profileComplete = isProfileComplete ? 1 : 0;

    // æ£€æŸ¥å¹¶è‡ªåŠ¨è§£é”å¾½ç« 
    await checkAndUnlockBadges();
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
    ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥');
  }
};

// æ£€æŸ¥å¹¶è‡ªåŠ¨è§£é”å¾½ç« 
const checkAndUnlockBadges = async () => {
  try {
    const userId = userStore.userId;
    const newlyUnlocked = [];
    
    // æ£€æŸ¥æ¯ä¸ªå¾½ç« çš„è§£é”æ¡ä»¶
    for (const badge of allBadges.value) {
      // å¦‚æœå·²ç»è§£é”ï¼Œè·³è¿‡
      if (userUnlockedBadgeIds.value.includes(badge.id)) {
        continue;
      }
      
      // æ ¹æ®å¾½ç« ç±»å‹æ£€æŸ¥æ˜¯å¦åº”è¯¥è§£é”
      let shouldUnlock = false;
      const currentProgress = getCurrentProgress(badge);
      shouldUnlock = currentProgress >= badge.requirement;
      
      if (shouldUnlock) {
        newlyUnlocked.push(badge);
        userUnlockedBadgeIds.value.push(badge.id);
      }
    }
    
    // å¦‚æœæœ‰æ–°è§£é”çš„å¾½ç« ï¼Œæ›´æ–°ç”¨æˆ·æ•°æ®
    if (newlyUnlocked.length > 0) {
      // è®¡ç®—æ–°å¢çš„ç§¯åˆ†
      const addedPoints = newlyUnlocked.reduce((sum, badge) => sum + badge.points, 0);
      const newPoints = userStats.value.points + addedPoints;
      
      // æ›´æ–°json-serverä¸­çš„ç”¨æˆ·æ•°æ®
      await apiClient.patch(`/users/${userId}`, {
        unlockedBadges: userUnlockedBadgeIds.value,
        points: newPoints
      });
      
      // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
      userStats.value.points = newPoints;
      
      // æ˜¾ç¤ºè§£é”æç¤º
      for (const badge of newlyUnlocked) {
        ElMessage.success({
          message: `ğŸ‰ æ­å–œè§£é”å¾½ç« ï¼š${badge.name}ï¼è·å¾— ${badge.points} ç§¯åˆ†`,
          duration: 3000
        });
      }
    }
  } catch (error) {
    console.error('æ£€æŸ¥å¾½ç« è§£é”å¤±è´¥:', error);
  }
};

// å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
const handleImageError = (e) => {
  e.target.style.display = 'none';
};

onMounted(() => {
  loadUserData();
});
</script>

<style scoped lang="scss">
.achievements-page {
  padding: 20px;

  @media (max-width: 768px) {
    padding: 10px;
  }
}

/* ç§¯åˆ†æŒ‡å—å¡ç‰‡ */
.points-guide-card {
  margin-bottom: 30px;
  
  .guide-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 18px;
    font-weight: bold;
    color: #303133;
  }
  
  .guide-content {
    .guide-section {
      margin-bottom: 20px;
      
      h4 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #409EFF;
        font-weight: 600;
      }
      
      ul {
        margin: 0;
        padding-left: 20px;
        
        li {
          margin-bottom: 8px;
          line-height: 1.8;
          color: #606266;
          
          strong {
            color: #303133;
          }
          
          &.info-note {
            font-size: 12px;
            color: #909399;
            list-style: none;
            margin-left: -20px;
            padding: 8px 12px;
            background: #f4f4f5;
            border-radius: 4px;
            margin-top: 5px;
          }
        }
      }
    }
    
    .level-formula {
      margin-bottom: 20px;
      
      p {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #303133;
      }
      
      .formula-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        font-family: 'Courier New', monospace;
      }
    }
    
    .level-table {
      margin-top: 15px;
    }
    
    .badge-intro {
      margin: 0 0 15px 0;
      font-size: 14px;
      color: #606266;
      line-height: 1.6;
    }
    
    .badge-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .badge-note {
      margin: 15px 0 0 0;
      padding: 10px 15px;
      background: #fff9e6;
      border-left: 3px solid #E6A23C;
      border-radius: 4px;
      font-size: 13px;
      color: #606266;
    }
  }
}

/* ç»Ÿè®¡å¡ç‰‡è¡Œ */
.stats-row {
  margin-bottom: 30px;

  .stat-card {
    height: 100%;
    transition: all 0.3s ease;

    &:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-content {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;

      .stat-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 12px;
        font-size: 32px;
        flex-shrink: 0;

        @media (max-width: 768px) {
          width: 50px;
          height: 50px;
          font-size: 28px;
        }

        &.points-icon {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        &.completed-icon {
          background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        &.badge-count-icon {
          background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
      }

      .stat-info {
        flex: 1;

        .stat-value {
          font-size: 32px;
          font-weight: bold;
          color: #303133;
          line-height: 1;
          margin-bottom: 8px;

          @media (max-width: 768px) {
            font-size: 24px;
          }
        }

        .stat-label {
          font-size: 14px;
          color: #909399;
        }
      }
    }
  }
}

/* å¾½ç« åŒºåŸŸ */
.badges-section {
  margin-top: 20px;

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;

    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #303133;
    }
  }

  .badges-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 20px;
    margin-top: 20px;

    @media (min-width: 1201px) and (max-width: 1600px) {
      grid-template-columns: repeat(4, 1fr);
    }

    @media (min-width: 769px) and (max-width: 1200px) {
      grid-template-columns: repeat(3, 1fr);
    }

    @media (max-width: 768px) {
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
  }

  .badge-item {
    background: #fff;
    border: 2px solid #e4e7ed;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;

    &:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    &.locked {
      background: #f5f7fa;
    }

    &.unlocked {
      border-color: #67C23A;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }

    .badge-image-wrapper {
      position: relative;
      width: 70px;
      height: 70px;
      margin: 0 auto 10px;

      @media (max-width: 768px) {
        width: 60px;
        height: 60px;
      }

      .badge-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;

        &.locked-image {
          background: #dcdfe6;
          filter: grayscale(100%);
        }

        img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }

        .badge-icon-fallback {
          font-size: 32px;

          @media (max-width: 768px) {
            font-size: 28px;
          }
        }
      }

      .lock-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }
    }

    .badge-info {
      margin-top: 5px;

      .badge-name {
        font-size: 14px;
        font-weight: bold;
        color: #303133;
        margin: 0 0 5px 0;

        @media (max-width: 768px) {
          font-size: 13px;
        }
      }

      .badge-description {
        font-size: 12px;
        color: #606266;
        margin: 0 0 8px 0;
        min-height: 32px;
        line-height: 1.4;

        @media (max-width: 768px) {
          font-size: 11px;
        }
      }

      .badge-progress {
        margin-top: 8px;
        font-size: 12px;
        color: #909399;
        font-weight: 500;
      }

      .badge-reward {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 8px;
        padding: 3px 10px;
        background: #fff9e6;
        border-radius: 20px;
        color: #E6A23C;
        font-size: 12px;
        font-weight: 500;
      }
    }
  }
}
</style>
# é—®å·åˆ›å»ºä¸è·³è½¬é€»è¾‘å¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [é—®å·åˆ›å»ºæµç¨‹](#é—®å·åˆ›å»ºæµç¨‹)
3. [è·³è½¬é€»è¾‘å®ç°](#è·³è½¬é€»è¾‘å®ç°)
4. [ç­”é¢˜æµç¨‹](#ç­”é¢˜æµç¨‹)
5. [å…³é”®ä»£ç è§£æ](#å…³é”®ä»£ç è§£æ)
6. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒç»„ä»¶

```
src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ QuestionnaireEditor.vue          # ç»Ÿä¸€çš„é—®å·ç¼–è¾‘å™¨ç»„ä»¶ï¼ˆå‰å°+åå°ï¼‰
â”œâ”€â”€ composables/
â”‚   â”œâ”€â”€ useQuestionnaireEditor.js        # é—®å·ç¼–è¾‘å™¨é€»è¾‘
â”‚   â”œâ”€â”€ useQuestionnaireLogic.js         # ç­”é¢˜é€»è¾‘ä¸è·³è½¬æ§åˆ¶
â”‚   â””â”€â”€ useAnswerTimer.js                # ç­”é¢˜è®¡æ—¶å™¨
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â””â”€â”€ survey/
â”‚   â”‚       â””â”€â”€ AnswerPage.vue           # ç­”é¢˜é¡µé¢
â”‚   â””â”€â”€ backend/
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ components/
â”‚               â””â”€â”€ questionnaires/
â””â”€â”€ api/
    â”œâ”€â”€ questionnaire.js                 # é—®å·API
    â””â”€â”€ survey.js                        # è°ƒæŸ¥API
```

### æ•°æ®æµå‘

```
ç”¨æˆ·æ“ä½œ â†’ QuestionnaireEditor â†’ useQuestionnaireEditor â†’ API
                                                           â†“
ç­”é¢˜è€… â†’ AnswerPage â†’ useQuestionnaireLogic â†’ è·³è½¬å¼•æ“ â†’ æäº¤ç»“æœ
```

---

## é—®å·åˆ›å»ºæµç¨‹

### 1. ç»„ä»¶å…¥å£

**æ–‡ä»¶**: `src/components/QuestionnaireEditor.vue`

é—®å·ç¼–è¾‘å™¨æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„ç»„ä»¶ï¼Œé€šè¿‡ `isAdmin` è®¡ç®—å±æ€§è‡ªåŠ¨åˆ¤æ–­å½“å‰ç”¨æˆ·è§’è‰²ï¼š

```javascript
const isAdmin = computed(() => userStore.profile?.role === "admin");
```

**æ ·å¼å·®å¼‚**:

- **æ™®é€šç”¨æˆ·**: `padding: 30px 285px; background: var(--theme-background-color)`
- **ç®¡ç†å‘˜**: `padding: 30px 155px; background: transparent`

### 2. åˆå§‹åŒ–æµç¨‹

```javascript
onMounted(() => {
  initialize(); // è°ƒç”¨ composable çš„åˆå§‹åŒ–æ–¹æ³•
});

// åœ¨ useQuestionnaireEditor.js ä¸­
const initialize = () => {
  loadCategories(); // åŠ è½½åˆ†ç±»æ•°æ®

  // åˆ¤æ–­ç¼–è¾‘æ¨¡å¼
  if (route.path.includes("/edit/")) {
    isEditMode.value = true;
    loadQuestionnaireForEdit(route.params.id);
  } else if (route.path.includes("/template/")) {
    isTemplateMode.value = true;
    loadTemplate(route.params.id);
  } else {
    checkLocalDraft(); // æ£€æŸ¥æœ¬åœ°è‰ç¨¿
  }

  startAutoSave(); // å¯åŠ¨è‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
  window.addEventListener("beforeunload", handleBeforeUnload);
};
```

### 3. é—®é¢˜ç±»å‹é…ç½®

æ”¯æŒå››ç§é—®é¢˜ç±»å‹ï¼š

```javascript
const questionTypes = {
  'single': {
    type: 'single',
    title: 'æ–°çš„å•é€‰é¢˜',
    required: false,
    options: [
      { id: 'opt1', text: 'é€‰é¡¹1' },
      { id: 'opt2', text: 'é€‰é¡¹2' }
    ],
    enableLogic: false,    // æ˜¯å¦å¯ç”¨è·³è½¬é€»è¾‘
    logicRules: []         // è·³è½¬è§„åˆ™æ•°ç»„
  },
  'multiple': {
    type: 'multiple',
    title: 'æ–°çš„å¤šé€‰é¢˜',
    required: false,
    options: [...],
    enableLogic: false,
    logicRules: []
  },
  'text': {
    type: 'text',
    title: 'æ–°çš„æ–‡æœ¬é¢˜',
    required: false,
    textType: 'text',
    placeholder: 'è¯·è¾“å…¥...',
    maxLength: 500
  },
  'rating': {
    type: 'rating',
    title: 'æ–°çš„è¯„åˆ†é¢˜',
    required: false,
    minRating: 1,
    maxRating: 5,
    ratingStyle: 'star'
  }
}
```

### 4. æœ¬åœ°å­˜å‚¨ä¸è‡ªåŠ¨ä¿å­˜

```javascript
// è‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
const startAutoSave = () => {
  autoSaveTimer.value = setInterval(() => {
    const currentData = buildQuestionnaireData("draft");
    const dataStr = JSON.stringify(currentData);

    // åªæœ‰æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¿å­˜
    if (dataStr !== lastSavedData.value) {
      saveToLocalStorage(currentData);
      lastSavedData.value = dataStr;
    }
  }, 30000);
};

// å­˜å‚¨é”®å
const key = isEditMode.value
  ? `edit_questionnaire_${currentQuestionnaireId.value}`
  : "new_questionnaire_draft";
```

---

## è·³è½¬é€»è¾‘å®ç°

### 1. è·³è½¬è§„åˆ™æ•°æ®ç»“æ„

```javascript
// é—®é¢˜å¯¹è±¡
{
  id: 'q1',
  title: 'æ‚¨å¯¹æˆ‘ä»¬çš„äº§å“æ»¡æ„å—ï¼Ÿ',
  type: 'single',
  required: true,
  enableLogic: true,        // å¯ç”¨è·³è½¬é€»è¾‘
  logicRules: [             // è·³è½¬è§„åˆ™æ•°ç»„
    {
      optionId: 'opt1',     // è§¦å‘è§„åˆ™çš„é€‰é¡¹ID
      isEnd: false,         // æ˜¯å¦ç»“æŸé—®å·
      targetQuestion: 3     // è·³è½¬åˆ°ç¬¬å‡ é¢˜ï¼ˆ1-basedï¼‰
    },
    {
      optionId: 'opt2',
      isEnd: true,          // é€‰æ‹©æ­¤é€‰é¡¹åç›´æ¥ç»“æŸé—®å·
      targetQuestion: null
    }
  ],
  options: [
    { id: 'opt1', text: 'æ»¡æ„' },
    { id: 'opt2', text: 'ä¸æ»¡æ„' }
  ]
}
```

### 2. è·³è½¬è§„åˆ™ç¼–è¾‘ç•Œé¢

åœ¨ `QuestionnaireEditor.vue` ä¸­ï¼š

```vue
<el-select
  :model-value="rule.isEnd ? 'end' : rule.targetQuestion"
  @change="updateLogicRuleTarget(question.id, ruleIndex, $event)"
  placeholder="é€‰æ‹©åŠ¨ä½œ"
>
  <!-- ç»“æŸé—®å·é€‰é¡¹ -->
  <el-option label="ç»“æŸé—®å·" value="end" />
  
  <!-- è·³è½¬åˆ°åç»­é¢˜ç›® -->
  <el-option
    v-for="(q, qIdx) in questions"
    :key="qIdx"
    :value="qIdx + 1"
    :label="`è·³è½¬åˆ°ç¬¬${qIdx + 1}é¢˜: ${q.title || 'æœªå‘½å'}`"
    :disabled="qIdx <= index"  // ä¸èƒ½è·³è½¬åˆ°å‰é¢çš„é¢˜ç›®
  />
</el-select>
```

### 3. è·³è½¬è§„åˆ™æ›´æ–°é€»è¾‘

```javascript
const updateLogicRuleTarget = (questionId, ruleIndex, target) => {
  const question = questions.value.find((q) => q.id === questionId);
  if (question && question.logicRules && question.logicRules[ruleIndex]) {
    // å¦‚æœé€‰æ‹©"ç»“æŸé—®å·"ï¼ˆå€¼ä¸º 'end'ï¼‰
    if (target === "end") {
      question.logicRules[ruleIndex].isEnd = true;
      question.logicRules[ruleIndex].targetQuestion = null;
    } else {
      question.logicRules[ruleIndex].isEnd = false;
      question.logicRules[ruleIndex].targetQuestion = target;
    }
  }
};
```

### 4. é‡è¦çº¦æŸ

**âš ï¸ è·³è½¬é€»è¾‘é™åˆ¶**ï¼š

- åªæœ‰ **å•é€‰é¢˜** å’Œ **å¤šé€‰é¢˜** æ”¯æŒè·³è½¬é€»è¾‘
- **æ–‡æœ¬é¢˜** å’Œ **è¯„åˆ†é¢˜** ä¸æ”¯æŒè·³è½¬ï¼ˆä¼šè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜ï¼‰
- åªèƒ½è·³è½¬åˆ° **å½“å‰é¢˜ç›®ä¹‹å** çš„é¢˜ç›®
- ä¸èƒ½è·³è½¬åˆ°å‰é¢å·²ç»å›ç­”è¿‡çš„é¢˜ç›®

---

## ç­”é¢˜æµç¨‹

### 1. ç­”é¢˜é¡µé¢åˆå§‹åŒ–

**æ–‡ä»¶**: `src/views/frontend/survey/AnswerPage.vue`

```javascript
onMounted(async () => {
  // 1. åŠ è½½é—®å·æ•°æ®
  const surveyData = await getSurveyDetail(route.params.id);
  questionnaire.id = surveyData.id;
  questionnaire.title = surveyData.title;
  questionnaire.questions = surveyData.questions || [];

  // 2. ä¸ºé—®é¢˜æ·»åŠ é»˜è®¤çš„ order å­—æ®µ
  questionnaire.questions.forEach((q, index) => {
    if (q.order === undefined) {
      q.order = index + 1;
    }
  });

  // 3. åˆå§‹åŒ–ç­”é¢˜é€»è¾‘
  initializeLogic(questionnaire.questions);

  // 4. å¼€å§‹è®¡æ—¶
  startTimer();
});
```

### 2. è·³è½¬å¼•æ“æ ¸å¿ƒé€»è¾‘

**æ–‡ä»¶**: `src/composables/useQuestionnaireLogic.js`

```javascript
const nextQuestion = (questionList) => {
  const question = currentQuestion.value;

  // æ£€æŸ¥æ˜¯å¦æœ‰è·³è½¬é€»è¾‘
  if (
    question?.enableLogic &&
    question.logicRules &&
    question.logicRules.length > 0
  ) {
    const userAnswer = answers.value[question.id];
    let matchedRule = null;

    // å•é€‰é¢˜åŒ¹é…
    if (question.type === "single") {
      matchedRule = question.logicRules.find(
        (rule) => rule.optionId === userAnswer
      );
    }
    // å¤šé€‰é¢˜åŒ¹é…ï¼ˆåªè¦é€‰ä¸­çš„ç­”æ¡ˆä¸­åŒ…å«è§„åˆ™çš„é€‰é¡¹ï¼‰
    else if (question.type === "multiple" && Array.isArray(userAnswer)) {
      matchedRule = question.logicRules.find((rule) =>
        userAnswer.includes(rule.optionId)
      );
    }

    if (matchedRule) {
      // âœ… æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†"ç»“æŸé—®å·"
      if (matchedRule.isEnd) {
        return "complete"; // è§¦å‘æäº¤é—®å·
      }

      // âœ… è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
      const targetIndex = matchedRule.targetQuestion - 1; // è½¬æ¢ä¸º 0-based ç´¢å¼•
      if (targetIndex >= 0 && targetIndex < totalQuestions.value) {
        currentQuestionIndex.value = targetIndex;
        return "jumped";
      }
    }
  }

  // æ­£å¸¸è¿›å…¥ä¸‹ä¸€é¢˜
  if (isLastQuestion.value) {
    return "complete";
  } else {
    currentQuestionIndex.value++;
    return "next";
  }
};
```

### 3. é¢„æœŸè·¯å¾„è®¡ç®—

ç”¨äºè®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”å’ŒéªŒè¯å¿…ç­”é¢˜ï¼š

```javascript
const computeExpectedPath = () => {
  const orderedQuestions = getOrderedQuestions();
  const path = []; // é¢„æœŸè¦å›ç­”çš„é¢˜ç›®IDåˆ—è¡¨
  const seen = new Set(); // é˜²æ­¢å¾ªç¯è·³è½¬
  let idx = 0;

  while (idx >= 0 && idx < orderedQuestions.length) {
    const q = orderedQuestions[idx];

    // é˜²æ­¢é‡å¤è®¿é—®ï¼ˆå¾ªç¯æ£€æµ‹ï¼‰
    if (!q || seen.has(String(q.id))) break;

    path.push(String(q.id));
    seen.add(String(q.id));

    // æ£€æŸ¥è·³è½¬é€»è¾‘
    if (q.enableLogic && q.logicRules && q.logicRules.length > 0) {
      const userAnswer = committedAnswers.value[q.id];
      let matchedRule = null;

      if (q.type === "single") {
        matchedRule = q.logicRules.find((rule) => rule.optionId === userAnswer);
      } else if (q.type === "multiple" && Array.isArray(userAnswer)) {
        matchedRule = q.logicRules.find((rule) =>
          userAnswer.includes(rule.optionId)
        );
      }

      if (matchedRule) {
        // âœ… å¦‚æœè§„åˆ™æ ‡è®°ä¸ºç»“æŸé—®å·ï¼Œè·¯å¾„åˆ°æ­¤ä¸ºæ­¢
        if (matchedRule.isEnd) {
          break;
        }

        // âœ… è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
        const targetIndex = matchedRule.targetQuestion - 1;
        if (targetIndex >= 0 && targetIndex < orderedQuestions.length) {
          idx = targetIndex;
          continue;
        } else {
          break;
        }
      }
    }

    idx++; // æ­£å¸¸è¿›å…¥ä¸‹ä¸€é¢˜
  }

  return path;
};
```

### 4. å¿…ç­”é¢˜éªŒè¯ï¼ˆå…³é”®ä¿®å¤ï¼‰

**åªéªŒè¯é¢„æœŸè·¯å¾„ä¸Šçš„å¿…ç­”é¢˜**ï¼š

```javascript
const validateRequiredQuestions = (questionList) => {
  const qs = questionList || questions.value;

  // âœ… è·å–é¢„æœŸè·¯å¾„ä¸Šçš„é¢˜ç›®ID
  const pathIds = new Set(expectedPath.value);

  // âœ… åªéªŒè¯åœ¨é¢„æœŸè·¯å¾„ä¸Šçš„å¿…ç­”é¢˜
  const unansweredRequired = qs.filter((q) => {
    const isInPath = pathIds.has(String(q.id)); // å¿…é¡»åœ¨é¢„æœŸè·¯å¾„ä¸Š
    const isRequired = q.required; // å¿…é¡»æ˜¯å¿…ç­”é¢˜
    const isUnanswered =
      answers.value[q.id] === undefined ||
      answers.value[q.id] === null ||
      answers.value[q.id] === ""; // å¿…é¡»æœªå›ç­”

    return isInPath && isRequired && isUnanswered;
  });

  return {
    isValid: unansweredRequired.length === 0,
    unansweredRequired,
  };
};
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

å‡è®¾æœ‰ 3 é“é¢˜ï¼š

- ç¬¬ 1 é¢˜ï¼ˆå¿…ç­”ï¼‰ï¼šå¯ç”¨è·³è½¬é€»è¾‘ï¼Œé€‰é¡¹ A â†’ ç»“æŸé—®å·
- ç¬¬ 2 é¢˜ï¼ˆå¿…ç­”ï¼‰
- ç¬¬ 3 é¢˜ï¼ˆå¿…ç­”ï¼‰

å¦‚æœç”¨æˆ·åœ¨ç¬¬ 1 é¢˜é€‰æ‹©äº† Aï¼š

- **é¢„æœŸè·¯å¾„**: `[ç¬¬1é¢˜]`
- **éªŒè¯æ—¶**: åªæ£€æŸ¥ç¬¬ 1 é¢˜æ˜¯å¦å›ç­”
- **ç»“æœ**: âœ… ä¸ä¼šè¦æ±‚å›ç­”ç¬¬ 2 é¢˜å’Œç¬¬ 3 é¢˜

### 5. æŒ‰é’®æ–‡æœ¬åŠ¨æ€æ˜¾ç¤º

```javascript
// æ˜¯å¦åº”è¯¥æ˜¾ç¤º"æäº¤é—®å·"æŒ‰é’®ï¼ˆè€ƒè™‘è·³è½¬é€»è¾‘ï¼‰
const shouldShowSubmit = computed(() => {
  // 1. å¦‚æœæ˜¯æœ€åä¸€é¢˜ï¼Œæ˜¾ç¤ºæäº¤
  if (isLastQuestion.value) {
    return true;
  }

  // 2. æ£€æŸ¥å½“å‰é¢˜ç›®æ˜¯å¦æœ‰"ç»“æŸé—®å·"çš„è·³è½¬é€»è¾‘
  const question = currentQuestion.value;
  if (
    question?.enableLogic &&
    question.logicRules &&
    question.logicRules.length > 0
  ) {
    const userAnswer = currentAnswer.value;
    let matchedRule = null;

    if (question.type === "single") {
      matchedRule = question.logicRules.find(
        (rule) => rule.optionId === userAnswer
      );
    } else if (question.type === "multiple" && Array.isArray(userAnswer)) {
      matchedRule = question.logicRules.find((rule) =>
        userAnswer.includes(rule.optionId)
      );
    }

    // 3. å¦‚æœåŒ¹é…åˆ°"ç»“æŸé—®å·"è§„åˆ™ï¼Œæ˜¾ç¤ºæäº¤æŒ‰é’®
    if (matchedRule && matchedRule.isEnd) {
      return true;
    }
  }

  return false;
});
```

```vue
<el-button type="primary" @click="nextQuestion">
  {{ shouldShowSubmit ? 'æäº¤é—®å·' : 'ä¸‹ä¸€é¢˜' }}
  <el-icon v-if="!shouldShowSubmit"><ArrowRight /></el-icon>
  <el-icon v-else><Check /></el-icon>
</el-button>
```

---

## å…³é”®ä»£ç è§£æ

### 1. è§’è‰²åˆ¤æ–­ä¸æ ·å¼åˆ‡æ¢

```vue
<div class="custom-create" :class="{ 'admin-mode': isAdmin }">
```

```scss
.custom-create {
  min-height: 100vh;
  background: var(--theme-background-color);
  padding: 30px 285px;

  &.admin-mode {
    background: transparent;
    padding: 30px 155px;
  }
}
```

### 2. é—®å·æ•°æ®æ„å»º

```javascript
const buildQuestionnaireData = (status = "draft") => {
  const userId = userStore.profile?.id || 1;
  const userName =
    userStore.profile?.nickname || userStore.profile?.username || "åŒ¿åç”¨æˆ·";

  // æ ¼å¼åŒ–é—®é¢˜åˆ—è¡¨ï¼ˆæ·»åŠ  order å­—æ®µï¼‰
  const formattedQuestions = questions.value.map((q, index) => ({
    ...q,
    order: index + 1,
  }));

  const baseData = {
    title: questionnaireForm.title,
    description: questionnaireForm.description,
    category: questionnaireForm.category,
    duration: questionnaireForm.duration,
    tags: questionnaireForm.tags,
    questions: formattedQuestions.length, // é—®é¢˜æ•°é‡
    questionList: formattedQuestions, // é—®é¢˜è¯¦æƒ…åˆ—è¡¨
    settings: { ...settingsForm },
    status: status, // draft | pending | published
    updatedAt: new Date().toISOString(),
  };

  // ç¼–è¾‘æ¨¡å¼ï¼šä¿ç•™åŸå§‹æ•°æ®çš„æŸäº›å­—æ®µ
  if (isEditMode.value && originalQuestionnaireData.value) {
    return {
      ...originalQuestionnaireData.value,
      ...baseData,
      id: currentQuestionnaireId.value,
      createdAt: originalQuestionnaireData.value.createdAt,
      participants: originalQuestionnaireData.value.participants || 0,
    };
  }

  // æ–°å»ºæ¨¡å¼
  return {
    ...baseData,
    id: Date.now(),
    createdAt: new Date().toISOString(),
    userId: userId,
    authorId: userId,
    authorName: userName,
    author: userName,
    participants: 0,
  };
};
```

### 3. å‘å¸ƒé€»è¾‘ï¼ˆåŒºåˆ†ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·ï¼‰

```javascript
const publishQuestionnaire = async () => {
  if (!validateForm()) return;

  // æ ¹æ®ç®¡ç†å‘˜è§’è‰²å†³å®šçŠ¶æ€
  const statusToSet = isAdmin.value ? "published" : "pending";

  const questionnaireData = buildQuestionnaireData(statusToSet);

  if (isEditMode.value && currentQuestionnaireId.value) {
    // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰é—®å·
    if (isAdmin.value) {
      // ç®¡ç†å‘˜ç›´æ¥æ›´æ–°
      await apiClient.put(
        `/surveys/${currentQuestionnaireId.value}`,
        questionnaireData
      );

      // è®°å½•ç®¡ç†å‘˜æ“ä½œ
      await recordAdminActivity({
        adminId: userStore.profile.id,
        adminName: userStore.profile.nickname,
        title: "ç¼–è¾‘é—®å·",
        description: `ç¼–è¾‘äº†é—®å·"${questionnaireData.title}"`,
        type: "questionnaire_edit",
      });
    } else {
      // æ™®é€šç”¨æˆ·æäº¤å®¡æ ¸
      await updateQuestionnaire(
        currentQuestionnaireId.value,
        questionnaireData
      );
    }
  } else {
    // åˆ›å»ºæ¨¡å¼ï¼šåˆ›å»ºæ–°é—®å·
    if (isAdmin.value) {
      await apiClient.post("/surveys", questionnaireData);

      await recordAdminActivity({
        adminId: userStore.profile.id,
        adminName: userStore.profile.nickname,
        title: "åˆ›å»ºé—®å·",
        description: `åˆ›å»ºäº†æ–°é—®å·"${questionnaireData.title}"`,
        type: "questionnaire_create",
      });
    } else {
      const result = await createQuestionnaire(questionnaireData);

      // æ˜¾ç¤ºç§¯åˆ†å¥–åŠ±
      if (result.pointsEarned) {
        userStore.profile.points += result.pointsEarned;
        ElMessage.success(`é—®å·å·²æäº¤å®¡æ ¸ï¼è·å¾— ${result.pointsEarned} ç§¯åˆ†`);
      }
    }
  }

  // æ ¹æ®è§’è‰²è·³è½¬
  if (isAdmin.value) {
    router.push("/admin/questionnaires/list");
  } else {
    router.push("/profile/questionnaires/created");
  }
};
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ `isEnd` å­—æ®µï¼Ÿ

**A**: å¦‚æœåªç”¨ `targetQuestion` æ¥è¡¨ç¤ºè·³è½¬ï¼Œæ— æ³•åŒºåˆ†"ç»“æŸé—®å·"å’Œ"è·³è½¬åˆ°æŸé¢˜"ä¸¤ç§æƒ…å†µã€‚

**é”™è¯¯åšæ³•**ï¼š

```javascript
// âŒ ç”¨ç‰¹æ®Šå€¼ï¼ˆå¦‚ -1 æˆ– 0ï¼‰è¡¨ç¤ºç»“æŸ
{
  targetQuestion: -1;
} // å®¹æ˜“æ··æ·†ï¼Œä¸ç›´è§‚
```

**æ­£ç¡®åšæ³•**ï¼š

```javascript
// âœ… ä½¿ç”¨æ˜ç¡®çš„å¸ƒå°”æ ‡å¿—
{ isEnd: true, targetQuestion: null }
```

### Q2: ä¸ºä»€ä¹ˆåªéªŒè¯é¢„æœŸè·¯å¾„ä¸Šçš„å¿…ç­”é¢˜ï¼Ÿ

**A**: å› ä¸ºè·³è½¬é€»è¾‘å¯èƒ½ä¼šè·³è¿‡æŸäº›é¢˜ç›®ï¼Œå¦‚æœéªŒè¯æ‰€æœ‰å¿…ç­”é¢˜ä¼šå¯¼è‡´ç”¨æˆ·æ— æ³•æäº¤ã€‚

**ç¤ºä¾‹**ï¼š

```
ç¬¬1é¢˜ï¼ˆå¿…ç­”ï¼‰ï¼šæ»¡æ„åº¦è°ƒæŸ¥
  - æ»¡æ„ â†’ ç»“æŸé—®å·
  - ä¸æ»¡æ„ â†’ è·³è½¬ç¬¬3é¢˜

ç¬¬2é¢˜ï¼ˆå¿…ç­”ï¼‰ï¼šæ”¹è¿›å»ºè®®

ç¬¬3é¢˜ï¼ˆå¿…ç­”ï¼‰ï¼šè”ç³»æ–¹å¼
```

å¦‚æœç”¨æˆ·é€‰æ‹©"æ»¡æ„"ï¼Œåªéœ€è¦å›ç­”ç¬¬ 1 é¢˜å³å¯ã€‚å¦‚æœéªŒè¯æ‰€æœ‰å¿…ç­”é¢˜ï¼Œä¼šè¦æ±‚ç”¨æˆ·å›ç­”ç¬¬ 2 é¢˜å’Œç¬¬ 3 é¢˜ï¼ˆä½†è¿™äº›é¢˜ç›®å·²ç»è¢«è·³è¿‡äº†ï¼‰ã€‚

### Q3: ä¸ºä»€ä¹ˆæŒ‰é’®æ–‡æœ¬éœ€è¦åŠ¨æ€è®¡ç®—ï¼Ÿ

**A**: å› ä¸ºç”¨æˆ·å¯èƒ½åœ¨éæœ€åä¸€é¢˜æ—¶é€‰æ‹©äº†"ç»“æŸé—®å·"é€‰é¡¹ã€‚

**ç¤ºä¾‹**ï¼š

```
æ€»å…±5é“é¢˜ï¼Œç”¨æˆ·åœ¨ç¬¬2é¢˜é€‰æ‹©äº†"ç»“æŸé—®å·"é€‰é¡¹
- åŸæ¥çš„å®ç°ï¼šæŒ‰é’®æ˜¾ç¤º"ä¸‹ä¸€é¢˜"ï¼ˆé”™è¯¯ï¼‰
- ä¿®å¤åï¼šæŒ‰é’®æ˜¾ç¤º"æäº¤é—®å·"ï¼ˆæ­£ç¡®ï¼‰
```

### Q4: è·³è½¬é€»è¾‘ä¼šä¸ä¼šé€ æˆå¾ªç¯ï¼Ÿ

**A**: `computeExpectedPath` æ–¹æ³•ä½¿ç”¨ `seen` Set æ¥é˜²æ­¢å¾ªç¯è·³è½¬ã€‚

```javascript
const seen = new Set();

while (idx >= 0 && idx < orderedQuestions.length) {
  const q = orderedQuestions[idx];

  // âœ… é˜²æ­¢é‡å¤è®¿é—®ï¼ˆå¾ªç¯æ£€æµ‹ï¼‰
  if (!q || seen.has(String(q.id))) break;

  path.push(String(q.id));
  seen.add(String(q.id));

  // ... è·³è½¬é€»è¾‘
}
```

### Q5: ä¸ºä»€ä¹ˆä¸èƒ½è·³è½¬åˆ°å‰é¢çš„é¢˜ç›®ï¼Ÿ

**A**: å…è®¸å‘åè·³è½¬ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. ç”¨æˆ·å¯èƒ½é™·å…¥æ— é™å¾ªç¯
2. è¿›åº¦ç™¾åˆ†æ¯”æ— æ³•æ­£ç¡®è®¡ç®—
3. å·²å›ç­”çš„é¢˜ç›®å¯èƒ½éœ€è¦é‡æ–°å›ç­”

**ç•Œé¢é™åˆ¶**ï¼š

```vue
<el-option
  v-for="(q, qIdx) in questions"
  :key="qIdx"
  :value="qIdx + 1"
  :disabled="qIdx <= index"  <!-- ç¦ç”¨å½“å‰é¢˜åŠä¹‹å‰çš„é¢˜ç›® -->
/>
```

### Q6: å¤šé€‰é¢˜å¦‚ä½•åŒ¹é…è·³è½¬è§„åˆ™ï¼Ÿ

**A**: åªè¦ç”¨æˆ·é€‰ä¸­çš„ç­”æ¡ˆä¸­**åŒ…å«**è§„åˆ™ä¸­çš„é€‰é¡¹ ID å³å¯è§¦å‘ã€‚

```javascript
if (question.type === "multiple" && Array.isArray(userAnswer)) {
  // userAnswer: ['opt1', 'opt2', 'opt3']
  // åªè¦åŒ…å« rule.optionIdï¼Œå°±åŒ¹é…æˆåŠŸ
  matchedRule = question.logicRules.find((rule) =>
    userAnswer.includes(rule.optionId)
  );
}
```

**ç¤ºä¾‹**ï¼š

```
å¤šé€‰é¢˜ï¼šæ‚¨å¸Œæœ›æ”¹è¿›å“ªäº›æ–¹é¢ï¼Ÿ
  - A. ç•Œé¢è®¾è®¡
  - B. åŠŸèƒ½å®Œå–„
  - C. æ€§èƒ½ä¼˜åŒ–

è·³è½¬è§„åˆ™ï¼š
  - å¦‚æœé€‰æ‹©äº† Bï¼ˆåŠŸèƒ½å®Œå–„ï¼‰â†’ è·³è½¬åˆ°åŠŸèƒ½è¯¦ç»†è°ƒæŸ¥
```

ç”¨æˆ·é€‰æ‹© [A, B, C] æ—¶ï¼Œä»ç„¶ä¼šè§¦å‘è·³è½¬åˆ°åŠŸèƒ½è¯¦ç»†è°ƒæŸ¥ã€‚

---

## æœ€ä½³å®è·µå»ºè®®

### 1. é—®å·è®¾è®¡

âœ… **æ¨èåšæ³•**ï¼š

- é—®å·é€»è¾‘æ¸…æ™°ï¼Œé¿å…å¤æ‚çš„è·³è½¬è·¯å¾„
- ä½¿ç”¨"ç»“æŸé—®å·"åŠŸèƒ½ç¼©çŸ­ä¸ç›¸å…³ç”¨æˆ·çš„ç­”é¢˜æ—¶é—´
- ä¸ºè·³è½¬é€»è¾‘æ·»åŠ æ˜ç¡®çš„æç¤ºè¯´æ˜

âŒ **ä¸æ¨èåšæ³•**ï¼š

- è¿‡å¤šçš„è·³è½¬è§„åˆ™ï¼ˆå®¹æ˜“æ··ä¹±ï¼‰
- è·³è½¬åˆ°å¾ˆè¿œçš„é¢˜ç›®ï¼ˆç”¨æˆ·ä½“éªŒä¸å¥½ï¼‰
- åœ¨å¿…ç­”é¢˜ä¸Šè®¾ç½®"ç»“æŸé—®å·"å´ä¸å‘ŠçŸ¥ç”¨æˆ·

### 2. æ•°æ®éªŒè¯

```javascript
// âœ… éªŒè¯å‰æ£€æŸ¥è·³è½¬é€»è¾‘
const validation = validateRequiredQuestions(questionnaire.questions);

// âœ… æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
if (!validation.isValid) {
  ElMessage.warning(
    `è¿˜æœ‰ ${validation.unansweredRequired.length} é“å¿…ç­”é¢˜æœªå®Œæˆ`
  );
}
```

### 3. ç”¨æˆ·æç¤º

```vue
<!-- âœ… åœ¨å¯ç”¨è·³è½¬é€»è¾‘æ—¶æ˜¾ç¤ºè¯´æ˜ -->
<el-alert v-if="question.enableLogic" title="è·³è½¬é€»è¾‘é…ç½®è¯´æ˜" type="warning">
  <p>å½“å‰é¢˜ç›®å¯ç”¨äº†è·³è½¬é€»è¾‘ï¼Œè¯·æ³¨æ„ï¼š</p>
  <ul>
    <li>å¦‚æœç”¨æˆ·çš„ç­”æ¡ˆåŒ¹é…æŸä¸ªè·³è½¬è§„åˆ™ï¼Œå°†æŒ‰ç…§è§„åˆ™è·³è½¬æˆ–ç»“æŸ</li>
    <li>å¯ä»¥é€‰æ‹©"ç»“æŸé—®å·"æ¥åœ¨æŸä¸ªé€‰é¡¹åç›´æ¥å®Œæˆé—®å·</li>
  </ul>
</el-alert>
```

### 4. æ€§èƒ½ä¼˜åŒ–

```javascript
// âœ… ä½¿ç”¨è®¡ç®—å±æ€§ç¼“å­˜ç»“æœ
const expectedPath = computed(() => computeExpectedPath());

// âœ… ä½¿ç”¨ Set è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾
const pathIds = new Set(expectedPath.value);

// âœ… é˜²æ­¢ä¸å¿…è¦çš„é‡æ–°è®¡ç®—
watch(currentQuestion, (q) => {
  if (q && q.id !== undefined) {
    visitedQuestions.value.add(String(q.id));
  }
});
```

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹é¢„æœŸè·¯å¾„

```javascript
console.log("é¢„æœŸè·¯å¾„:", expectedPath.value);
console.log("å½“å‰é¢˜ç›®ç´¢å¼•:", currentQuestionIndex.value);
console.log("å·²æäº¤ç­”æ¡ˆ:", committedAnswers.value);
```

### 2. éªŒè¯è·³è½¬é€»è¾‘

```javascript
const question = currentQuestion.value;
console.log("å½“å‰é¢˜ç›®:", question.title);
console.log("å¯ç”¨è·³è½¬:", question.enableLogic);
console.log("è·³è½¬è§„åˆ™:", question.logicRules);
console.log("ç”¨æˆ·ç­”æ¡ˆ:", answers.value[question.id]);
```

### 3. æ£€æŸ¥éªŒè¯ç»“æœ

```javascript
const validation = validateRequiredQuestions(questions.value);
console.log("éªŒè¯é€šè¿‡:", validation.isValid);
console.log("æœªç­”å¿…ç­”é¢˜:", validation.unansweredRequired);
```

---

## ç‰ˆæœ¬å†å²

### v2.0.0 (2025-11-16)

- âœ… ä¿®å¤è·³è½¬é€»è¾‘ bugï¼šæ”¯æŒ"ç»“æŸé—®å·"é€‰é¡¹
- âœ… ä¿®å¤å¿…ç­”é¢˜éªŒè¯ï¼šåªéªŒè¯é¢„æœŸè·¯å¾„ä¸Šçš„é¢˜ç›®
- âœ… ä¿®å¤æŒ‰é’®æ–‡æœ¬ï¼šåŠ¨æ€æ˜¾ç¤º"æäº¤é—®å·"æˆ–"ä¸‹ä¸€é¢˜"
- âœ… ä¼˜åŒ–ä»£ç ç»“æ„ï¼šå°†é€»è¾‘åˆ†ç¦»åˆ° composables

### v1.0.0

- åˆå§‹ç‰ˆæœ¬
- æ”¯æŒåŸºæœ¬çš„é—®å·åˆ›å»ºå’Œè·³è½¬é€»è¾‘

---

## è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**æ–‡æ¡£æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 16 æ—¥

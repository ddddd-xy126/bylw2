# 积分系统实现总结

## 已完成功能

### 1. 用户封禁检查

**位置**: `src/api/auth.js` - `loginApi`

- ✅ 用户登录时检查封禁状态
- ✅ 显示错误信息："您的账号已被封禁，如有异议请联系管理员"

### 2. 个人资料字段修改

**位置**: `src/views/frontend/user/components/profile/InfoPage.vue`

- ✅ 添加城市(city)字段
- ✅ 将生日(birthday)字段替换为年龄(age)字段

### 3. 积分系统架构

**核心位置**: `src/store/user.js`

#### 3.1 积分配置常量 (POINTS_CONFIG)

```javascript
export const POINTS_CONFIG = {
  FIRST_LOGIN: 5, // 首次登录
  DAILY_LOGIN: 5, // 每日登录
  CONTINUOUS_LOGIN_3: 5, // 连续登录3天
  CONTINUOUS_LOGIN_7: 10, // 连续登录7天
  CONTINUOUS_LOGIN_30: 50, // 连续登录30天
  COMPLETE_SURVEY: 10, // 完成问卷
  FIRST_SURVEY: 20, // 首次完成问卷额外奖励
  CREATE_SURVEY: 50, // 创建问卷
  PUBLISH_SURVEY: 30, // 发布问卷(提交审核)
  SURVEY_APPROVED: 20, // 问卷审核通过
  ADD_FAVORITE: 3, // 收藏问卷
  ADD_COMMENT: 5, // 发表评论
  SHARE_SURVEY: 5, // 分享问卷
  COMPLETE_PROFILE: 15, // 完善资料
};
```

#### 3.2 用户数据字段扩展

在用户注册时添加以下字段 (`src/api/auth.js`):

- `points`: 100 (注册赠送 100 积分)
- `level`: 1 (初始等级)
- `loginCount`: 0 (登录次数)
- `continuousLoginDays`: 0 (连续登录天数)
- `lastLoginAt`: null (最后登录时间)
- `unlockedBadges`: [] (已解锁徽章)
- `completedSurveys`: [] (已完成问卷 ID 列表)
- `tags`: [] (用户标签)

#### 3.3 Pinia Store Actions

**addPoints(amount, reason, showMessage)**

- 更新用户积分
- 计算等级: `level = Math.floor(points / 500) + 1`
- 持久化到数据库
- 可选显示提示消息

**checkDailyLogin()**

- 检查并奖励每日登录积分(非首次登录)
- 跳过首次登录用户(loginCount <= 0)
- 计算连续登录天数
- 奖励连续登录奖金(3 天/7 天/30 天)
- 更新最后登录时间和登录次数

**handlePostLogin()**

- 处理登录后逻辑
- 检测首次登录(loginCount = 0)
- 首次登录奖励 FIRST_LOGIN 积分(5 分)并设置 loginCount = 1
- 返回是否为首次登录的标志

### 4. 积分获取途径实现

#### 4.0 注册奖励 (100 积分)

**位置**: `src/api/auth.js` - `registerApi`
**后端位置**: `server/controllers/authController.js` - `register`

- ✅ 新用户注册时自动获得 100 积分
- ✅ 在后端注册逻辑中设置初始积分
- ✅ 创建 PointHistory 记录

#### 4.1 首次登录 (5 积分)

**位置**: `src/store/user.js` - `handlePostLogin`
**调用位置**: `src/views/frontend/auth/LoginPage.vue`

- ✅ 首次登录(loginCount=0)奖励 5 积分
- ✅ 设置 loginCount 为 1
- ✅ 显示首次登录奖励提示

#### 4.2 每日登录 (5 积分 + 连续登录奖励)

**位置**: `src/store/user.js` - `checkDailyLogin`
**调用位置**: `src/views/frontend/home/HomePage.vue`

- ✅ 在首页加载时自动检查(onMounted)
- ✅ 跳过首次登录用户(loginCount <= 0)
- ✅ 基础奖励: 5 积分
- ✅ 连续 3 天: +5 积分
- ✅ 连续 7 天: +10 积分
- ✅ 连续 30 天: +50 积分
- ✅ 增加登录次数计数器

#### 4.3 完成问卷 (10 积分 + 首次 20 积分)

**API 位置**: `src/api/survey.js` - `submitSurveyApi`
**前端位置**: `src/views/frontend/survey/AnswerPage.vue`

- ✅ 基础奖励: 10 积分
- ✅ 首次完成额外奖励: 20 积分
- ✅ 将问卷 ID 添加到用户的 `completedSurveys` 列表
- ✅ 显示获得积分的提示消息

#### 4.4 创建问卷 (50 积分)

**API 位置**:

- `src/api/questionnaire.js` - `createQuestionnaire`
- `src/api/survey.js` - `createSurveyApi`

**前端位置**: `src/views/frontend/questionnaire/CustomCreatePage.vue`

- ✅ 创建问卷后奖励 50 积分
- ✅ 更新本地用户积分状态
- ✅ 显示获得积分的提示消息

#### 4.5 发布问卷/提交审核 (30 积分)

**API 位置**: `src/api/survey.js` - `publishSurveyApi`
**前端位置**:

- `src/views/frontend/user/components/questionnaires/CreatedPage.vue`
- `src/views/frontend/questionnaire/CustomCreatePage.vue`
- ✅ 提交问卷审核时奖励 30 积分
- ✅ 更新本地用户积分状态
- ✅ 显示获得积分的提示消息

#### 4.6 问卷审核通过 (20 积分)

**API 位置**: `src/api/survey.js` - `approveSurveyApi`
**前端位置**: `src/views/backend/admin/components/questionnaires/PendingQuestionnairesPage.vue`

- ✅ 管理员审核通过时,问卷作者获得 20 积分
- ✅ 管理员看到提示信息:"审核通过，问卷已发布（作者获得 20 积分）"

#### 4.7 收藏问卷 (3 积分)

**API 位置**: `src/api/user.js` - `addFavoriteApi`

- ✅ 收藏问卷时奖励 3 积分
- ✅ 返回 `pointsEarned: 3`

#### 4.8 发表评论 (5 积分)

**API 位置**: `src/api/survey.js` - `createCommentApi`
**前端位置**: `src/views/frontend/survey/ResultPage.vue`

- ✅ 发表评论时奖励 5 积分
- ✅ 更新本地用户积分状态
- ✅ 显示获得积分的提示消息: "评论发表成功！获得 5 积分"

#### 4.9 分享问卷 (5 积分)

**位置**: `src/views/frontend/user/components/questionnaires/CreatedPage.vue`

- ✅ 复制问卷链接时奖励 5 积分
- ✅ 更新本地用户积分状态
- ✅ 显示提示消息: "问卷链接已复制到剪贴板！获得 5 积分"

#### 4.10 完善资料 (15 积分)

**位置**: `src/views/frontend/user/components/profile/InfoPage.vue`

- ✅ 检查资料完整度(用户名、邮箱、手机、性别、年龄、城市、职业、简介、标签)
- ✅ 首次完善所有字段时奖励 15 积分
- ✅ 显示提示消息: "个人信息更新成功！资料完整度达到 100%，获得 15 积分"

## 积分与等级系统

### 等级计算公式

```javascript
level = Math.floor(points / 500) + 1;
```

**等级对照表**:

- 1 级: 0-499 积分
- 2 级: 500-999 积分
- 3 级: 1000-1499 积分
- 4 级: 1500-1999 积分
- 5 级: 2000-2499 积分
- ...以此类推

## 技术实现要点

### 1. 三层架构

- **API 层**: 在 API 函数中更新数据库积分
- **Pinia 层**: 提供全局状态管理和辅助方法
- **UI 层**: 显示积分获得提示,更新本地状态

### 2. 积分更新流程

```
用户操作 → API调用 → 更新数据库积分 → 返回 pointsEarned
  → 更新 Pinia Store → 更新本地用户对象 → 显示提示消息
```

### 3. 数据持久化

- 使用 `apiClient.patch('/users/{id}', { points })` 更新数据库
- 通过 `userStore.setProfile(updatedProfile)` 更新本地状态
- 确保刷新页面后积分不丢失

### 4. 用户体验优化

- 所有积分奖励都有明确的提示消息
- 提示消息格式统一: "操作成功！获得 X 积分"
- 特殊情况显示额外信息(如首次完成问卷、连续登录天数)

## 已修改文件清单

1. `src/api/auth.js` - 注册 100 积分初始化、封禁检查、用户字段扩展
2. `src/store/user.js` - 积分系统核心逻辑、首次登录与每日登录分离
3. `src/api/survey.js` - 问卷相关积分奖励
4. `src/api/questionnaire.js` - 问卷创建积分
5. `src/api/user.js` - 收藏积分
6. `src/views/frontend/auth/LoginPage.vue` - 首次登录检查(handlePostLogin)
7. `src/views/frontend/home/HomePage.vue` - 每日登录检查(onMounted)
8. `src/views/frontend/survey/AnswerPage.vue` - 完成问卷积分显示
9. `src/views/frontend/survey/ResultPage.vue` - 评论积分显示
10. `src/views/frontend/questionnaire/CustomCreatePage.vue` - 创建/发布积分显示
11. `src/views/frontend/user/components/questionnaires/CreatedPage.vue` - 发布/分享积分
12. `src/views/frontend/user/components/profile/InfoPage.vue` - 资料完善积分
13. `src/views/backend/admin/components/questionnaires/PendingQuestionnairesPage.vue` - 审核通过积分
14. `server/models/User.js` - 添加 loginCount 字段
15. `server/scripts/add-loginCount-column.js` - 数据库迁移脚本
16. `server/controllers/authController.js` - 注册奖励 100 积分实现

## 测试建议

### 测试场景

1. ✅ 新用户注册,初始积分为 100
2. ✅ 首次登录获得 5 积分(总计 105)
3. ✅ 第二天及以后每日登录获得 5 积分
4. ✅ 连续登录 3 天、7 天、30 天获得额外积分
5. ✅ 完成第一份问卷获得 30 积分(10+20)
6. ✅ 完成后续问卷获得 10 积分
7. ✅ 创建问卷获得 50 积分
8. ✅ 提交审核获得 30 积分
9. ✅ 审核通过获得 20 积分
10. ✅ 收藏问卷获得 3 积分
11. ✅ 发表评论获得 5 积分
12. ✅ 分享问卷获得 5 积分
13. ✅ 完善资料获得 15 积分
14. ✅ 积分达到 500 时升至 2 级

### 数据验证

- 检查 `db.json` 中用户的 `points` 字段是否正确更新
- 检查 `level` 字段是否按公式计算
- 检查 `completedSurveys` 数组是否正确记录
- 检查 `continuousLoginDays` 和 `lastLoginAt` 是否正确更新

## 未来扩展建议

1. **积分商城**: 使用积分兑换虚拟物品或特权
2. **排行榜**: 展示积分/等级排名
3. **成就系统**: 基于积分和行为解锁成就
4. **积分历史**: 记录每次积分变动的详细日志
5. **积分惩罚**: 违规行为扣除积分
6. **VIP 会员**: 高等级用户解锁特殊功能
7. **每日任务**: 完成特定任务获得额外积分
8. **积分过期**: 长时间不活跃减少积分

## 注意事项

1. 所有积分奖励都已在 API 层实现,确保数据库持久化
2. 前端显示积分消息时同步更新本地用户状态
3. 避免重复奖励(如首次完成问卷通过 `completedSurveys` 检查)
4. 管理员操作不应获得积分(如创建问卷时检查 `isAdmin`)
5. 异常处理:积分更新失败不应影响主要功能

## 相关文档

- [积分机制说明.md](./积分机制说明.md) - 详细的积分规则说明
- [前后端分离说明.md](./前后端分离说明.md) - 项目架构说明

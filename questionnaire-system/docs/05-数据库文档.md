# 问卷系统 - 数据库文档

## 📋 概述

本文档详细描述问卷系统的 MySQL 数据库结构，包括所有数据表、字段说明、索引、外键关联关系等。

### 数据库信息

- **数据库名称**: questionnaire_db
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **时区**: UTC+8 (东八区)
- **ORM**: Sequelize 6.x
- **数据库引擎**: InnoDB

---

## 📊 数据表概览

系统共包含 12 个数据表：

| 表名            | 说明             | 主要用途                         |
| --------------- | ---------------- | -------------------------------- |
| users           | 用户表           | 存储用户基本信息、积分、等级等   |
| surveys         | 问卷表           | 存储问卷信息、题目、设置等       |
| answers         | 答案表           | 存储用户答题记录                 |
| comments        | 评论表           | 存储问卷评论                     |
| favorites       | 收藏表           | 存储用户收藏的问卷               |
| categories      | 分类表           | 问卷分类                         |
| badges          | 徽章表           | 成就徽章定义                     |
| PointHistories  | 积分历史表       | 用户积分变动记录                 |
| AdminActivities | 管理员活动日志表 | 管理员操作记录                   |
| Announcements   | 公告表           | 系统公告                         |
| RecycleBins     | 回收站表         | 已删除的数据（支持软删除和恢复） |
| Reports         | 报告表           | AI 生成的个人报告                |

---

## 📝 数据表详细说明

### 1. users (用户表)

存储系统所有用户的基本信息和统计数据。

**表结构**

| 字段名              | 类型                  | 约束             | 默认值            | 说明                 |
| ------------------- | --------------------- | ---------------- | ----------------- | -------------------- |
| id                  | VARCHAR(50)           | PK               | -                 | 用户 ID              |
| username            | VARCHAR(50)           | NOT NULL, UNIQUE | -                 | 用户名               |
| password            | VARCHAR(255)          | NOT NULL         | -                 | 密码 (bcrypt 加密)   |
| email               | VARCHAR(100)          | UNIQUE           | NULL              | 邮箱                 |
| nickname            | VARCHAR(50)           | -                | NULL              | 昵称                 |
| avatar              | VARCHAR(255)          | -                | NULL              | 头像 URL             |
| phone               | VARCHAR(20)           | -                | NULL              | 手机号               |
| role                | ENUM('user', 'admin') | -                | 'user'            | 角色                 |
| banned              | BOOLEAN               | -                | false             | 是否被封禁           |
| isActive            | BOOLEAN               | -                | true              | 账号是否激活         |
| points              | INT                   | -                | 0                 | 积分                 |
| level               | INT                   | -                | 1                 | 等级                 |
| gender              | VARCHAR(20)           | -                | NULL              | 性别                 |
| age                 | INT                   | -                | NULL              | 年龄                 |
| city                | VARCHAR(50)           | -                | NULL              | 城市                 |
| bio                 | TEXT                  | -                | NULL              | 个人简介             |
| profession          | VARCHAR(100)          | -                | NULL              | 职业                 |
| joinedDate          | DATE                  | -                | NULL              | 加入日期             |
| lastLoginAt         | DATETIME              | -                | NULL              | 最后登录时间         |
| lastLoginIp         | VARCHAR(50)           | -                | NULL              | 最后登录 IP          |
| tags                | JSON                  | -                | NULL              | 用户标签             |
| completedSurveys    | JSON                  | -                | NULL              | 已完成的问卷 ID 列表 |
| continuousLoginDays | INT                   | -                | 0                 | 连续登录天数         |
| loginCount          | INT                   | -                | 0                 | 登录次数             |
| unlockedBadges      | JSON                  | -                | NULL              | 已解锁的徽章 ID 列表 |
| createdAt           | DATETIME              | -                | CURRENT_TIMESTAMP | 创建时间             |
| updatedAt           | DATETIME              | -                | CURRENT_TIMESTAMP | 更新时间             |

**索引**

- PRIMARY KEY: `id`
- UNIQUE KEY: `username`
- UNIQUE KEY: `email`
- INDEX: `role`
- INDEX: `createdAt`

**示例数据**

```json
{
  "id": "user_1701234567890",
  "username": "testuser",
  "password": "$2b$10$abcdefg...",
  "email": "test@example.com",
  "nickname": "测试用户",
  "avatar": "https://example.com/avatar.jpg",
  "role": "user",
  "points": 150,
  "level": 2,
  "gender": "male",
  "age": 25,
  "city": "北京",
  "bio": "这是我的个人简介",
  "profession": "工程师",
  "tags": ["技术", "阅读"],
  "completedSurveys": ["survey_1", "survey_2"],
  "unlockedBadges": ["badge_1", "badge_2"],
  "loginCount": 10,
  "continuousLoginDays": 5
}
```

---

### 2. surveys (问卷表)

存储所有问卷的信息、题目列表、设置等。

**表结构**

| 字段名           | 类型         | 约束         | 默认值            | 说明                                           |
| ---------------- | ------------ | ------------ | ----------------- | ---------------------------------------------- |
| id               | VARCHAR(50)  | PK           | -                 | 问卷 ID                                        |
| userId           | VARCHAR(50)  | NOT NULL, FK | -                 | 创建者 ID (关联 users.id)                      |
| title            | VARCHAR(200) | NOT NULL     | -                 | 问卷标题                                       |
| description      | TEXT         | -            | NULL              | 问卷描述                                       |
| category         | VARCHAR(100) | -            | NULL              | 分类名称                                       |
| categoryId       | VARCHAR(50)  | FK           | NULL              | 分类 ID (关联 categories.id)                   |
| tags             | JSON         | -            | NULL              | 标签                                           |
| questions        | INT          | -            | 0                 | 问题数量                                       |
| questionList     | JSON         | NOT NULL     | -                 | 题目列表                                       |
| settings         | JSON         | -            | NULL              | 问卷设置                                       |
| status           | ENUM         | -            | 'draft'           | 状态: draft/pending/published/stopped/rejected |
| isTemplate       | BOOLEAN      | -            | false             | 是否为模板                                     |
| participants     | INT          | -            | 0                 | 参与者数量                                     |
| participantCount | INT          | -            | 0                 | 参与人数 (别名)                                |
| responses        | INT          | -            | 0                 | 回复数量                                       |
| responseCount    | INT          | -            | 0                 | 回复数量 (别名)                                |
| rating           | DECIMAL(3,2) | -            | 0.00              | 评分                                           |
| averageRating    | DECIMAL(3,2) | -            | 0.00              | 平均评分                                       |
| ratingCount      | INT          | -            | 0                 | 评分人数                                       |
| favoriteCount    | INT          | -            | 0                 | 收藏数                                         |
| duration         | INT          | -            | NULL              | 预估时长 (秒)                                  |
| estimatedTime    | INT          | -            | NULL              | 预估时间 (分钟)                                |
| thumbnail        | VARCHAR(500) | -            | NULL              | 缩略图                                         |
| answerCount      | INT          | -            | 0                 | 答案数量                                       |
| publishedAt      | DATETIME     | -            | NULL              | 发布时间                                       |
| createdAt        | DATETIME     | -            | CURRENT_TIMESTAMP | 创建时间                                       |
| updatedAt        | DATETIME     | -            | CURRENT_TIMESTAMP | 更新时间                                       |

**索引**

- PRIMARY KEY: `id`
- INDEX: `userId`
- INDEX: `categoryId`
- INDEX: `status`
- INDEX: `createdAt`
- INDEX: `publishedAt`

**questionList JSON 结构**

```json
[
  {
    "id": "q1",
    "type": "choice",
    "title": "您的性别是？",
    "options": ["男", "女", "其他"],
    "required": true,
    "score": 0,
    "jumpLogic": {
      "男": 1,
      "女": 1,
      "其他": 2
    }
  },
  {
    "id": "q2",
    "type": "text",
    "title": "您的建议",
    "required": false
  }
]
```

**settings JSON 结构**

```json
{
  "allowAnonymous": true,
  "showProgress": true,
  "randomOrder": false,
  "allowMultipleSubmissions": false,
  "requireLogin": true
}
```

---

### 3. answers (答案表)

存储用户提交的问卷答案。

**表结构**

| 字段名      | 类型         | 约束         | 默认值            | 说明                      |
| ----------- | ------------ | ------------ | ----------------- | ------------------------- |
| id          | VARCHAR(50)  | PK           | -                 | 答案 ID                   |
| userId      | VARCHAR(50)  | NOT NULL, FK | -                 | 用户 ID (关联 users.id)   |
| surveyId    | VARCHAR(50)  | NOT NULL, FK | -                 | 问卷 ID (关联 surveys.id) |
| surveyTitle | VARCHAR(200) | -            | NULL              | 问卷标题 (冗余)           |
| answers     | JSON         | NOT NULL     | -                 | 答案列表                  |
| score       | INT          | -            | NULL              | 得分                      |
| result      | VARCHAR(100) | -            | NULL              | 结果                      |
| duration    | INT          | -            | NULL              | 答题时长 (秒)             |
| submittedAt | DATETIME     | -            | CURRENT_TIMESTAMP | 提交时间                  |

**索引**

- PRIMARY KEY: `id`
- INDEX: `userId`
- INDEX: `surveyId`
- UNIQUE INDEX: `userId_surveyId` (防止重复提交)
- INDEX: `submittedAt`

**answers JSON 结构**

```json
[
  {
    "questionId": "q1",
    "question": "您的性别是？",
    "answer": "男",
    "text": "男"
  },
  {
    "questionId": "q2",
    "question": "您的建议",
    "answer": "建议内容",
    "text": "建议内容"
  }
]
```

**注意**: `timestamps: false`，没有 `createdAt` 和 `updatedAt` 字段

---

### 4. comments (评论表)

存储用户对问卷的评论和评分。

**表结构**

| 字段名    | 类型        | 约束         | 默认值            | 说明                      |
| --------- | ----------- | ------------ | ----------------- | ------------------------- |
| id        | VARCHAR(50) | PK           | -                 | 评论 ID                   |
| userId    | VARCHAR(50) | NOT NULL, FK | -                 | 用户 ID (关联 users.id)   |
| surveyId  | VARCHAR(50) | NOT NULL, FK | -                 | 问卷 ID (关联 surveys.id) |
| content   | TEXT        | NOT NULL     | -                 | 评论内容                  |
| rating    | INT         | -            | NULL              | 评分 (1-5)                |
| createdAt | DATETIME    | -            | CURRENT_TIMESTAMP | 创建时间                  |
| updatedAt | DATETIME    | -            | CURRENT_TIMESTAMP | 更新时间                  |

**索引**

- PRIMARY KEY: `id`
- INDEX: `userId`
- INDEX: `surveyId`
- INDEX: `createdAt`

---

### 5. favorites (收藏表)

存储用户收藏的问卷。

**表结构**

| 字段名    | 类型        | 约束         | 默认值            | 说明                      |
| --------- | ----------- | ------------ | ----------------- | ------------------------- |
| id        | VARCHAR(50) | PK           | -                 | 收藏 ID                   |
| userId    | VARCHAR(50) | NOT NULL, FK | -                 | 用户 ID (关联 users.id)   |
| surveyId  | VARCHAR(50) | NOT NULL, FK | -                 | 问卷 ID (关联 surveys.id) |
| createdAt | DATETIME    | -            | CURRENT_TIMESTAMP | 收藏时间                  |
| updatedAt | DATETIME    | -            | CURRENT_TIMESTAMP | 更新时间                  |

**索引**

- PRIMARY KEY: `id`
- INDEX: `userId`
- INDEX: `surveyId`
- UNIQUE INDEX: `userId_surveyId` (防止重复收藏)

---

### 6. categories (分类表)

问卷分类。

**表结构**

| 字段名       | 类型         | 约束             | 默认值            | 说明     |
| ------------ | ------------ | ---------------- | ----------------- | -------- |
| id           | VARCHAR(50)  | PK               | -                 | 分类 ID  |
| name         | VARCHAR(100) | NOT NULL, UNIQUE | -                 | 分类名称 |
| slug         | VARCHAR(100) | NOT NULL, UNIQUE | -                 | URL slug |
| description  | TEXT         | -                | NULL              | 分类描述 |
| displayOrder | INT          | -                | 0                 | 显示顺序 |
| createdAt    | DATETIME     | -                | CURRENT_TIMESTAMP | 创建时间 |
| updatedAt    | DATETIME     | -                | CURRENT_TIMESTAMP | 更新时间 |

**索引**

- PRIMARY KEY: `id`
- UNIQUE KEY: `name`
- UNIQUE KEY: `slug`

**字段说明**

- `displayOrder`: 用于控制分类在前端显示的顺序，数值越小越靠前

**示例数据**

```json
{
  "id": "cat_academic",
  "name": "学术调研",
  "slug": "academic",
  "description": "学术研究相关问卷",
  "displayOrder": 1
}
```

**历史变更**

- 2025-12-06: 删除了 `color` 和 `icon` 字段（未在前端使用）
- 2025-12-06: 删除了 `surveyCount` 字段（可通过关联查询获取）

---

### 7. badges (徽章表)

成就徽章定义。

**表结构**

| 字段名      | 类型         | 约束     | 默认值            | 说明                        |
| ----------- | ------------ | -------- | ----------------- | --------------------------- |
| id          | VARCHAR(50)  | PK       | -                 | 徽章 ID                     |
| name        | VARCHAR(100) | NOT NULL | -                 | 徽章名称                    |
| description | TEXT         | -        | NULL              | 徽章描述                    |
| icon        | VARCHAR(255) | -        | NULL              | 图标 URL                    |
| requirement | INT          | -        | 0                 | 解锁条件 (数值)             |
| type        | VARCHAR(50)  | -        | NULL              | 类型 (如: survey_completed) |
| createdAt   | DATETIME     | -        | CURRENT_TIMESTAMP | 创建时间                    |
| updatedAt   | DATETIME     | -        | CURRENT_TIMESTAMP | 更新时间                    |

**索引**

- PRIMARY KEY: `id`
- INDEX: `type`

**示例数据**

```json
{
  "id": "badge_newbie",
  "name": "新手上路",
  "description": "完成第一个问卷",
  "icon": "🎖️",
  "requirement": 1,
  "type": "survey_completed"
}
```

---

### 9. PointHistories (积分历史表)

用户积分变动记录。

**表结构**

| 字段名      | 类型         | 约束         | 默认值            | 说明                              |
| ----------- | ------------ | ------------ | ----------------- | --------------------------------- |
| id          | VARCHAR(50)  | PK           | -                 | 记录 ID                           |
| userId      | VARCHAR(50)  | NOT NULL, FK | -                 | 用户 ID (关联 users.id)           |
| points      | INT          | NOT NULL     | -                 | 积分变动 (正数为增加，负数为减少) |
| action      | VARCHAR(100) | NOT NULL     | -                 | 操作类型                          |
| description | TEXT         | -            | NULL              | 描述                              |
| createdAt   | DATETIME     | -            | CURRENT_TIMESTAMP | 创建时间                          |
| updatedAt   | DATETIME     | -            | CURRENT_TIMESTAMP | 更新时间                          |

**索引**

- PRIMARY KEY: `id`
- INDEX: `userId`
- INDEX: `createdAt`

**示例数据**

```json
{
  "id": "point_123",
  "userId": "user_456",
  "points": 10,
  "action": "完成问卷",
  "description": "完成问卷《用户体验调研》",
  "createdAt": "2024-01-01T10:00:00.000Z"
}
```

---

### 11. AdminActivities (管理员活动日志表)

管理员操作记录。前端在管理员 Dashboard 和用户管理等页面中使用。

**表结构**

| 字段名      | 类型         | 约束         | 默认值            | 说明                      |
| ----------- | ------------ | ------------ | ----------------- | ------------------------- |
| id          | VARCHAR(50)  | PK           | -                 | 日志 ID                   |
| adminId     | VARCHAR(50)  | NOT NULL, FK | -                 | 管理员 ID (关联 users.id) |
| adminName   | VARCHAR(50)  | -            | NULL              | 管理员名称                |
| title       | VARCHAR(200) | -            | NULL              | 操作标题                  |
| description | TEXT         | -            | NULL              | 操作描述                  |
| type        | VARCHAR(50)  | -            | NULL              | 操作类型                  |
| createdAt   | DATETIME     | -            | CURRENT_TIMESTAMP | 创建时间                  |

**索引**

- PRIMARY KEY: `id`
- INDEX: `adminId`
- INDEX: `type`
- INDEX: `createdAt`

**使用场景**

- 管理员 Dashboard 展示最近操作记录
- 用户管理页面记录封禁/解封等操作
- 问卷审核页面记录审核操作

---

### 12. Announcements (公告表)

系统公告，管理员可发布全局通知。

**表结构**

| 字段名      | 类型         | 约束               | 默认值            | 说明                             |
| ----------- | ------------ | ------------------ | ----------------- | -------------------------------- |
| id          | INTEGER      | PK, AUTO_INCREMENT | -                 | 公告 ID                          |
| title       | VARCHAR(200) | NOT NULL           | -                 | 公告标题                         |
| content     | TEXT         | NOT NULL           | -                 | 公告内容                         |
| type        | ENUM         | -                  | 'info'            | 类型: info/warning/success/error |
| status      | ENUM         | -                  | 'draft'           | 状态: draft/published            |
| isActive    | BOOLEAN      | -                  | true              | 是否激活                         |
| priority    | INT          | -                  | 0                 | 优先级                           |
| publishedAt | DATETIME     | -                  | NULL              | 发布时间                         |
| createdBy   | VARCHAR(50)  | -                  | NULL              | 创建者 ID                        |
| createdAt   | DATETIME     | -                  | CURRENT_TIMESTAMP | 创建时间                         |
| updatedAt   | DATETIME     | -                  | CURRENT_TIMESTAMP | 更新时间                         |

**索引**

- PRIMARY KEY: `id`
- INDEX: `type`
- INDEX: `status`
- INDEX: `priority`
- INDEX: `createdAt`

---

### 13. RecycleBins (回收站表)

已删除的数据，支持软删除和恢复功能。前端有完整的回收站页面(TrashPage.vue)。

**表结构**

| 字段名         | 类型         | 约束     | 默认值 | 说明                      |
| -------------- | ------------ | -------- | ------ | ------------------------- |
| id             | VARCHAR(50)  | PK       | -      | 回收站记录 ID (原问卷 ID) |
| surveyId       | VARCHAR(50)  | -        | NULL   | 原问卷 ID                 |
| title          | VARCHAR(500) | -        | NULL   | 问卷标题                  |
| description    | TEXT         | -        | NULL   | 问卷描述                  |
| category       | VARCHAR(100) | -        | NULL   | 问卷分类                  |
| originalStatus | VARCHAR(50)  | -        | NULL   | 删除前的状态              |
| questions      | INT          | -        | NULL   | 题目数量                  |
| userId         | VARCHAR(50)  | -        | NULL   | 用户 ID                   |
| authorId       | VARCHAR(50)  | -        | NULL   | 作者 ID                   |
| surveyData     | JSON         | -        | NULL   | 完整的问卷数据(用于恢复)  |
| deletedBy      | VARCHAR(50)  | -        | NULL   | 删除操作者 ID             |
| deletedAt      | DATETIME     | NOT NULL | NOW    | 删除时间                  |

**索引**

- PRIMARY KEY: `id`
- INDEX: `userId`
- INDEX: `deletedAt`

**使用场景**

- 用户删除问卷后自动移入回收站
- 支持从回收站恢复问卷
- 支持从回收站永久删除
- 超过 30 天自动清理

---

### 14. Reports (报告表)

AI 生成的个人分析报告。

**表结构**

| 字段名      | 类型         | 约束         | 默认值            | 说明                              |
| ----------- | ------------ | ------------ | ----------------- | --------------------------------- |
| id          | VARCHAR(50)  | PK           | -                 | 报告 ID                           |
| userId      | VARCHAR(50)  | NOT NULL, FK | -                 | 用户 ID (关联 users.id)           |
| surveyId    | VARCHAR(50)  | FK           | NULL              | 问卷 ID (关联 surveys.id)         |
| answerId    | VARCHAR(50)  | FK           | NULL              | 答案 ID (关联 answers.id)         |
| title       | VARCHAR(200) | NOT NULL     | -                 | 报告标题                          |
| surveyTitle | VARCHAR(200) | -            | NULL              | 问卷标题 (冗余)                   |
| category    | VARCHAR(100) | -            | NULL              | 分类                              |
| content     | TEXT('long') | -            | NULL              | 报告内容 (Markdown)               |
| status      | ENUM         | -            | 'generating'      | 状态: generating/completed/failed |
| generatedAt | DATETIME     | -            | NULL              | 生成完成时间                      |
| createdAt   | DATETIME     | -            | CURRENT_TIMESTAMP | 创建时间                          |
| updatedAt   | DATETIME     | -            | CURRENT_TIMESTAMP | 更新时间                          |

**索引**

- PRIMARY KEY: `id`
- INDEX: `userId`
- INDEX: `surveyId`
- INDEX: `status`
- INDEX: `createdAt`

**字段说明**

- `answerId`: 关联用户提交的具体答案记录，用于生成个性化报告
- `content`: 使用 LONGTEXT 类型以支持较长的 AI 生成报告内容

---

## 🔗 关联关系

### ER 图

```
┌─────────────┐         ┌─────────────┐
│    users    │1      n│   surveys   │
│             ├────────→│             │
│  - id       │  userId │  - id       │
│  - username │         │  - title    │
│  - role     │         │  - status   │
└─────────────┘         └─────────────┘
       │                       │
       │1                      │1
       │                       │
       ↓n                      ↓n
┌─────────────┐         ┌─────────────┐
│   answers   │         │  comments   │
│             │         │             │
│  - id       │         │  - id       │
│  - userId   │         │  - userId   │
│  - surveyId │         │  - surveyId │
└─────────────┘         └─────────────┘

┌─────────────┐
│    users    │
│             │1
│  - id       ├────────→ favorites (n)
│             │
└─────────────┘
       │
       │1
       ├────────→ UserBadges (n) ←──── badges (1)
       │
       ├────────→ PointHistories (n)
       │
       └────────→ Reports (n)
```

### 外键关系

1. **surveys.userId → users.id**

   - 一个用户可以创建多个问卷
   - 级联操作: ON DELETE CASCADE

2. **surveys.categoryId → categories.id**

   - 一个分类包含多个问卷
   - 级联操作: ON DELETE SET NULL

3. **answers.userId → users.id**

   - 一个用户可以提交多个答案
   - 级联操作: ON DELETE CASCADE

4. **answers.surveyId → surveys.id**

   - 一个问卷可以有多个答案
   - 级联操作: ON DELETE CASCADE

5. **comments.userId → users.id**

   - 一个用户可以发表多条评论
   - 级联操作: ON DELETE CASCADE

6. **comments.surveyId → surveys.id**

   - 一个问卷可以有多条评论
   - 级联操作: ON DELETE CASCADE

7. **favorites.userId → users.id**

   - 一个用户可以收藏多个问卷
   - 级联操作: ON DELETE CASCADE

8. **favorites.surveyId → surveys.id**

   - 一个问卷可以被多个用户收藏
   - 级联操作: ON DELETE CASCADE

9. **PointHistories.userId → users.id**

   - 一个用户有多条积分记录
   - 级联操作: ON DELETE CASCADE

10. **Reports.userId → users.id**

    - 一个用户可以有多个报告
    - 级联操作: ON DELETE CASCADE

11. **Reports.surveyId → surveys.id**

    - 一个问卷可以生成多个报告
    - 级联操作: ON DELETE CASCADE

12. **AdminActivities.adminId → users.id**
    - 一个管理员有多条操作记录
    - 级联操作: ON DELETE CASCADE

---

## 📌 数据库设计原则

### 1. 规范化

- 遵循第三范式 (3NF)
- 减少数据冗余
- 部分冗余字段用于性能优化 (如 `surveyTitle`)

### 2. 索引策略

- 主键自动索引
- 外键字段添加索引
- 常用查询字段添加索引
- 联合索引用于复合查询

### 3. 数据类型

- ID: VARCHAR(50) (支持自定义 ID 格式)
- 时间: DATETIME (自动管理 createdAt/updatedAt)
- JSON: 存储复杂结构 (questionList, answers, tags 等)
- ENUM: 限定值范围 (status, role 等)

### 4. 字符集

- 使用 utf8mb4 支持 emoji 和特殊字符
- 排序规则 utf8mb4_unicode_ci (不区分大小写)

---

## 🔒 数据安全

### 1. 密码加密

- 使用 bcrypt 加密存储
- 密码字段长度 VARCHAR(255)
- 密码在模型 hook 中自动加密

### 2. 敏感字段

- 用户密码不返回到前端
- 使用 `toSafeObject()` 方法过滤

### 3. 软删除

- 使用 RecycleBins 表实现软删除
- 保留删除数据 30 天

---

## 🚀 初始化脚本

### 创建数据库

```sql
CREATE DATABASE IF NOT EXISTS questionnaire_db
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE questionnaire_db;
```

### Sequelize 自动同步

```javascript
// server.js
sequelize
  .sync({ alter: true })
  .then(() => {
    console.log("✅ 数据库表同步成功");
  })
  .catch((err) => {
    console.error("❌ 数据库同步失败:", err);
  });
```

**注意**:

- `sync({ alter: true })` 会自动调整表结构
- 生产环境建议使用 Migration

---

## 📊 数据备份与恢复

### 备份

```bash
# 备份整个数据库
mysqldump -u root -p questionnaire_db > backup.sql

# 备份特定表
mysqldump -u root -p questionnaire_db users surveys answers > backup_main.sql
```

### 恢复

```bash
# 恢复数据库
mysql -u root -p questionnaire_db < backup.sql
```

---

## 🔍 查询优化建议

### 1. 使用索引

```sql
-- 查询时使用索引字段
SELECT * FROM surveys WHERE status = 'published';
SELECT * FROM users WHERE username = 'test';
```

### 2. 避免全表扫描

```sql
-- 避免 SELECT *
SELECT id, title, category FROM surveys;

-- 使用 LIMIT 限制结果
SELECT * FROM answers LIMIT 10;
```

### 3. 使用连接查询

```sql
-- 使用 JOIN 代替多次查询
SELECT s.*, u.username, u.nickname
FROM surveys s
JOIN users u ON s.userId = u.id
WHERE s.status = 'published';
```

### 4. JSON 字段查询

```sql
-- 查询 JSON 字段
SELECT * FROM surveys WHERE JSON_CONTAINS(tags, '"技术"');
SELECT * FROM users WHERE JSON_EXTRACT(tags, '$[0]') = '阅读';
```

---

## 📈 数据统计查询示例

### 用户统计

```sql
-- 用户总数
SELECT COUNT(*) FROM users;

-- 今日新增用户
SELECT COUNT(*) FROM users
WHERE DATE(createdAt) = CURDATE();

-- 活跃用户 (最近7天登录)
SELECT COUNT(*) FROM users
WHERE lastLoginAt >= DATE_SUB(NOW(), INTERVAL 7 DAY);
```

### 问卷统计

```sql
-- 问卷总数 (按状态分组)
SELECT status, COUNT(*) as count
FROM surveys
GROUP BY status;

-- 最热门的问卷 (按参与人数)
SELECT id, title, participants
FROM surveys
WHERE status = 'published'
ORDER BY participants DESC
LIMIT 10;

-- 平均问卷评分
SELECT AVG(rating) as avg_rating
FROM surveys
WHERE ratingCount > 0;
```

### 答题统计

```sql
-- 答题总数
SELECT COUNT(*) FROM answers;

-- 今日答题数
SELECT COUNT(*) FROM answers
WHERE DATE(submittedAt) = CURDATE();

-- 问卷完成率
SELECT
  s.id,
  s.title,
  s.participants,
  COUNT(a.id) as answers,
  (COUNT(a.id) / s.participants * 100) as completion_rate
FROM surveys s
LEFT JOIN answers a ON s.id = a.surveyId
GROUP BY s.id;
```

---

## 🛠️ 维护建议

### 1. 定期清理

- 清理过期的 RecycleBin 数据 (超过 30 天)
- 清理无效的 Token 记录

### 2. 索引优化

- 定期分析慢查询
- 根据查询模式调整索引

### 3. 数据归档

- 定期归档历史数据
- 保持主表数据量在合理范围

### 4. 性能监控

- 监控数据库连接数
- 监控查询执行时间
- 监控磁盘空间

---

## 📝 注意事项

1. **ID 生成**: 使用 `generateId()` 函数生成唯一 ID，格式如 `user_1701234567890`
2. **时区**: 数据库时区设置为 UTC+8
3. **JSON 字段**: 使用 Sequelize 的 JSON 类型，MySQL 5.7.8+ 支持
4. **级联删除**: 删除用户时会自动删除关联的问卷、答案等
5. **事务**: 关键操作使用事务保证数据一致性

---

## 📋 数据库变更历史

### 2025-12-06

**删除未使用字段**

- ✅ 删除 `categories.color` 字段（后端有读写但前端未使用）
- ✅ 删除 `categories.icon` 字段（后端有读写但前端未使用）
- ✅ 更新相关代码：
  - 模型文件：`server/models/Category.js`
  - 控制器：`server/controllers/categoryController.js`
  - 控制器：`server/controllers/surveyController.js`
- ✅ 迁移脚本：`server/migrations/remove-category-color-icon.sql`

**字段保留说明**

- ✅ 保留 `reports.answerId` 字段（正在使用中，用于关联答案记录）

---

**文档版本**: v1.1  
**最后更新**: 2025 年 12 月 6 日

# 评论管理

## 功能描述

评论管理功能允许用户在完成问卷填写后发表评论和评分,对问卷进行反馈。用户可以查看问卷的所有评论列表,发布新评论,以及删除自己发表的评论。评论支持文字内容和星级评分,评分会自动计算并更新问卷的平均评分。系统通过权限验证确保用户只能删除自己的评论,管理员拥有删除任意评论的权限。

主要功能点:
- **查看评论**: 分页展示问卷的所有评论,按时间倒序排列
- **发表评论**: 用户填写完问卷后可发表评论和评分(1-5星)
- **删除评论**: 用户可删除自己的评论,管理员可删除任意评论
- **评分更新**: 发表评分时自动更新问卷的平均评分和评分人数

## 代码逻辑

### 1. 查看评论列表

前端调用 `getSurveyCommentsApi(id)` 获取指定问卷的评论列表:
1. 发送 GET 请求到 `/comments/survey/${id}`
2. 后端查询 Comment 表,关联 User 表获取评论者信息
3. 支持分页参数 (page, limit),默认每页10条
4. 按创建时间倒序排序,最新评论在前
5. 前端处理返回数据,展平 user 对象为平面结构

### 2. 发表评论

前端调用 `createCommentApi(id, data)` 发表新评论:
1. 用户提交评论内容和评分 (content, rating)
2. 后端开启数据库事务确保数据一致性
3. 验证问卷是否存在
4. 创建评论记录,生成唯一ID (`cmt_${Date.now()}`)
5. 如果包含评分,更新问卷的平均评分和评分人数
6. 事务提交后重新查询评论(包含用户关联信息)返回

**评分计算公式**:
- 新平均评分 = (原平均评分 × 原评分人数 + 新评分) / (原评分人数 + 1)
- 保留2位小数

### 3. 删除评论

前端调用 `deleteCommentApi(surveyId, userId, commentId)` 删除评论:
1. 发送 DELETE 请求到 `/comments/${commentId}`
2. 后端查询评论是否存在
3. 权限验证:评论作者或管理员才能删除
4. 执行真删除操作 (comment.destroy())

## 时序图描述

### 发表评论流程

```
用户 → 前端Vue组件: 填写评论内容和评分,点击"发表评论"
前端Vue组件 → API层(survey.js): createCommentApi(surveyId, {content, rating})
API层(survey.js) → 后端路由(/comments/survey/:id): POST请求,携带content和rating
后端路由 → commentController.createComment: 调用创建评论方法
commentController.createComment → 数据库: 开启事务
commentController.createComment → Survey表: 查询问卷是否存在
Survey表 → commentController.createComment: 返回问卷信息
commentController.createComment → Comment表: 创建评论记录(事务中)
commentController.createComment → Survey表: 更新平均评分和评分人数(事务中)
commentController.createComment → 数据库: 提交事务
commentController.createComment → Comment表: 重新查询评论(包含用户关联)
Comment表 → commentController.createComment: 返回完整评论数据
commentController.createComment → 后端路由: 返回创建结果
后端路由 → API层: 返回{success: true, data: comment}
API层 → 前端Vue组件: 返回新评论数据
前端Vue组件 → 用户: 显示发表成功提示,刷新评论列表
```

### 删除评论流程

```
用户 → 前端Vue组件: 点击评论的"删除"按钮
前端Vue组件 → API层(survey.js): deleteCommentApi(surveyId, userId, commentId)
API层(survey.js) → 后端路由(/comments/:id): DELETE请求
后端路由 → commentController.deleteComment: 调用删除评论方法
commentController.deleteComment → Comment表: 查询评论是否存在
Comment表 → commentController.deleteComment: 返回评论信息
commentController.deleteComment → commentController.deleteComment: 权限验证(作者或管理员)
commentController.deleteComment → Comment表: 执行destroy()真删除
commentController.deleteComment → 后端路由: 返回{success: true, message}
后端路由 → API层: 返回删除成功
API层 → 前端Vue组件: 返回成功标识
前端Vue组件 → 用户: 显示删除成功提示,刷新评论列表
```

## 接口定义

### 1. 获取问卷评论列表

**接口**: `GET /comments/survey/:surveyId`

**请求参数**:
- Path参数: `surveyId` (string) - 问卷ID
- Query参数: `page` (number, 可选) - 页码,默认1
- Query参数: `limit` (number, 可选) - 每页数量,默认10

**响应数据**:
```json
{
  "success": true,
  "data": {
    "comments": [
      {
        "id": "cmt_1701234567890",
        "userId": "user_123",
        "surveyId": "survey_456",
        "content": "问卷设计很好,问题清晰",
        "rating": 5,
        "createdAt": "2024-01-15T10:30:00.000Z",
        "user": {
          "id": "user_123",
          "username": "zhangsan",
          "nickname": "张三",
          "avatar": "avatar_url"
        }
      }
    ],
    "total": 25,
    "page": 1,
    "totalPages": 3
  }
}
```

### 2. 发表评论

**接口**: `POST /comments/survey/:surveyId`

**请求头**: `Authorization: Bearer <token>`

**请求参数**:
- Path参数: `surveyId` (string) - 问卷ID
- Body参数:
  - `content` (string, 必填) - 评论内容
  - `rating` (number, 可选) - 评分,1-5星

**请求示例**:
```json
{
  "content": "问卷设计很好,问题清晰",
  "rating": 5
}
```

**响应数据**:
```json
{
  "success": true,
  "message": "评论发表成功",
  "data": {
    "id": "cmt_1701234567890",
    "userId": "user_123",
    "surveyId": "survey_456",
    "content": "问卷设计很好,问题清晰",
    "rating": 5,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "user": {
      "id": "user_123",
      "username": "zhangsan",
      "nickname": "张三",
      "avatar": "avatar_url"
    }
  }
}
```

### 3. 删除评论

**接口**: `DELETE /comments/:id`

**请求头**: `Authorization: Bearer <token>`

**请求参数**:
- Path参数: `id` (string) - 评论ID

**权限**: 评论作者或管理员

**响应数据**:
```json
{
  "success": true,
  "message": "评论删除成功"
}
```

## 关键代码

### 后端 - 创建评论并更新评分 (commentController.js)

```javascript
exports.createComment = async (req, res, next) => {
  const t = await sequelize.transaction();

  try {
    const { surveyId } = req.params;
    const { content, rating } = req.body;

    // 检查问卷是否存在
    const survey = await Survey.findByPk(surveyId);
    if (!survey) {
      await t.rollback();
      return res.status(404).json({
        success: false,
        message: "问卷不存在",
      });
    }

    // 创建评论
    const comment = await Comment.create(
      {
        id: `cmt_${Date.now()}`,
        userId: req.user.id,
        surveyId,
        content,
        rating,
      },
      { transaction: t }
    );

    // 如果有评分,更新问卷的平均评分
    if (rating) {
      const totalRating =
        survey.averageRating * survey.ratingCount + parseFloat(rating);
      const newRatingCount = survey.ratingCount + 1;
      const newAverageRating = totalRating / newRatingCount;

      await survey.update(
        {
          averageRating: newAverageRating.toFixed(2),
          ratingCount: newRatingCount,
        },
        { transaction: t }
      );
    }

    await t.commit();

    // 重新查询以包含关联数据
    const newComment = await Comment.findByPk(comment.id, {
      include: [
        {
          model: User,
          as: "user",
          attributes: ["id", "username", "nickname", "avatar"],
        },
      ],
    });

    res.status(201).json({
      success: true,
      message: "评论发表成功",
      data: newComment,
    });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};
```

### 前端 - 发表评论API (survey.js)

```javascript
export async function createCommentApi(id, data) {
  try {
    // 使用后端API创建评论
    const response = await apiClient.post(`/comments/survey/${id}`, {
      content: data.content,
      rating: data.rating || 5,
    });

    // 后端返回 {success: true, message: '', data: comment}
    // axios拦截器已经解包了data字段
    return response;
  } catch (error) {
    console.error("创建评论失败:", error);
    throw error;
  }
}
```

### 前端 - 删除评论API (survey.js)

```javascript
export async function deleteCommentApi(surveyId, userId, commentId) {
  try {
    // 使用后端评论API删除
    if (!commentId) {
      throw new Error("评论ID不能为空");
    }

    await apiClient.delete(`/comments/${commentId}`);
    return { success: true };
  } catch (error) {
    console.error("删除评论失败:", error);
    throw error;
  }
}
```

### 后端 - 删除评论与权限验证 (commentController.js)

```javascript
exports.deleteComment = async (req, res, next) => {
  try {
    const { id } = req.params;

    const comment = await Comment.findByPk(id);

    if (!comment) {
      return res.status(404).json({
        success: false,
        message: "评论不存在",
      });
    }

    // 检查权限:评论作者或管理员
    if (comment.userId !== req.user.id && req.user.role !== "admin") {
      return res.status(403).json({
        success: false,
        message: "无权删除此评论",
      });
    }

    await comment.destroy();

    res.json({
      success: true,
      message: "评论删除成功",
    });
  } catch (error) {
    next(error);
  }
};
```

ç§¯åˆ†ä¸æˆå°±å¾½ç« ç³»ç»Ÿ
1ã€ç®€è¦æè¿°
ï¼ˆ1ï¼‰åŠŸèƒ½æè¿°ï¼šç§¯åˆ†ä¸æˆå°±å¾½ç« ç³»ç»Ÿæ˜¯é—®å·å¹³å°çš„æ¿€åŠ±æœºåˆ¶ï¼Œé€šè¿‡ç»™äºˆç”¨æˆ·ç§¯åˆ†å¥–åŠ±å’Œè§£é”æˆå°±å¾½ç« ï¼Œé¼“åŠ±ç”¨æˆ·ç§¯æå‚ä¸é—®å·å¡«å†™ã€åˆ›å»ºé—®å·ã€å®Œå–„èµ„æ–™ç­‰è¡Œä¸ºã€‚ç³»ç»ŸåŒ…å«ç§¯åˆ†è·å–ã€ç§¯åˆ†å†å²è®°å½•ã€ç­‰çº§è®¡ç®—ã€æˆå°±å¾½ç« è§£é”ç­‰åŠŸèƒ½æ¨¡å—ã€‚

ï¼ˆ2ï¼‰ä»£ç é€»è¾‘ï¼šç”¨æˆ·æ‰§è¡Œæ“ä½œï¼ˆå¦‚æ³¨å†Œã€å®Œæˆé—®å·ã€åˆ›å»ºé—®å·ï¼‰æ—¶ï¼Œåç«¯åœ¨æ•°æ®åº“äº‹åŠ¡ä¸­è°ƒç”¨ user.increment('points', {by: pointsEarned}) å¢åŠ ç”¨æˆ·ç§¯åˆ†ï¼ŒåŒæ—¶åˆ›å»º PointHistory è®°å½•ä¿å­˜ç§¯åˆ†æ•°é‡ã€åŸå› æè¿°ã€ç±»å‹(earn/spend)å’Œåˆ›å»ºæ—¶é—´ï¼Œæäº¤äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§ã€‚ç­‰çº§æ ¹æ®ç§¯åˆ†è‡ªåŠ¨è®¡ç®—ï¼šç­‰çº§ = Math.floor(ç§¯åˆ† / 500) + 1ã€‚æˆå°±å¾½ç« ç³»ç»Ÿé€šè¿‡æ£€æµ‹ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡æ•°æ®ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³å¾½ç« çš„ requirement è¦æ±‚ï¼Œè‹¥æ»¡è¶³ä¸”æœªè§£é”åˆ™åˆ›å»ºç”¨æˆ·å¾½ç« å…³è”è®°å½•ã€å¥–åŠ±å¯¹åº”ç§¯åˆ†ã€åˆ›å»ºç§¯åˆ†å†å²å¹¶æ˜¾ç¤ºè§£é”æç¤ºã€‚å‰ç«¯æŸ¥è¯¢ç§¯åˆ†å†å²æ—¶è°ƒç”¨ getPointHistory æ¥å£ï¼Œåç«¯æŒ‰ç”¨æˆ·IDç­›é€‰å¹¶åˆ†é¡µè¿”å›å†å²è®°å½•åˆ—è¡¨ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰ã€‚æˆå°±é¡µé¢å±•ç¤ºç§¯åˆ†æ€»æ•°ã€å·²å®Œæˆé—®å·æ•°ã€å·²è§£é”å¾½ç« æ•°ç­‰ç»Ÿè®¡å¡ç‰‡ï¼Œå¾½ç« åˆ—è¡¨æ”¯æŒç­›é€‰å·²è§£é”/æœªè§£é”ï¼Œæœªè§£é”å¾½ç« æ˜¾ç¤ºå½“å‰è¿›åº¦ï¼ˆå¦‚"5/10"ï¼‰ã€‚

æ—¶åºå›¾æè¿°
ç”¨æˆ· â†’ æ³¨å†Œé¡µé¢: å¡«å†™æ³¨å†Œä¿¡æ¯å¹¶æäº¤
æ³¨å†Œé¡µé¢ â†’ authController: POST /auth/register
authController â†’ MySQL: å¼€å¯äº‹åŠ¡ï¼Œåˆ›å»ºç”¨æˆ·(points: 100)
authController â†’ MySQL: åˆ›å»ºPointHistoryè®°å½•("æ³¨å†Œå¥–åŠ±", 100ç§¯åˆ†)
MySQL â†’ authController: è¿”å›ç”¨æˆ·æ•°æ®
authController â†’ æ³¨å†Œé¡µé¢: è¿”å›{token, user}
æ³¨å†Œé¡µé¢ â†’ ç”¨æˆ·: æ˜¾ç¤º"æ³¨å†ŒæˆåŠŸ,è·å¾—100ç§¯åˆ†"

ç”¨æˆ· â†’ ç­”é¢˜é¡µé¢: å®Œæˆé—®å·å¹¶æäº¤
ç­”é¢˜é¡µé¢ â†’ answerController: POST /answers
answerController â†’ MySQL: å¼€å¯äº‹åŠ¡ï¼Œåˆ›å»ºç­”æ¡ˆè®°å½•
answerController â†’ MySQL: incrementå¢åŠ ç§¯åˆ†(points + 10)
answerController â†’ MySQL: åˆ›å»ºPointHistoryè®°å½•("å®Œæˆé—®å·ã€Šxxxã€‹", 10ç§¯åˆ†)
answerController â†’ MySQL: æäº¤äº‹åŠ¡
answerController â†’ ç­”é¢˜é¡µé¢: è¿”å›{pointsEarned: 10}
ç­”é¢˜é¡µé¢ â†’ ç”¨æˆ·: æ˜¾ç¤º"é—®å·æäº¤æˆåŠŸ!è·å¾—10ç§¯åˆ†"

ç”¨æˆ· â†’ ä¸ªäººæˆå°±é¡µé¢: è®¿é—®ä¸ªäººæˆå°±é¡µé¢
ä¸ªäººæˆå°±é¡µé¢ â†’ userController: GET /users/:id/point-history
userController â†’ MySQL: æŸ¥è¯¢PointHistoryè¡¨(where userId, order DESC)
MySQL â†’ userController: è¿”å›å†å²è®°å½•åˆ—è¡¨
userController â†’ ä¸ªäººæˆå°±é¡µé¢: è¿”å›{history, total, page}
ä¸ªäººæˆå°±é¡µé¢ â†’ ç”¨æˆ·: æ¸²æŸ“æ—¶é—´è½´å±•ç¤ºç§¯åˆ†å˜åŠ¨

***æ—¶åºå›¾æè¿°***
ç”¨æˆ· â†’ å‰ç«¯ç•Œé¢: è§¦å‘ç§¯åˆ†ç›¸å…³æ“ä½œ
å‰ç«¯ç•Œé¢ â†’ åç«¯API: è°ƒç”¨å¯¹åº”æ¥å£
åç«¯API â†’ MySQL: åœ¨äº‹åŠ¡ä¸­æ›´æ–°ç§¯åˆ†å’Œåˆ›å»ºå†å²è®°å½•
MySQL â†’ åç«¯API: è¿”å›æ“ä½œç»“æœ
åç«¯API â†’ å‰ç«¯ç•Œé¢: è¿”å›ç§¯åˆ†æ•°æ®
å‰ç«¯ç•Œé¢ â†’ ç”¨æˆ·: æ˜¾ç¤ºç§¯åˆ†æç¤ºå’Œç»Ÿè®¡ä¿¡æ¯
***end***

## æ—¶åºå›¾æè¿°

### ç”¨æˆ·æ³¨å†Œè·å¾—ç§¯åˆ†

```
ç”¨æˆ· â†’ æ³¨å†Œé¡µé¢: å¡«å†™æ³¨å†Œä¿¡æ¯å¹¶æäº¤
æ³¨å†Œé¡µé¢ â†’ APIå±‚(auth.js): registerApi({username, email, password})
APIå±‚ â†’ åç«¯è·¯ç”±: POST /auth/register
åç«¯è·¯ç”± â†’ authController.register: è°ƒç”¨æ³¨å†Œæ–¹æ³•
authController.register â†’ Userè¡¨: æŸ¥è¯¢ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
Userè¡¨ â†’ authController.register: è¿”å›æŸ¥è¯¢ç»“æœ
authController.register â†’ Userè¡¨: createåˆ›å»ºç”¨æˆ·(points: 100)
authController.register â†’ PointHistoryè¡¨: createè®°å½•("æ³¨å†Œå¥–åŠ±", 100ç§¯åˆ†)
authController.register â†’ authController.register: ç”ŸæˆJWT token
authController.register â†’ åç«¯è·¯ç”±: è¿”å›{token, user}
åç«¯è·¯ç”± â†’ APIå±‚: è¿”å›æ³¨å†Œç»“æœ
APIå±‚ â†’ æ³¨å†Œé¡µé¢: è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œtoken
æ³¨å†Œé¡µé¢ â†’ ç”¨æˆ·: æ˜¾ç¤º"æ³¨å†ŒæˆåŠŸ,è·å¾—100ç§¯åˆ†"æç¤º
æ³¨å†Œé¡µé¢ â†’ Pinia store: ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œtoken
æ³¨å†Œé¡µé¢ â†’ é¦–é¡µ: è·³è½¬åˆ°é¦–é¡µ
```

### å®Œæˆé—®å·è·å¾—ç§¯åˆ†

```
ç”¨æˆ· â†’ ç­”é¢˜é¡µé¢: å®Œæˆé—®å·å¹¶ç‚¹å‡»"æäº¤"
ç­”é¢˜é¡µé¢ â†’ APIå±‚(survey.js): submitSurveyApi(id, answers)
APIå±‚ â†’ åç«¯è·¯ç”±: POST /answers
åç«¯è·¯ç”± â†’ answerController.submitAnswer: è°ƒç”¨æäº¤ç­”æ¡ˆæ–¹æ³•
answerController.submitAnswer â†’ æ•°æ®åº“: å¼€å¯äº‹åŠ¡
answerController.submitAnswer â†’ Surveyè¡¨: æŸ¥è¯¢é—®å·æ˜¯å¦å­˜åœ¨
answerController.submitAnswer â†’ Answerè¡¨: createåˆ›å»ºç­”æ¡ˆè®°å½•
answerController.submitAnswer â†’ Surveyè¡¨: incrementå¢åŠ participantCount
answerController.submitAnswer â†’ Userè¡¨: incrementå¢åŠ ç§¯åˆ†(points + 10)
answerController.submitAnswer â†’ PointHistoryè¡¨: createè®°å½•("å®Œæˆé—®å·ã€Šxxxã€‹", 10ç§¯åˆ†)
answerController.submitAnswer â†’ æ•°æ®åº“: æäº¤äº‹åŠ¡
answerController.submitAnswer â†’ åç«¯è·¯ç”±: è¿”å›{answer, pointsEarned: 10}
åç«¯è·¯ç”± â†’ APIå±‚: è¿”å›æäº¤ç»“æœ
APIå±‚ â†’ ç­”é¢˜é¡µé¢: è¿”å›{pointsEarned: 10}
ç­”é¢˜é¡µé¢ â†’ Pinia store: æ›´æ–°ç”¨æˆ·ç§¯åˆ†(points + 10)
ç­”é¢˜é¡µé¢ â†’ ç”¨æˆ·: æ˜¾ç¤º"é—®å·æäº¤æˆåŠŸ!è·å¾—10ç§¯åˆ†"æç¤º
```

### è§£é”æˆå°±å¾½ç« è·å¾—å¥–åŠ±

```
ç”¨æˆ· â†’ ç³»ç»Ÿ: å®Œæˆç¬¬10ä»½é—®å·
ç³»ç»Ÿ â†’ å¾½ç« æ£€æµ‹æœåŠ¡: æ£€æµ‹ç”¨æˆ·ç»Ÿè®¡æ•°æ®
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ Answerè¡¨: æŸ¥è¯¢ç”¨æˆ·ç­”é¢˜æ•°é‡
Answerè¡¨ â†’ å¾½ç« æ£€æµ‹æœåŠ¡: è¿”å›count = 10
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ Badgeè¡¨: æŸ¥è¯¢"å®Œæˆ10ä»½é—®å·"å¾½ç« 
Badgeè¡¨ â†’ å¾½ç« æ£€æµ‹æœåŠ¡: è¿”å›å¾½ç« (requirement: 10, points: 20)
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ å¾½ç« æ£€æµ‹æœåŠ¡: åˆ¤æ–­10 >= 10,æ»¡è¶³è§£é”æ¡ä»¶
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ UserBadgeè¡¨: æ£€æŸ¥æ˜¯å¦å·²è§£é”
UserBadgeè¡¨ â†’ å¾½ç« æ£€æµ‹æœåŠ¡: è¿”å›æœªè§£é”
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ æ•°æ®åº“: å¼€å¯äº‹åŠ¡
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ UserBadgeè¡¨: createåˆ›å»ºç”¨æˆ·å¾½ç« å…³è”
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ Userè¡¨: incrementå¢åŠ ç§¯åˆ†(points + 20)
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ PointHistoryè¡¨: createè®°å½•("è§£é”å¾½ç« 'é—®å·è¾¾äºº'", 20ç§¯åˆ†)
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ æ•°æ®åº“: æäº¤äº‹åŠ¡
å¾½ç« æ£€æµ‹æœåŠ¡ â†’ å‰ç«¯: å‘é€å¾½ç« è§£é”äº‹ä»¶
å‰ç«¯ â†’ ç”¨æˆ·: æ˜¾ç¤ºå¾½ç« è§£é”åŠ¨ç”»å’Œ"æ­å–œè§£é”'é—®å·è¾¾äºº'å¾½ç« !è·å¾—20ç§¯åˆ†"æç¤º
```

### æŸ¥çœ‹ç§¯åˆ†å†å²

```
ç”¨æˆ· â†’ ä¸ªäººæˆå°±é¡µé¢: è®¿é—®ä¸ªäººæˆå°±é¡µé¢
ä¸ªäººæˆå°±é¡µé¢ â†’ APIå±‚(user.js): getPointHistoryApi(userId)
APIå±‚ â†’ åç«¯è·¯ç”±: GET /users/:id/point-history
åç«¯è·¯ç”± â†’ userController.getPointHistory: è°ƒç”¨è·å–ç§¯åˆ†å†å²æ–¹æ³•
userController.getPointHistory â†’ PointHistoryè¡¨: findAndCountAll(where: {userId}, order: DESC)
PointHistoryè¡¨ â†’ userController.getPointHistory: è¿”å›å†å²è®°å½•åˆ—è¡¨
userController.getPointHistory â†’ åç«¯è·¯ç”±: è¿”å›{history, total, page, totalPages}
åç«¯è·¯ç”± â†’ APIå±‚: è¿”å›ç§¯åˆ†å†å²æ•°æ®
APIå±‚ â†’ ä¸ªäººæˆå°±é¡µé¢: è¿”å›å†å²è®°å½•åˆ—è¡¨
ä¸ªäººæˆå°±é¡µé¢ â†’ ä¸ªäººæˆå°±é¡µé¢: æ¸²æŸ“æ—¶é—´è½´å±•ç¤ºç§¯åˆ†å˜åŠ¨
ä¸ªäººæˆå°±é¡µé¢ â†’ ç”¨æˆ·: æ˜¾ç¤ºç§¯åˆ†å†å²åˆ—è¡¨(æ—¶é—´ã€ç§¯åˆ†ã€åŸå› )
```

### æŸ¥çœ‹æˆå°±å¾½ç« 

```
ç”¨æˆ· â†’ ä¸ªäººæˆå°±é¡µé¢: è®¿é—®æˆå°±å¾½ç« é¡µé¢
ä¸ªäººæˆå°±é¡µé¢ â†’ APIå±‚(badges.js): getBadgesApi()
APIå±‚ â†’ åç«¯è·¯ç”±: GET /badges
åç«¯è·¯ç”± â†’ Badgeè¡¨: findAll()æŸ¥è¯¢æ‰€æœ‰å¾½ç« å®šä¹‰
Badgeè¡¨ â†’ åç«¯è·¯ç”±: è¿”å›æ‰€æœ‰å¾½ç« åˆ—è¡¨
åç«¯è·¯ç”± â†’ APIå±‚: è¿”å›å¾½ç« æ•°æ®
APIå±‚ â†’ ä¸ªäººæˆå°±é¡µé¢: è¿”å›å¾½ç« åˆ—è¡¨allBadges
ä¸ªäººæˆå°±é¡µé¢ â†’ APIå±‚(user.js): getUserBadgesApi(userId)
APIå±‚ â†’ åç«¯è·¯ç”±: GET /users/:id/badges
åç«¯è·¯ç”± â†’ UserBadgeè¡¨: findAll(where: {userId})
UserBadgeè¡¨ â†’ åç«¯è·¯ç”±: è¿”å›ç”¨æˆ·å·²è§£é”å¾½ç« IDåˆ—è¡¨
åç«¯è·¯ç”± â†’ APIå±‚: è¿”å›userUnlockedBadgeIds
APIå±‚ â†’ ä¸ªäººæˆå°±é¡µé¢: è¿”å›å·²è§£é”å¾½ç« åˆ—è¡¨
ä¸ªäººæˆå°±é¡µé¢ â†’ ä¸ªäººæˆå°±é¡µé¢: è®¡ç®—å·²è§£é”å’Œæœªè§£é”å¾½ç« 
ä¸ªäººæˆå°±é¡µé¢ â†’ ä¸ªäººæˆå°±é¡µé¢: æ ¹æ®badgeFilterç­›é€‰æ˜¾ç¤º
ä¸ªäººæˆå°±é¡µé¢ â†’ ç”¨æˆ·: æ¸²æŸ“å¾½ç« ç½‘æ ¼(å·²è§£é”å½©è‰²,æœªè§£é”ç°è‰²+é”)
ç”¨æˆ· â†’ ä¸ªäººæˆå°±é¡µé¢: ç‚¹å‡»"æœªè§£é”"ç­›é€‰
ä¸ªäººæˆå°±é¡µé¢ â†’ ä¸ªäººæˆå°±é¡µé¢: æ˜¾ç¤ºæœªè§£é”å¾½ç« å’Œå½“å‰è¿›åº¦
ä¸ªäººæˆå°±é¡µé¢ â†’ ç”¨æˆ·: æ˜¾ç¤º"è¿›åº¦:5/10"ç­‰è¿›åº¦ä¿¡æ¯
```

## æ¥å£å®šä¹‰

### 1. è·å–ç§¯åˆ†å†å²

**æ¥å£**: `GET /users/:id/point-history`

**è¯·æ±‚å¤´**: `Authorization: Bearer <token>`

**æŸ¥è¯¢å‚æ•°**:
- `page` (number, å¯é€‰) - é¡µç ,é»˜è®¤1
- `limit` (number, å¯é€‰) - æ¯é¡µæ•°é‡,é»˜è®¤20

**å“åº”æ•°æ®**:
```json
{
  "success": true,
  "data": {
    "history": [
      {
        "id": "ph_1701234567890",
        "userId": "user_123",
        "points": 10,
        "reason": "å®Œæˆé—®å·ã€Šç”¨æˆ·ä½“éªŒè°ƒæŸ¥ã€‹",
        "type": "earn",
        "createdAt": "2024-01-15T10:30:00.000Z"
      },
      {
        "id": "ph_1701234567891",
        "userId": "user_123",
        "points": 5,
        "reason": "æäº¤é—®å·å®¡æ ¸",
        "type": "earn",
        "createdAt": "2024-01-15T09:00:00.000Z"
      }
    ],
    "total": 50,
    "page": 1,
    "totalPages": 3
  }
}
```

### 2. è·å–æ‰€æœ‰å¾½ç« å®šä¹‰

**æ¥å£**: `GET /badges`

**å“åº”æ•°æ®**:
```json
[
  {
    "id": "badge_survey_10",
    "name": "é—®å·è¾¾äºº",
    "description": "å®Œæˆ10ä»½é—®å·",
    "icon": "ğŸ¯",
    "type": "survey_count",
    "requirement": 10,
    "points": 20
  },
  {
    "id": "badge_continuous_7",
    "name": "åšæŒä¸æ‡ˆ",
    "description": "è¿ç»­ç™»å½•7å¤©",
    "icon": "ğŸ”¥",
    "type": "continuous_login",
    "requirement": 7,
    "points": 15
  },
  {
    "id": "badge_create_5",
    "name": "åˆ›ä½œæ–°æ˜Ÿ",
    "description": "åˆ›å»º5ä»½é—®å·",
    "icon": "âœ¨",
    "type": "create_count",
    "requirement": 5,
    "points": 25
  }
]
```

### 3. è·å–ç”¨æˆ·å·²è§£é”å¾½ç« 

**æ¥å£**: `GET /users/:id/badges`

**è¯·æ±‚å¤´**: `Authorization: Bearer <token>`

**å“åº”æ•°æ®**:
```json
{
  "success": true,
  "data": [
    "badge_survey_10",
    "badge_continuous_7",
    "badge_create_5"
  ]
}
```

### 4. ç”¨æˆ·æ³¨å†Œ(å«åˆå§‹ç§¯åˆ†)

**æ¥å£**: `POST /auth/register`

**è¯·æ±‚å‚æ•°**:
```json
{
  "username": "zhangsan",
  "email": "zhangsan@example.com",
  "password": "password123",
  "nickname": "å¼ ä¸‰"
}
```

**å“åº”æ•°æ®**:
```json
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_123",
      "username": "zhangsan",
      "email": "zhangsan@example.com",
      "nickname": "å¼ ä¸‰",
      "points": 100,
      "role": "user",
      "avatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=zhangsan"
    }
  }
}
```

## å…³é”®ä»£ç 

### åç«¯ - æ³¨å†Œèµ é€ç§¯åˆ† (authController.js)

```javascript
exports.register = async (req, res, next) => {
  try {
    const { username, email, password, nickname } = req.body;

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    const existingUsername = await User.findOne({
      where: { username },
    });

    if (existingUsername) {
      return res.status(400).json({
        success: false,
        message: "ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥",
      });
    }

    // åˆ›å»ºç”¨æˆ·,åˆå§‹ç§¯åˆ†100
    const user = await User.create({
      id: Date.now().toString(),
      username,
      email: email || `${username}@example.com`,
      password,
      nickname: nickname || username,
      points: 100, // æ³¨å†Œèµ é€ 100 ç§¯åˆ†
      avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
    });

    // è®°å½•ç§¯åˆ†å†å²
    await PointHistory.create({
      id: `ph_${Date.now()}`,
      userId: user.id,
      points: 100,
      reason: "æ³¨å†Œå¥–åŠ±",
      type: "earn",
    });

    // ç”Ÿæˆ Token
    const token = jwt.sign(
      { id: user.id, role: user.role },
      jwtConfig.secret,
      { expiresIn: jwtConfig.expiresIn }
    );

    res.status(201).json({
      success: true,
      message: "æ³¨å†ŒæˆåŠŸ",
      data: {
        token,
        user: user.toSafeObject(),
      },
    });
  } catch (error) {
    next(error);
  }
};
```

### åç«¯ - å®Œæˆé—®å·å¥–åŠ±ç§¯åˆ† (answerController.js)

```javascript
exports.submitAnswer = async (req, res, next) => {
  const t = await sequelize.transaction();

  try {
    const { surveyId, answers, duration, score, result } = req.body;

    // æ£€æŸ¥é—®å·æ˜¯å¦å­˜åœ¨
    const survey = await Survey.findByPk(surveyId);
    if (!survey) {
      await t.rollback();
      return res.status(404).json({
        success: false,
        message: "é—®å·ä¸å­˜åœ¨",
      });
    }

    // åˆ›å»ºç­”æ¡ˆè®°å½•
    const answer = await Answer.create(
      {
        id: Date.now().toString(),
        userId: req.user.id,
        surveyId,
        answers,
        score,
        result,
        duration,
        submittedAt: new Date(),
      },
      { transaction: t }
    );

    // æ›´æ–°é—®å·ç»Ÿè®¡
    await survey.increment("participantCount", { transaction: t });
    await survey.increment("responseCount", { transaction: t });

    // å¥–åŠ±ç§¯åˆ†
    const pointsEarned = 10;
    await req.user.increment("points", { by: pointsEarned, transaction: t });
    await PointHistory.create(
      {
        id: `ph_${Date.now()}`,
        userId: req.user.id,
        points: pointsEarned,
        reason: `å®Œæˆé—®å·ã€Š${survey.title}ã€‹`,
        type: "earn",
      },
      { transaction: t }
    );

    await t.commit();

    res.status(201).json({
      success: true,
      message: "ç­”æ¡ˆæäº¤æˆåŠŸ",
      data: {
        answer,
        pointsEarned, // è¿”å›è·å¾—çš„ç§¯åˆ†
      },
    });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};
```

### åç«¯ - åˆ›å»ºé—®å·å¥–åŠ±ç§¯åˆ† (surveyController.js)

```javascript
exports.createSurvey = async (req, res, next) => {
  const t = await sequelize.transaction();

  try {
    const {
      title,
      description,
      category,
      questionList,
      status,
    } = req.body;

    const survey = await Survey.create(
      {
        id: Date.now().toString(),
        userId: req.user.id,
        title,
        description,
        category,
        questionList,
        status: status || "draft",
        questions: questionList?.length || 0,
      },
      { transaction: t }
    );

    // ç§¯åˆ†å¥–åŠ±é€»è¾‘
    const PointHistory = require("../models").PointHistory;
    let pointsEarned = 0;
    let rewardReason = "";

    if (status === "draft") {
      // åˆ›å»ºé—®å·ï¼ˆè‰ç¨¿ï¼‰: è·å¾— 3 ç§¯åˆ†
      pointsEarned = 3;
      rewardReason = `åˆ›å»ºé—®å·ã€Š${title}ã€‹`;
    } else if (status === "pending") {
      // æäº¤å®¡æ ¸: è·å¾— 5 ç§¯åˆ†
      pointsEarned = 5;
      rewardReason = `æäº¤é—®å·ã€Š${title}ã€‹å®¡æ ¸`;
    } else if (status === "published" && req.user.role === "admin") {
      // ç®¡ç†å‘˜ç›´æ¥å‘å¸ƒ: è·å¾— 3 ç§¯åˆ†
      pointsEarned = 3;
      rewardReason = `åˆ›å»ºå¹¶å‘å¸ƒé—®å·ã€Š${title}ã€‹`;
    }

    if (pointsEarned > 0) {
      await req.user.increment("points", { by: pointsEarned, transaction: t });
      await PointHistory.create(
        {
          id: `ph_${Date.now()}`,
          userId: req.user.id,
          points: pointsEarned,
          reason: rewardReason,
          type: "earn",
        },
        { transaction: t }
      );
    }

    await t.commit();

    res.status(201).json({
      success: true,
      message: "é—®å·åˆ›å»ºæˆåŠŸ",
      data: {
        ...survey.toJSON(),
        pointsEarned, // è¿”å›è·å¾—çš„ç§¯åˆ†
      },
    });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};
```

### åç«¯ - è·å–ç§¯åˆ†å†å² (userController.js)

```javascript
exports.getPointHistory = async (req, res, next) => {
  try {
    const userId = req.params.id || req.user.id;
    const { page = 1, limit = 20 } = req.query;

    const history = await PointHistory.findAndCountAll({
      where: { userId },
      limit: parseInt(limit),
      offset: (page - 1) * limit,
      order: [["createdAt", "DESC"]], // æŒ‰æ—¶é—´å€’åº
    });

    res.json({
      success: true,
      data: {
        history: history.rows,
        total: history.count,
        page: parseInt(page),
        totalPages: Math.ceil(history.count / limit),
      },
    });
  } catch (error) {
    next(error);
  }
};
```

### å‰ç«¯ - ç­‰çº§è®¡ç®— (AchievementsPage.vue)

```javascript
// ç­‰çº§è®¡ç®—å…¬å¼
const getUserLevel = computed(() => {
  const points = userStats.value.points || 0;
  return Math.floor(points / 500) + 1;
});

// ç­‰çº§æ•°æ®è¡¨
const levelData = [
  { level: 1, points: "0-499", badge: "ğŸ¯" },
  { level: 2, points: "500-999", badge: "ğŸ¥‰" },
  { level: 3, points: "1000-1499", badge: "ğŸ¥ˆ" },
  { level: 4, points: "1500-1999", badge: "ğŸ¥‡" },
  { level: 5, points: "2000-2499", badge: "ğŸ†" },
  { level: 10, points: "4500-4999", badge: "ğŸ‘‘" },
];
```

### å‰ç«¯ - å¾½ç« è¿›åº¦è®¡ç®— (AchievementsPage.vue)

```javascript
// è·å–å½“å‰è¿›åº¦
const getCurrentProgress = (badge) => {
  if (!badge.type) return 0;

  switch (badge.type) {
    case "survey_count":
      return userStats.value.completedSurveys;
    case "login_count":
      return answerStats.value.loginCount;
    case "continuous_login":
      return answerStats.value.continuousLoginDays;
    case "create_count":
      return answerStats.value.createCount;
    case "publish_count":
      return answerStats.value.publishCount;
    case "approved_count":
      return answerStats.value.approvedCount;
    case "favorite_count":
      return answerStats.value.favoriteCount;
    case "comment_count":
      return answerStats.value.commentCount;
    case "share_count":
      return answerStats.value.shareCount;
    case "total_points":
      return userStats.value.points;
    case "profile_complete":
      return answerStats.value.profileComplete;
    default:
      return 0;
  }
};

// å·²è§£é”å¾½ç« 
const unlockedBadges = computed(() => {
  return allBadges.value.filter((badge) =>
    userUnlockedBadgeIds.value.includes(badge.id)
  );
});

// æœªè§£é”å¾½ç« 
const lockedBadges = computed(() => {
  return allBadges.value.filter(
    (badge) => !userUnlockedBadgeIds.value.includes(badge.id)
  );
});
```

### å‰ç«¯ - ç§¯åˆ†æç¤ºå±•ç¤º (AnswerPage.vue)

```javascript
// æäº¤é—®å·åæ˜¾ç¤ºç§¯åˆ†å¥–åŠ±
const submitSurvey = async () => {
  try {
    const result = await submitSurveyApi(surveyId, {
      answers: userAnswers,
      duration: answerDuration,
    });

    // æ›´æ–°ç”¨æˆ·ç§¯åˆ†çŠ¶æ€
    if (result.pointsEarned && result.pointsEarned > 0) {
      const currentProfile = userStore.profile;
      if (currentProfile) {
        currentProfile.points =
          (currentProfile.points || 0) + result.pointsEarned;
        userStore.setProfile(currentProfile);
      }

      // æ˜¾ç¤ºç§¯åˆ†å¥–åŠ±æç¤º
      let message = `é—®å·æäº¤æˆåŠŸï¼è·å¾— ${result.pointsEarned} ç§¯åˆ†`;
      if (result.isFirstSurvey) {
        message += "ï¼ˆé¦–æ¬¡å®Œæˆé¢å¤–å¥–åŠ±20ç§¯åˆ†ï¼‰";
      }
      ElMessage.success(message);
    }

    // è·³è½¬åˆ°ç»“æœé¡µé¢
    router.push({
      name: "SurveyResult",
      params: { id: surveyId },
    });
  } catch (error) {
    ElMessage.error("æäº¤å¤±è´¥ï¼š" + error.message);
  }
};
```

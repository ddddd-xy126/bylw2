# 问卷状态与模板管理

## 1、简要描述

### （1）功能描述
问卷状态与模板管理功能允许管理员和问卷创建者对问卷的发布状态和模板属性进行灵活控制。问卷状态包括草稿(draft)、待审核(pending)、已发布(published)、已停止(stopped)、已拒绝(rejected)等,管理员可通过状态变更接口实现问卷的发布、下架、重新上架等操作。模板管理功能允许管理员将优质问卷设置为系统模板(isTemplate=true),供其他用户复制使用,提升问卷创建效率。

问卷状态变更遵循严格的权限控制:普通用户只能修改自己创建的问卷,管理员可修改任意问卷。状态流转逻辑包括:草稿→提交审核(pending)、待审核→发布(published)或拒绝(rejected)、已发布→下架(stopped)、已停止→重新上架(published)。发布操作会自动记录首次发布时间(publishedAt),下架操作则保留历史数据但停止接受新答题。

### （2）代码逻辑
前端调用 `PUT /api/surveys/:id` 接口更新问卷信息,传入status和isTemplate等字段。后端控制器开启数据库事务,查询目标问卷并验证权限(创建者或管理员)。检查问卷状态变更的合法性,例如从draft到pending需触发"提交审核"积分奖励(5积分),从pending到published需记录首次发布时间。

对于模板设置,管理员可在请求体中传入isTemplate=true,后端直接更新该字段。若问卷原本不是模板,更新后将在模板列表中展示。前端模板选择页面调用 `GET /api/surveys?isTemplate=true` 接口筛选所有模板问卷。

状态更新完成后,在同一事务中处理积分奖励(若适用),创建PointHistory记录。提交事务后返回更新后的问卷数据。前端接收响应后更新界面状态,并显示操作成功提示(如"问卷已发布"、"问卷已设为模板"等)。

### 问卷状态与模板管理时序图描述
```
管理员/用户 → 问卷管理页面: 点击"发布"/"下架"/"设为模板"按钮
问卷管理页面 → surveyController: PUT /api/surveys/:id (status, isTemplate)
surveyController → MySQL: 开启数据库事务
surveyController → MySQL: 查询目标问卷记录
MySQL → surveyController: 返回问卷数据

alt 问卷不存在
    surveyController → MySQL: 回滚事务
    surveyController → 问卷管理页面: 返回404错误
    问卷管理页面 → 管理员/用户: 显示问卷不存在提示
else 无权限修改
    surveyController → MySQL: 回滚事务
    surveyController → 问卷管理页面: 返回403错误
    问卷管理页面 → 管理员/用户: 显示无权限提示
else 有权限
    surveyController → surveyController: 检查状态变更逻辑(积分奖励、发布时间)
    surveyController → MySQL: 更新问卷状态和模板属性
    MySQL → surveyController: 返回更新结果
    
    alt 符合积分奖励条件(draft→pending)
        surveyController → MySQL: 增加用户积分
        surveyController → MySQL: 创建PointHistory记录
        MySQL → surveyController: 返回积分记录
    end
    
    surveyController → MySQL: 提交事务
    surveyController → 问卷管理页面: 返回更新成功响应
    问卷管理页面 → 管理员/用户: 显示操作成功提示
end
```

## 2、接口定义

**表 5-22 问卷状态与模板管理接口表**

| 接口名称 | 更新问卷状态与属性接口 |
|---------|-------------------|
| 接口描述 | 用户或管理员更新问卷状态、模板属性等信息时调用 |
| URL | {{baseurl}}/surveys/:id |
| method | PUT |
| 请求参数 | `{ "status": "published", "isTemplate": true, "title": "更新后的标题", "description": "...", "category": "健康", "questionList": [...] }` (status和isTemplate为可选,其他字段同创建问卷) |
| 返回参数 | `{ "success": true, "message": "问卷更新成功", "data": { "id": "SV123", "title": "...", "status": "published", "isTemplate": true, "publishedAt": "2024-03-15T10:30:00Z", "pointsEarned": 5 } }` |

## 3、关键代码

**代码 5-22 问卷状态与模板管理核心实现代码**

```javascript
// 更新问卷状态与模板属性 (surveyController.js)
exports.updateSurvey = async (req, res, next) => {
  const t = await sequelize.transaction();

  try {
    const { id } = req.params;
    const { title, description, category, questionList, status, isTemplate } = req.body;

    const survey = await Survey.findByPk(id);

    if (!survey) {
      await t.rollback();
      return res.status(404).json({ success: false, message: "问卷不存在" });
    }

    // 检查权限(只有创建者或管理员可以修改)
    if (survey.userId !== req.user.id && req.user.role !== "admin") {
      await t.rollback();
      return res.status(403).json({ success: false, message: "无权修改此问卷" });
    }

    const oldStatus = survey.status;
    const newStatus = status || oldStatus;

    // 积分奖励逻辑:从草稿提交审核奖励5积分
    const PointHistory = require("../models").PointHistory;
    let pointsEarned = 0;
    let rewardReason = "";

    if (oldStatus === "draft" && newStatus === "pending") {
      pointsEarned = 5;
      rewardReason = `提交问卷《${title || survey.title}》审核`;
    }

    // 更新问卷信息
    await survey.update(
      {
        title,
        description,
        category,
        questionList,
        status: newStatus,
        isTemplate: isTemplate !== undefined ? isTemplate : survey.isTemplate,
        ...(newStatus === "published" && !survey.publishedAt && { publishedAt: new Date() }),
      },
      { transaction: t }
    );

    // 发放积分
    if (pointsEarned > 0) {
      await req.user.increment("points", { by: pointsEarned, transaction: t });
      await PointHistory.create(
        {
          id: `ph_${Date.now()}`,
          userId: req.user.id,
          points: pointsEarned,
          reason: rewardReason,
          type: "earn",
        },
        { transaction: t }
      );
    }

    await t.commit();

    res.json({
      success: true,
      message: "问卷更新成功",
      data: { ...survey.toJSON(), pointsEarned },
    });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};
```

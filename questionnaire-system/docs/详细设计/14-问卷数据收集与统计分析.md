# 问卷数据收集与统计分析

## 功能描述

问卷数据收集与统计分析功能是问卷系统的核心模块之一,主要用于已发布问卷的数据收集、统计分析和可视化展示。用户在个人中心的"已发布"页面可以查看每个问卷的数据收集情况,包括参与人数、各选项的选择占比、文本题的所有回答、评分题的平均分和分布等详细统计信息。

主要功能特性:
- **整体概览**: 展示问卷的参与人数、问题数量、平均评分等核心指标
- **选择题统计**: 显示单选题和多选题各选项的选择次数和百分比占比,带进度条可视化
- **文本题展示**: 列出所有用户的文本回答内容,带提交时间和用户标识
- **评分题分析**: 计算平均分,展示1-5星的评分分布和百分比
- **实时数据**: 从数据库实时查询所有答案记录,确保统计数据准确性
- **可视化展示**: 使用进度条、星级评分、卡片等UI组件直观展示数据

## 代码逻辑

### 1. 数据收集流程

用户提交答案后数据收集:
1. 用户在答题页面提交答案
2. 前端调用 `submitSurveyApi` 提交答案数组
3. 后端创建 Answer 记录,存储完整答案数据
4. 更新 Survey 的 `participantCount` 和 `responseCount`
5. 奖励用户10积分并创建积分历史记录

Answer 记录结构:
- `id`: 答案唯一标识
- `userId`: 答题用户ID
- `surveyId`: 问卷ID
- `answers`: 答案数组 `[{questionId, answer, text}]`
- `score`: 得分(答题式问卷)
- `duration`: 答题耗时(秒)
- `submittedAt`: 提交时间

### 2. 查看数据统计入口

用户点击"已发布问卷"列表中的"查看数据"按钮:
1. 触发 `viewResults(surveyId)` 方法
2. 调用 `getSurveyDetail(id)` 获取问卷详情(题目列表)
3. 调用 `/answers?surveyId=${id}` 获取该问卷的所有答案记录
4. 组合数据,计算参与人数 = 答案记录数
5. 打开 StatsDialog 对话框展示统计数据

### 3. 选择题统计计算

对于单选题和多选题,统计每个选项的选择次数:
- 遍历所有答案记录的 `answers` 数组
- 找到对应 `questionId` 的答案
- 单选题:判断 `answer === optionId` 则计数+1
- 多选题:判断 `answer` 数组包含 `optionId` 则计数+1
- 计算百分比 = (选择次数 / 参与人数) × 100%

进度条颜色规则:
- 占比 ≥ 60%: 绿色(#67C23A)
- 占比 ≥ 30%: 橙色(#E6A23C)
- 占比 < 30%: 红色(#F56C6C)

### 4. 文本题回答展示

文本题展示所有用户的回答:
- 遍历所有答案记录
- 筛选出对应 `questionId` 的回答
- 提取 `text` 或 `answer` 字段作为回答内容
- 提取 `submittedAt` 作为提交时间
- 按用户顺序展示回答内容

### 5. 评分题统计分析

评分题计算平均分和分布:
- 遍历所有答案,提取对应题目的评分值
- 将评分值向下取整(Math.floor)
- 计算平均分 = 所有评分之和 / 评分人数
- 统计1-5星的评分数量
- 计算每个星级的占比百分比
- 使用 el-rate 组件展示平均星级

### 6. 后端答案查询接口

`getAnswers` 控制器支持按条件查询:
- 支持按 `userId` 筛选(查看某用户的答题记录)
- 支持按 `surveyId` 筛选(查看某问卷的所有答案)
- 关联查询 Survey 和 User 信息
- 支持排序参数 `_sort` 和 `_order`
- 支持分页参数 `_page` 和 `_limit`
- 默认按提交时间倒序排列

权限控制:
- 问卷作者可查看该问卷的所有答案
- 用户只能查看自己的答题记录
- 管理员可查看所有答案

## 时序图描述

### 用户查看问卷数据统计

```
用户 → 已发布问卷页面: 点击某个问卷的"查看数据"按钮
已发布问卷页面 → viewResults方法: 调用viewResults(surveyId)
viewResults方法 → API层(survey.js): getSurveyDetail(id)
API层 → 后端路由: GET /surveys/:id
后端路由 → surveyController.getSurvey: 调用获取问卷详情方法
surveyController.getSurvey → Survey表: findByPk(id, include: questionList)
Survey表 → surveyController.getSurvey: 返回问卷详情(包含题目列表)
surveyController.getSurvey → 后端路由: 返回问卷数据
后端路由 → API层: 返回{id, title, questionList, ...}
API层 → viewResults方法: 返回问卷详情surveyData
viewResults方法 → API层(apiClient): GET /answers?surveyId=${id}
API层 → 后端路由: GET /answers?surveyId=xxx
后端路由 → answerController.getAnswers: 调用获取答案列表方法
answerController.getAnswers → Answer表: findAndCountAll(where: {surveyId})
answerController.getAnswers → User表: 关联查询答题用户信息
answerController.getAnswers → Survey表: 关联查询问卷标题
Answer表 → answerController.getAnswers: 返回答案记录数组
answerController.getAnswers → 后端路由: 返回answers数组
后端路由 → API层: 返回答案列表
API层 → viewResults方法: 返回answersResponse数组
viewResults方法 → viewResults方法: 组合数据{...surveyData, answers, participantCount}
viewResults方法 → StatsDialog组件: 打开对话框,传入currentSurveyStats
StatsDialog组件 → StatsDialog组件: 渲染统计数据(概览卡片+题目统计)
StatsDialog组件 → 用户: 展示数据统计对话框
```

### 统计数据计算与展示流程

```
StatsDialog组件 → StatsDialog组件: 接收props.stats(包含questionList和answers)
StatsDialog组件 → 概览卡片区域: 展示参与人数、问题数量、平均评分
StatsDialog组件 → 题目列表循环: 遍历questionList渲染每个题目
题目列表循环 → 单选/多选题: 判断question.type === 'single' || 'multiple'
单选/多选题 → getOptionSelectedCount方法: 调用计算每个选项的选择次数
getOptionSelectedCount方法 → answers数组: 遍历所有答案记录
getOptionSelectedCount方法 → 答案匹配: 找到questionId匹配的答案
getOptionSelectedCount方法 → 选项匹配: 判断answer === optionId(单选)或includes(多选)
getOptionSelectedCount方法 → 单选/多选题: 返回选择次数count
单选/多选题 → calculatePercentage方法: 计算百分比(count / total * 100)
单选/多选题 → el-progress组件: 渲染进度条,显示次数和百分比
题目列表循环 → 文本题: 判断question.type === 'text'
文本题 → getTextAnswersForQuestion方法: 提取该题的所有文本回答
getTextAnswersForQuestion方法 → answers数组: 筛选questionId匹配的答案
getTextAnswersForQuestion方法 → 文本题: 返回回答列表[{text, submittedAt}]
文本题 → 回答列表循环: 渲染每条回答,显示用户序号+时间+内容
题目列表循环 → 评分题: 判断question.type === 'rating'
评分题 → getAverageRatingForQuestion方法: 计算平均分
getAverageRatingForQuestion方法 → answers数组: 提取所有评分值并向下取整
getAverageRatingForQuestion方法 → 评分题: 返回平均分(向下取整)
评分题 → el-rate组件: 展示星级评分
评分题 → getRatingCount方法: 统计每个星级(1-5)的人数
getRatingCount方法 → 评分题: 返回各星级人数
评分题 → getRatingPercentage方法: 计算各星级占比百分比
评分题 → el-progress组件: 渲染5个进度条(5星到1星)
StatsDialog组件 → 用户: 完整展示所有题目的统计分析结果
```

## 接口定义

### 1. 获取问卷的所有答案

**接口**: `GET /answers`

**请求头**: `Authorization: Bearer <token>`

**查询参数**:
- `surveyId` (string, 必填) - 问卷ID,筛选该问卷的所有答案
- `userId` (string, 可选) - 用户ID,筛选某用户的答案
- `_sort` (string, 可选) - 排序字段,如"submittedAt"
- `_order` (string, 可选) - 排序方向,"ASC" | "DESC"
- `_page` (number, 可选) - 页码
- `_limit` (number, 可选) - 每页数量

**权限**: 问卷作者可查看该问卷的所有答案,普通用户只能查看自己的答案

**响应数据**:
```json
[
  {
    "id": "1701234567890",
    "userId": "user_123",
    "surveyId": "survey_456",
    "answers": [
      {
        "questionId": 1,
        "answer": "option_a",
        "text": "选项A"
      },
      {
        "questionId": 2,
        "answer": ["option_b", "option_c"],
        "text": "选项B, 选项C"
      },
      {
        "questionId": 3,
        "answer": "这是我的文本回答",
        "text": "这是我的文本回答"
      },
      {
        "questionId": 4,
        "answer": 5,
        "text": "5"
      }
    ],
    "score": 85,
    "duration": 120,
    "submittedAt": "2024-01-15T10:30:00.000Z",
    "user": {
      "id": "user_123",
      "username": "zhangsan",
      "nickname": "张三",
      "avatar": "avatar_url"
    },
    "survey": {
      "id": "survey_456",
      "title": "用户体验调查问卷"
    }
  }
]
```

### 2. 提交问卷答案

**接口**: `POST /answers`

**请求头**: `Authorization: Bearer <token>`

**请求参数**:
- `surveyId` (string, 必填) - 问卷ID
- `answers` (array, 必填) - 答案数组
- `duration` (number, 可选) - 答题耗时(秒)
- `score` (number, 可选) - 得分(答题式问卷)
- `result` (string, 可选) - 结果描述

**请求示例**:
```json
{
  "surveyId": "survey_456",
  "answers": [
    {
      "questionId": 1,
      "answer": "option_a",
      "text": "选项A"
    },
    {
      "questionId": 2,
      "answer": ["option_b", "option_c"],
      "text": "选项B, 选项C"
    },
    {
      "questionId": 3,
      "answer": "这是我的建议",
      "text": "这是我的建议"
    },
    {
      "questionId": 4,
      "answer": 5,
      "text": "5"
    }
  ],
  "duration": 120,
  "score": 85,
  "result": "良好"
}
```

**响应数据**:
```json
{
  "success": true,
  "message": "答案提交成功",
  "data": {
    "answer": {
      "id": "1701234567890",
      "userId": "user_123",
      "surveyId": "survey_456",
      "answers": [...],
      "score": 85,
      "submittedAt": "2024-01-15T10:30:00.000Z"
    },
    "pointsEarned": 10
  }
}
```

### 3. 获取问卷详情(含题目列表)

**接口**: `GET /surveys/:id`

**响应数据**:
```json
{
  "id": "survey_456",
  "title": "用户体验调查问卷",
  "description": "了解用户对产品的使用体验",
  "questionList": [
    {
      "id": 1,
      "type": "single",
      "title": "您对我们的产品满意吗？",
      "options": [
        {"id": "option_a", "text": "非常满意"},
        {"id": "option_b", "text": "满意"},
        {"id": "option_c", "text": "一般"},
        {"id": "option_d", "text": "不满意"}
      ]
    },
    {
      "id": 2,
      "type": "multiple",
      "title": "您希望增加哪些功能？",
      "options": [
        {"id": "option_a", "text": "功能A"},
        {"id": "option_b", "text": "功能B"}
      ]
    },
    {
      "id": 3,
      "type": "text",
      "title": "您还有什么建议？"
    },
    {
      "id": 4,
      "type": "rating",
      "title": "请为我们的服务打分",
      "maxRating": 5
    }
  ],
  "participantCount": 256,
  "averageRating": "4.50"
}
```

## 关键代码

### 前端 - 查看数据统计入口 (PublishedPage.vue)

```javascript
const viewResults = async (id) => {
  try {
    loading.value = true;
    // 1. 获取问卷详情(包含题目列表)
    const surveyData = await getSurveyDetail(id);

    // 2. 使用后端API获取该问卷的所有答案
    const answersResponse = await apiClient.get(`/answers?surveyId=${id}`);

    // 3. 组合数据
    currentSurveyStats.value = {
      ...surveyData,
      answers: answersResponse || [], // axios拦截器已解包data字段
      participantCount: answersResponse?.length || 0,
    };

    // 4. 打开统计对话框
    statsDialogVisible.value = true;
  } catch (error) {
    ElMessage.error("加载数据失败：" + error.message);
    console.error("加载统计数据失败:", error);
  } finally {
    loading.value = false;
  }
};
```

### 前端 - 选择题选项统计 (StatsDialog.vue)

```javascript
// 获取选项的实际选择次数（从answers数组统计）
const getOptionSelectedCount = (questionId, optionId) => {
  if (!props.stats || !props.stats.answers) return 0;

  let count = 0;
  props.stats.answers.forEach((answer) => {
    // 找到对应题目的答案
    const questionAnswer = answer.answers?.find(
      (a) => a.questionId == questionId
    );

    if (questionAnswer) {
      // 单选题: 判断答案是否等于选项ID
      if (questionAnswer.answer === optionId) {
        count++;
      }
      // 多选题: 判断答案数组是否包含选项ID
      else if (
        Array.isArray(questionAnswer.answer) &&
        questionAnswer.answer.includes(optionId)
      ) {
        count++;
      }
    }
  });

  return count;
};

// 计算百分比
const calculatePercentage = (count, total) => {
  if (!total || total === 0) return 0;
  const percentage = ((count || 0) / total) * 100;
  return parseFloat(percentage.toFixed(1));
};

// 进度条颜色
const getProgressColor = (percentage) => {
  if (percentage >= 60) return "#67C23A"; // 绿色
  if (percentage >= 30) return "#E6A23C"; // 橙色
  return "#F56C6C"; // 红色
};
```

### 前端 - 评分题统计 (StatsDialog.vue)

```javascript
// 获取评分题的平均分（向下取整）
const getAverageRatingForQuestion = (questionId) => {
  if (!props.stats || !props.stats.answers) return 0;

  const ratings = [];
  props.stats.answers.forEach((answer) => {
    const questionAnswer = answer.answers?.find(
      (a) => a.questionId == questionId
    );
    if (
      questionAnswer &&
      questionAnswer.answer !== null &&
      questionAnswer.answer !== undefined
    ) {
      const rating = parseFloat(questionAnswer.answer);
      if (!isNaN(rating)) {
        ratings.push(Math.floor(rating));
      }
    }
  });

  if (ratings.length === 0) return 0;
  const average = ratings.reduce((sum, r) => sum + r, 0) / ratings.length;
  return Math.floor(average);
};

// 获取特定星级的评分数量
const getRatingCount = (questionId, star) => {
  if (!props.stats || !props.stats.answers) return 0;

  let count = 0;
  props.stats.answers.forEach((answer) => {
    const questionAnswer = answer.answers?.find(
      (a) => a.questionId == questionId
    );
    if (
      questionAnswer &&
      questionAnswer.answer !== null &&
      questionAnswer.answer !== undefined
    ) {
      const rating = Math.floor(parseFloat(questionAnswer.answer));
      if (rating === star) {
        count++;
      }
    }
  });

  return count;
};

// 获取特定星级的评分百分比
const getRatingPercentage = (questionId, star) => {
  const total = getRatingCountForQuestion(questionId);
  if (total === 0) return 0;

  const count = getRatingCount(questionId, star);
  return parseFloat(((count / total) * 100).toFixed(1));
};
```

### 后端 - 获取答案列表 (answerController.js)

```javascript
exports.getAnswers = async (req, res, next) => {
  try {
    const { userId, surveyId, _sort, _order, _page, _limit } = req.query;

    const where = {};
    if (userId) where.userId = userId;
    if (surveyId) where.surveyId = surveyId;

    const options = {
      where,
      include: [
        {
          model: Survey,
          as: "survey",
          attributes: ["id", "title"],
        },
        {
          model: User,
          as: "user",
          attributes: ["id", "username", "nickname", "avatar"],
        },
      ],
    };

    // 排序
    if (_sort) {
      options.order = [[_sort, _order || "ASC"]];
    } else {
      options.order = [["submittedAt", "DESC"]];
    }

    // 分页
    if (_page && _limit) {
      const page = parseInt(_page);
      const limit = parseInt(_limit);
      options.offset = (page - 1) * limit;
      options.limit = limit;
    } else if (_limit) {
      options.limit = parseInt(_limit);
    }

    const answers = await Answer.findAndCountAll(options);

    // 返回直接数组格式,兼容前端
    res.json(answers.rows);
  } catch (error) {
    next(error);
  }
};
```

### 前端 - 文本题回答展示 (StatsDialog.vue Template)

```vue
<template>
  <!-- 文本题 -->
  <div class="text-answers" v-if="question.type === 'text'">
    <div v-if="stats.answers && stats.answers.length > 0">
      <div
        class="text-answer-item"
        v-for="(answer, aIndex) in getTextAnswersForQuestion(question.id)"
        :key="aIndex"
      >
        <div class="answer-header">
          <el-icon><User /></el-icon>
          <span>用户 {{ aIndex + 1 }}</span>
          <span class="answer-time">{{
            formatAnswerTime(answer.submittedAt)
          }}</span>
        </div>
        <div class="answer-content">
          {{ answer.text || "（未填写）" }}
        </div>
      </div>
    </div>
    <div v-else class="no-answers">
      <el-empty description="暂无回答" :image-size="60" />
    </div>
  </div>
</template>

<script>
// 获取文本题的所有回答
const getTextAnswersForQuestion = (questionId) => {
  if (!props.stats || !props.stats.answers) return [];

  const answers = [];
  props.stats.answers.forEach((answer) => {
    const questionAnswer = answer.answers?.find(
      (a) => a.questionId == questionId
    );
    if (questionAnswer) {
      answers.push({
        text: questionAnswer.text || questionAnswer.answer,
        submittedAt: answer.submittedAt,
      });
    }
  });

  return answers;
};
</script>
```

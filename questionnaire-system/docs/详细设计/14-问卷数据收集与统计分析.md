问卷数据收集与统计分析功能
1、简要描述

（1）功能描述：
问卷数据收集与统计分析功能用于展示已发布问卷的整体数据表现，包括参与人数、选择题选项统计占比、文本题回答内容以及评分题的平均得分与分布情况。用户在个人中心的“已发布问卷”页面点击某份问卷后即可查看统计结果。系统会实时从数据库拉取该问卷所有答卷，确保统计结果准确可靠。

（2）代码逻辑：
用户在“已发布问卷”页面点击“查看数据”按钮后，前端调用后端接口获取问卷基本信息及对应的全部答案记录。后端在收到请求后，基于 surveyId 查询答案列表并返回格式化后的答案数据。前端接收到数据后，计算参与人数、单选/多选题的选项选择次数与百分比、文本题回答列表、评分题平均分与分布，并渲染可视化组件（进度条、列表、评分星级等）。用户在界面中即可查看该问卷完整统计分析。

问卷数据统计时序图描述

用户 → 已发布问卷页面：点击“查看数据”
已发布问卷页面 → viewResults 方法：发起 viewResults(surveyId)
viewResults 方法 → 后端 API：调用 getSurveyDetail 接口获取问卷详情
后端 API → MySQL：查询问卷及题目列表
MySQL → 后端 API：返回问卷数据
viewResults 方法 → 后端 API：调用 GET /answers?surveyId=xxx 获取答案记录
后端 API → MySQL：查询该问卷所有 Answer 记录
MySQL → 后端 API：返回答案数组
后端 API → viewResults 方法：返回答案数据
viewResults 方法 → StatsDialog 组件：组合统计数据并打开统计对话框
StatsDialog → 用户：展示统计结果（概览卡片、题目统计、可视化组件）

2、接口定义

表 5-XX 获取指定问卷答案接口表

接口名称 获取问卷答案接口
接口描述 查询某份问卷的所有答卷记录，用于统计分析展示
URL      {{baseurl}}/answers?surveyId=:id
method GET
请求参数 surveyId（必填），支持排序、分页、用户筛选等扩展参数
返回参数 答案列表数组（包含答题用户、答案内容、提交时间等）

示例返回：

[
  {
    "id": "1701234567890",
    "userId": "user_123",
    "surveyId": "survey_456",
    "answers": [ ... ],
    "duration": 120,
    "score": 85,
    "submittedAt": "2024-01-15T10:30:00.000Z",
    "user": { "id": "user_123", "username": "zhangsan", "avatar": "avatar_url" },
    "survey": { "id": "survey_456", "title": "用户体验调查问卷" }
  }
]


表 5-XX 提交问卷答案接口表

接口名称 提交答案接口
接口描述 用户答题后提交答案数据
URL {{baseurl}}/answers
method POST
请求参数 surveyId、answers 数组、duration、score（可选）
返回参数 提交成功信息与新增的 Answer 数据

表 5-XX 获取问卷详情接口表

接口名称 获取问卷详情接口
接口描述 查询问卷基本信息及题目列表
URL {{baseurl}}/surveys/:id
method GET
返回参数 问卷基础信息与 questionList 数组

3、关键代码

（1）查看统计入口（viewResults 方法）

const viewResults = async (id) => {
  try {
    loading.value = true;

    // 1. 获取问卷详情
    const surveyData = await getSurveyDetail(id);

    // 2. 获取答案列表
    const answersResponse = await apiClient.get(`/answers?surveyId=${id}`);

    // 3. 数据整合
    currentSurveyStats.value = {
      ...surveyData,
      answers: answersResponse || [],
      participantCount: answersResponse?.length || 0,
    };

    // 4. 打开统计对话框
    statsDialogVisible.value = true;
  } catch (error) {
    ElMessage.error("加载数据失败：" + error.message);
  } finally {
    loading.value = false;
  }
};


（2）选择题选项统计（StatsDialog.vue）

const getOptionSelectedCount = (questionId, optionId) => {
  if (!props.stats?.answers) return 0;

  let count = 0;
  props.stats.answers.forEach((record) => {
    const qa = record.answers?.find(a => a.questionId == questionId);
    if (qa) {
      if (qa.answer === optionId) count++;
      if (Array.isArray(qa.answer) && qa.answer.includes(optionId)) count++;
    }
  });
  return count;
};

const calculatePercentage = (count, total) => {
  if (!total) return 0;
  return parseFloat(((count / total) * 100).toFixed(1));
};


（3）评分题统计（StatsDialog.vue）

const getAverageRatingForQuestion = (questionId) => {
  const ratings = [];

  props.stats?.answers?.forEach((record) => {
    const qa = record.answers?.find(a => a.questionId == questionId);
    if (qa && qa.answer != null) {
      const val = Math.floor(parseFloat(qa.answer));
      if (!isNaN(val)) ratings.push(val);
    }
  });

  if (!ratings.length) return 0;
  return Math.floor(ratings.reduce((s, v) => s + v, 0) / ratings.length);
};


（4）后端获取答案列表（answerController.js）

exports.getAnswers = async (req, res, next) => {
  try {
    const { userId, surveyId, _sort, _order, _page, _limit } = req.query;

    const where = {};
    if (surveyId) where.surveyId = surveyId;
    if (userId) where.userId = userId;

    const answers = await Answer.findAll({
      where,
      include: [
        { model: User, attributes: ["id", "username", "avatar"] },
        { model: Survey, attributes: ["id", "title"] }
      ],
      order: _sort ? [[_sort, _order || "DESC"]] : [["submittedAt", "DESC"]],
      ...( _page && _limit ? { offset: (_page - 1) * _limit, limit: parseInt(_limit) } : {})
    });

    res.json(answers);
  } catch (error) {
    next(error);
  }
};
问卷数据收集与统计分析
1、简要描述
（1）功能描述：问卷数据收集与统计分析功能用于展示已发布问卷的整体数据表现，包括参与人数、选择题选项统计占比、文本题回答内容以及评分题的平均得分与分布情况。

（2）代码逻辑：
用户进入“已发布问卷”页面后，点击某份问卷的“查看数据”按钮，前端调用 GET /answers?surveyId=xxx 接口获取该问卷的所有答案记录。后端在 Answer 表中查询并关联 User 表和 Survey 表，按提交时间倒序返回答案数据。前端接收到答案列表后，计算统计数据：参与人数为答案数组长度，单选/多选题通过遍历答案记录统计每个选项的选择次数并计算百分比，文本题提取所有回答内容列表，评分题计算平均分。统计结果通过可视化组件（进度条、列表、评分星级等）展示在统计对话框中。

###问卷数据统计时序图描述
用户 → 已发布问卷页面: 点击"查看数据"
已发布问卷页面 → viewResults: 触发统计查看
viewResults → 后端API (GET /answers?surveyId=xxx): 请求答案数据
后端API → MySQL: 查询 Answer 表并关联 User、Survey 表
MySQL → 后端API: 返回答案列表
后端API → 已发布问卷页面: 返回答案数据
已发布问卷页面 → StatsDialog: 计算统计并打开对话框
StatsDialog → 用户: 展示统计结果（参与人数、选项占比、评分分布）

***时序图最新描述***
    用户->>前端已发布问卷页面PublishedPage.vue: ① 点击"查看数据"按钮
    前端已发布问卷页面PublishedPage.vue->>API层(survey.js): ③ 获取问卷详情和获取答案接口
    API层(survey.js)->>后端路由(answers.js): ④ GET /answers?surveyId={id}
    后端路由(answers.js)->>控制器(answerController.js): ⑤ 调用getAnswers方法
    控制器(answerController.js)->>数据库: ⑥ 查询Answer表关联User和Survey表
    数据库-->>控制器(answerController.js): ⑦ 返回答案列表
    控制器(answerController.js)-->>前端PublishedPage.vue: ⑧ 返回答案数据
    前端PublishedPage.vue->>前端StatsDialog.vue: ⑨ 传递数据并打开统计对话框
    前端StatsDialog.vue->>前端StatsDialog.vue: ⑩ 计算各题型统计(选项占比/文本回答/评分分布)
    前端StatsDialog.vue->>用户: ⑪ 展示统计结果
***end***

2、接口定义
表 5-14 问卷数据统计接口表
接口名称 获取问卷答案接口
接口描述 查询指定问卷的所有答卷记录，用于统计分析展示
URL {{baseurl}}/answers?surveyId={surveyId}
method GET
请求参数 surveyId: 问卷 ID
返回参数 [{"id": "ans_123", "userId": "user_123", "surveyId": "survey_456", "answers": [...], "duration": 120, "submittedAt": "2024-01-15T10:30:00Z", "user": {"id": "user_123", "username": "zhangsan", "avatar": "avatar_url"}, "survey": {"id": "survey_456", "title": "用户体验调查"}}]

3、关键代码
代码 5-14 问卷数据收集与统计分析核心代码

// 选项统计（StatsDialog.vue）
const getOptionSelectedCount = (questionId, optionId) => {
  let count = 0;
  props.stats.answers.forEach((record) => {
    const qa = record.answers?.find(a => a.questionId == questionId);
    if (qa) {
      if (qa.answer === optionId) count++;
      if (Array.isArray(qa.answer) && qa.answer.includes(optionId)) count++;
    }
  });
  return count;
};


// 获取文本题的所有回答
const getTextAnswersForQuestion = (questionId) => {
  if (!props.stats || !props.stats.answers) return [];

  const answers = [];
  props.stats.answers.forEach((answer) => {
    const questionAnswer = answer.answers?.find(
      (a) => a.questionId == questionId
    );
    if (questionAnswer) {
      answers.push({
        text: questionAnswer.text || questionAnswer.answer,
        submittedAt: answer.submittedAt,
      });
    }
  });

  return answers;
};

// 获取评分题的平均分（向下取整）
const getAverageRatingForQuestion = (questionId) => {
  if (!props.stats || !props.stats.answers) return 0;

  const ratings = [];
  props.stats.answers.forEach((answer) => {
    const questionAnswer = answer.answers?.find(
      (a) => a.questionId == questionId
    );
    if (
      questionAnswer &&
      questionAnswer.answer !== null &&
      questionAnswer.answer !== undefined
    ) {
      const rating = parseFloat(questionAnswer.answer);
      if (!isNaN(rating)) {
        ratings.push(Math.floor(rating));
      }
    }
  });

  if (ratings.length === 0) return 0;
  const average = ratings.reduce((sum, r) => sum + r, 0) / ratings.length;
  return Math.floor(average);
};
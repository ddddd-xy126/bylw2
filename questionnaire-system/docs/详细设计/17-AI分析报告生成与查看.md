# 17 - AI分析报告生成与查看

## 功能描述

AI分析报告生成与查看功能是问卷系统的核心个性化服务之一，为用户提供基于Coze AI平台的智能分析能力。用户完成问卷填写后，系统自动收集用户个人信息（年龄、性别、职业、兴趣标签等）及答题数据，调用Coze AI工作流API进行深度分析，生成包含个性化建议、心理分析、行为洞察等内容的综合报告。

报告生成采用异步调用模式，前端发起请求后系统立即创建报告记录（状态为"生成中"），后端调用Coze流式API获取分析结果，完成后更新报告状态为"已完成"并保存至数据库。用户可通过报告列表查看所有历史报告，点击查看报告详情时，系统直接从数据库获取已生成的内容进行展示，无需重复调用AI服务，保证响应速度和成本优化。

**核心特性：**
- 整合用户画像与答题数据，调用Coze AI工作流生成个性化分析报告
- 流式接收AI响应内容，实时拼接完整报告文本
- 报告状态管理：生成中(generating) / 已完成(completed) / 失败(failed)
- 报告持久化存储，查看时直接从数据库读取，避免重复生成
- 支持报告列表查询、状态轮询、详情查看等完整生命周期操作

---

## 代码逻辑

### 1. 报告生成流程

**前端发起生成请求：**
1. 用户完成问卷填写，点击"生成分析报告"
2. 前端收集问卷ID、标题、答案数组、分类信息
3. 调用 `POST /api/reports/generate` 接口
4. 后端接收请求，验证用户身份和参数完整性

**后端AI调用与存储：**
1. 查询用户详细信息（username、nickname、age、gender、profession、tags等）
2. 检查数据库中是否已存在该用户-问卷组合的报告
   - 若存在且状态为"已完成"，直接返回已有报告
   - 若不存在，创建新报告记录，状态设为"生成中"
3. 组装Coze API输入数据（用户画像 + 问卷答案）
4. 调用 `cozeService.generatePersonalReport()` 发起流式请求
5. 实时接收Coze流式响应，拼接完整报告内容
6. 更新报告记录：status=completed, content=报告文本, generatedAt=当前时间
7. 返回报告ID及内容给前端

**错误处理：**
- 若AI调用失败，更新报告状态为"failed"，记录错误信息
- 前端可通过状态轮询接口检查报告生成进度

### 2. 报告查看流程

**查看报告列表：**
1. 前端调用 `GET /api/reports?page=1&limit=10&status=completed`
2. 后端根据用户ID和筛选条件查询报告记录
3. 返回分页报告列表（包含报告ID、标题、状态、生成时间等）

**查看报告详情：**
1. 用户点击报告，前端调用 `GET /api/reports/:id`
2. 后端验证报告所属权（userId匹配）
3. 从数据库读取报告内容，包含关联的问卷信息
4. 返回完整报告数据（标题、内容、生成时间、问卷信息等）

**状态轮询（可选）：**
- 若报告状态为"生成中"，前端定时调用 `GET /api/reports/:id/status` 检查进度
- 完成后自动刷新页面展示完整内容

---

## 时序图描述

### 报告生成时序图

```
用户 → 前端: 点击"生成分析报告"
前端 → 后端: POST /api/reports/generate (surveyId, answers)
后端 → 数据库: 查询用户信息 (User.findByPk)
数据库 → 后端: 返回用户画像数据
后端 → 数据库: 检查是否已有报告 (Report.findOne)
数据库 → 后端: 返回查询结果

alt 报告已存在且完成
    后端 → 前端: 返回已有报告数据
else 报告不存在或未完成
    后端 → 数据库: 创建/更新报告记录 (status=generating)
    数据库 → 后端: 保存成功
    后端 → CozeAPI: 调用工作流API (流式请求)
    CozeAPI → 后端: 流式返回分析内容 (Event: Message)
    后端 → 后端: 拼接报告内容
    CozeAPI → 后端: Event: Done (结束标志)
    后端 → 数据库: 更新报告 (status=completed, content=报告文本)
    数据库 → 后端: 更新成功
    后端 → 前端: 返回报告ID及内容
end

前端 → 用户: 显示报告内容
```

### 报告查看时序图

```
用户 → 前端: 点击查看报告详情
前端 → 后端: GET /api/reports/:id
后端 → 数据库: 查询报告记录 (Report.findOne where id and userId)
数据库 → 后端: 返回报告数据 (包含content、status、generatedAt)

alt 报告存在
    后端 → 前端: 返回报告详情
    前端 → 用户: 渲染报告内容
else 报告不存在
    后端 → 前端: 404 报告不存在
    前端 → 用户: 提示错误信息
end
```

---

## 接口定义

### 1. 生成分析报告

**接口路径：** `POST /api/reports/generate`

**请求头：**
```json
{
  "Authorization": "Bearer <token>"
}
```

**请求体：**
```json
{
  "surveyId": "SV12345678",
  "surveyTitle": "心理健康测评问卷",
  "category": "心理健康",
  "answers": [
    {
      "question": "您最近一周的睡眠质量如何？",
      "text": "一般，偶尔失眠",
      "answer": "一般，偶尔失眠"
    },
    {
      "question": "您是否经常感到焦虑或压力？",
      "text": "有时会感到压力",
      "answer": "有时会感到压力"
    }
  ]
}
```

**响应示例（成功）：**
```json
{
  "success": true,
  "message": "报告生成成功",
  "data": {
    "reportId": 42,
    "status": "completed",
    "content": "## 个人心理健康分析报告\n\n### 一、整体评估\n根据您的答题情况...",
    "generatedAt": "2024-03-15T10:30:00.000Z"
  }
}
```

**响应示例（已存在）：**
```json
{
  "success": true,
  "message": "报告已存在",
  "data": {
    "id": 42,
    "userId": "USR001",
    "surveyId": "SV12345678",
    "title": "心理健康测评问卷 - 个人分析报告",
    "content": "...",
    "status": "completed",
    "generatedAt": "2024-03-15T10:30:00.000Z"
  }
}
```

---

### 2. 查询报告详情

**接口路径：** `GET /api/reports/:id`

**请求头：**
```json
{
  "Authorization": "Bearer <token>"
}
```

**路径参数：**
- `id`: 报告ID

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": 42,
    "userId": "USR001",
    "surveyId": "SV12345678",
    "title": "心理健康测评问卷 - 个人分析报告",
    "content": "## 个人心理健康分析报告\n\n### 一、整体评估...",
    "surveyTitle": "心理健康测评问卷",
    "category": "心理健康",
    "status": "completed",
    "generatedAt": "2024-03-15T10:30:00.000Z",
    "createdAt": "2024-03-15T10:25:00.000Z",
    "survey": {
      "id": "SV12345678",
      "title": "心理健康测评问卷",
      "category": "心理健康"
    }
  }
}
```

---

### 3. 获取报告列表

**接口路径：** `GET /api/reports`

**请求头：**
```json
{
  "Authorization": "Bearer <token>"
}
```

**查询参数：**
- `page`: 页码（默认1）
- `limit`: 每页数量（默认10）
- `status`: 报告状态筛选（可选：generating/completed/failed）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "reports": [
      {
        "id": 42,
        "title": "心理健康测评问卷 - 个人分析报告",
        "status": "completed",
        "generatedAt": "2024-03-15T10:30:00.000Z",
        "survey": {
          "id": "SV12345678",
          "title": "心理健康测评问卷"
        }
      }
    ],
    "total": 15,
    "page": 1,
    "limit": 10,
    "totalPages": 2
  }
}
```

---

### 4. 查询报告状态（轮询）

**接口路径：** `GET /api/reports/:id/status`

**请求头：**
```json
{
  "Authorization": "Bearer <token>"
}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": 42,
    "status": "completed",
    "generatedAt": "2024-03-15T10:30:00.000Z"
  }
}
```

---

## 关键代码

### 后端：报告生成核心逻辑 (server/routes/reports.js)

```javascript
router.post("/generate", authenticate, async (req, res, next) => {
  try {
    const userId = req.user.id;
    const { surveyId, surveyTitle, answers, category } = req.body;

    // 获取用户完整信息
    const user = await User.findByPk(userId);
    if (!user) {
      return res.status(404).json({ success: false, message: "用户不存在" });
    }

    // 检查是否已存在已完成的报告
    let report = await Report.findOne({
      where: { userId, surveyId },
    });

    if (report && report.status === "completed") {
      return res.json({ success: true, message: "报告已存在", data: report });
    }

    // 创建或更新报告记录为"生成中"
    if (!report) {
      report = await Report.create({
        userId, surveyId,
        title: `${surveyTitle} - 个人分析报告`,
        surveyTitle, category: category || "",
        content: "", status: "generating",
      });
    } else {
      report.status = "generating";
      await report.save();
    }

    // 调用 Coze API 生成报告
    try {
      const reportContent = await generatePersonalReport(
        { username: user.username, nickname: user.nickname, 
          bio: user.bio, city: user.city, gender: user.gender, 
          age: user.age, profession: user.profession, tags: user.tags || [] },
        { title: surveyTitle, category: category || "" },
        answers
      );

      // 保存报告内容
      report.content = reportContent;
      report.status = "completed";
      report.generatedAt = new Date();
      await report.save();

      res.json({
        success: true, message: "报告生成成功",
        data: { reportId: report.id, status: "completed", 
                content: reportContent, generatedAt: report.generatedAt }
      });
    } catch (error) {
      // 生成失败，更新状态
      report.status = "failed";
      report.content = `报告生成失败: ${error.message}`;
      await report.save();
      return res.status(500).json({ success: false, message: "报告生成失败：" + error.message });
    }
  } catch (error) {
    next(error);
  }
});
```

### 后端：Coze AI流式调用 (server/services/cozeService.js)

```javascript
async function generatePersonalReport(userData, surveyData, answers) {
  try {
    // 组装输入数据
    const inputData = {
      nickname: userData.nickname || userData.username || "用户",
      bio: userData.bio || "暂无简介",
      city: userData.city || "未知",
      gender: userData.gender || "unknown",
      age: parseInt(userData.age) || 0,
      profession: userData.profession || "未知",
      tags: Array.isArray(userData.tags) ? userData.tags : [],
      surveyTitle: surveyData.title || "问卷",
      answers: answers.map((answer) => ({
        text: answer.text !== undefined ? answer.text : answer.answer,
        question: answer.question || "",
      })),
    };

    // 调用 Coze 工作流 API (流式)
    const stream = await apiClient.workflows.runs.stream({
      workflow_id: COZE_CONFIG.workflowId,
      parameters: { input: JSON.stringify(inputData) },
    });

    // 收集流式响应
    let reportContent = "";
    for await (const chunk of stream) {
      const event = chunk.event;
      if (event === "Message") {
        const content = chunk.data?.content;
        if (content) reportContent += content;
      } else if (event === "Error") {
        throw new Error(chunk.data?.error_message || "Coze API 调用失败");
      } else if (event === "Done") {
        break;
      }
    }

    if (!reportContent) throw new Error("未能生成报告内容");
    return reportContent;
  } catch (error) {
    console.error("Coze API 调用失败:", error);
    throw error;
  }
}
```

### 前端：生成报告API调用 (client/src/api/report.js)

```javascript
export const generateReportApi = async (surveyId, surveyTitle, answers, category) => {
  const response = await apiClient.post("/reports/generate", {
    surveyId, surveyTitle, answers, category,
  });
  return response;
};

export const getReportApi = async (reportId) => {
  const response = await apiClient.get(`/reports/${reportId}`);
  return response;
};

export const getUserReportsApi = async (params = {}) => {
  const response = await apiClient.get("/reports", { params });
  return response;
};
```

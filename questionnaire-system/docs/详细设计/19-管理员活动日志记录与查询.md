# 管理员活动日志记录与查询

## 1、简要描述

### （1）功能描述
管理员活动日志记录与查询功能用于记录系统管理员的所有关键操作行为，包括用户管理、问卷审核、公告发布、状态变更等操作，并提供多维度的日志查询、筛选和分析能力。系统自动记录每次管理操作的执行人、操作时间、操作类型、操作对象及详细描述,为系统审计、安全追踪和运营分析提供数据支撑。

管理员可在后台查看完整的活动日志列表,支持按操作类型(如用户封禁、问卷审核、公告创建等)、时间范围、执行人等条件进行筛选查询,并可查看每条日志的详细信息。日志采用分页加载方式,按时间倒序排列,确保最新操作优先展示。

### （2）代码逻辑
后端在每个管理操作的控制器方法中,操作执行成功后自动创建AdminActivity记录,包含操作ID、管理员ID、管理员姓名、操作标题、详细描述、操作类型和时间戳等信息。所有日志写入操作均在数据库事务中执行,确保业务操作与日志记录的原子性,若业务操作失败则日志同步回滚。

前端管理后台提供活动日志查询页面,调用 `GET /api/admin/activities` 接口获取日志列表,支持传入分页参数(page、limit)和筛选条件(type)。接口返回日志数组,每条记录包含管理员基本信息(通过关联查询User表获取)、操作详情和时间戳。前端展示日志列表,提供类型筛选器、日期选择器、关键词搜索等交互组件,帮助管理员快速定位目标操作记录。

### 管理员活动日志记录与查询时序图描述
```
管理员 → 后台管理页面: 执行管理操作(如封禁用户、审核问卷)
后台管理页面 → adminController: 调用对应控制器方法
adminController → MySQL: 开启数据库事务
adminController → MySQL: 执行业务操作(如更新用户状态)
MySQL → adminController: 返回操作结果

alt 业务操作成功
    adminController → MySQL: 创建AdminActivity记录
    MySQL → adminController: 返回日志记录
    adminController → MySQL: 提交事务
    adminController → 后台管理页面: 返回操作成功响应
    后台管理页面 → 管理员: 显示成功提示
else 业务操作失败
    adminController → MySQL: 回滚事务(包括日志记录)
    adminController → 后台管理页面: 返回错误响应
    后台管理页面 → 管理员: 显示错误提示
end

管理员 → 活动日志页面: 访问活动日志管理页面
活动日志页面 → adminController: GET /api/admin/activities (携带筛选条件)
adminController → MySQL: 查询AdminActivity表(关联User表)
MySQL → adminController: 返回日志列表及总数
adminController → 活动日志页面: 返回分页日志数据
活动日志页面 → 管理员: 渲染日志列表并显示筛选结果
```

***时序图最新描述***
日志记录流程(以封禁用户为例)
    管理员->>前端后台管理页面: ① 执行管理操作(如封禁用户)
    前端后台管理页面->>API层(admin.js): ② 调用对应接口
    API层(admin.js)->>后端路由(admin.js): ③ PUT /admin/users/:id/ban
    后端路由(admin.js)->>控制器(adminController.js): ④ 调用对应控制器方法
    控制器(adminController.js)->>数据库: ⑤ 开启数据库事务
    控制器(adminController.js)->>数据库: ⑥ 执行业务操作(更新用户状态)
    数据库-->>控制器(adminController.js): ⑦ 返回操作结果
    控制器(adminController.js)->>数据库: ⑧ 创建AdminActivity记录
    控制器(adminController.js)->>数据库: ⑨ 提交事务
    数据库-->>控制器(adminController.js): ⑩ 返回日志记录
    控制器(adminController.js)-->>前端后台管理页面: ⑪ 返回操作成功响应
    前端后台管理页面->>管理员: ⑫ 显示成功提示

日志查询流程
    管理员->>前端活动日志页面: ① 访问活动日志管理页面
    前端活动日志页面->>API层(admin.js): ② 调用获取活动日志接口
    API层(admin.js)->>后端路由(admin.js): ③ GET /admin/activities (携带筛选条件)
    后端路由(admin.js)->>控制器(adminController.js): ④ 调用getActivities方法
    控制器(adminController.js)->>数据库: ⑤ 查询AdminActivity表(关联User表)
    数据库-->>控制器(adminController.js): ⑥ 返回日志列表及总数
    控制器(adminController.js)-->>前端活动日志页面: ⑦ 返回分页日志数据
    前端活动日志页面->>管理员: ⑧ 渲染日志列表并显示筛选结果
***end***

## 2、接口定义

**表 5-19 管理员活动日志接口表**

| 接口名称 | 获取活动日志列表接口 |
|---------|-------------------|
| 接口描述 | 管理员查询系统活动日志时调用,支持分页和类型筛选 |
| URL | {{baseurl}}/admin/activities |
| method | GET |
| 请求参数 | `{ "type": "user_ban", "page": 1, "limit": 20 }` (type可选,用于筛选操作类型) |
| 返回参数 | `{ "success": true, "data": [{ "id": "act_123", "adminId": "ADM001", "adminName": "张管理员", "title": "封禁用户", "description": "封禁用户 zhangsan", "type": "user_ban", "createdAt": "2024-03-15T10:30:00Z", "admin": { "id": "ADM001", "username": "admin01", "nickname": "张管理员", "avatar": "..." } }] }` |

**表 5-19-2 创建活动日志接口表**

| 接口名称 | 创建活动日志记录接口 |
|---------|-------------------|
| 接口描述 | 手动创建活动日志记录(通常由系统自动调用) |
| URL | {{baseurl}}/admin/activities |
| method | POST |
| 请求参数 | `{ "title": "删除问卷", "description": "删除问卷《用户满意度调查》", "type": "survey_delete" }` |
| 返回参数 | `{ "success": true, "message": "活动记录创建成功", "data": { "id": "act_123", "adminId": "ADM001", "adminName": "张管理员", "title": "删除问卷", "description": "删除问卷《用户满意度调查》", "type": "survey_delete", "createdAt": "2024-03-15T10:30:00Z" } }` |

## 3、关键代码

**代码 5-19 管理员活动日志记录与查询核心实现代码**

```javascript
// 获取管理员活动日志 (adminController.js)
exports.getActivities = async (req, res, next) => {
  try {
    const { type, page = 1, limit = 20 } = req.query;

    const where = {};
    if (type) where.type = type;

    const activities = await AdminActivity.findAndCountAll({
      where,
      include: [
        {
          model: User,
          as: "admin",
          attributes: ["id", "username", "nickname", "avatar"],
        },
      ],
      limit: parseInt(limit),
      offset: (page - 1) * limit,
      order: [["createdAt", "DESC"]],
    });

    res.json({
      success: true,
      data: activities.rows,
    });
  } catch (error) {
    next(error);
  }
};

// 示例:封禁用户时自动记录日志 (adminController.js)
exports.banUser = async (req, res, next) => {
  const t = await sequelize.transaction();

  try {
    const { id } = req.params;
    const user = await User.findByPk(id);

    if (!user) {
      await t.rollback();
      return res.status(404).json({ success: false, message: "用户不存在" });
    }

    if (user.id === req.user.id) {
      await t.rollback();
      return res.status(400).json({ success: false, message: "不能封禁自己" });
    }

    await user.update({ banned: true }, { transaction: t });

    // 记录管理员活动日志
    await AdminActivity.create(
      {
        id: `act_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        adminId: String(req.user.id),
        adminName: req.user.nickname || req.user.username,
        title: "封禁用户",
        description: `封禁用户 ${user.username}`,
        type: "user_ban",
      },
      { transaction: t }
    );

    await t.commit();

    res.json({
      success: true,
      message: "用户已封禁",
      data: user.toSafeObject(),
    });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};
```

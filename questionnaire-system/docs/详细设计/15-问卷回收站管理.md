问卷回收站管理
1、简要描述
（1）功能描述：回收站模块用于统一管理用户删除的问卷。系统采用“先入回收站，再决定恢复或永久删除”的机制，确保用户误删可逆，提高数据安全性。

（2）代码逻辑：用户在问卷列表点击"删除"时，后端开启数据库事务，查询问卷完整数据并转为JSON对象，在 RecycleBin 表创建记录保存 surveyData、originalStatus、deletedAt 等字段，然后从 Survey 表删除原问卷记录，提交事务返回"问卷已移至回收站"。用户访问回收站页面时，前端调用 getRecycleBinApi() 获取数据，后端按删除时间倒序返回回收站列表（非管理员仅看自己的），前端计算剩余天数(30天-已过天数)并判断是否即将过期(≤7天)。恢复问卷时，从 surveyData 提取完整数据调用 createSurveyApi 重新创建问卷(status设为originalStatus)，再调用 deleteFromRecycleBinApi 从回收站删除该记录。永久删除时，后端执行 destroy() 真删除，数据无法恢复。支持批量恢复和批量永久删除，遍历 selectedIds 数组执行对应操作，显示进度提示并统计成功/失败数量。

时序图描述
用户 → 问卷列表页面: 点击"删除"按钮
问卷列表页面 → API层: deleteSurveyApi(surveyId)
API层 → 后端API: DELETE /surveys/:id
后端API → surveyController: 调用 deleteSurvey
surveyController → MySQL: 开启事务并查询问卷完整数据
MySQL → surveyController: 返回问卷数据
surveyController → MySQL: 在 RecycleBin 表创建记录，从 Survey 表删除原问卷
surveyController → MySQL: 提交事务
surveyController → API层: 返回操作结果
API层 → 问卷列表页面: 返回成功
问卷列表页面 → 用户: 显示"问卷已移至回收站"提示

用户 → 回收站页面: 点击"恢复"按钮
回收站页面 → API层: createSurveyApi(restoreData)
API层 → 后端API: POST /surveys
后端API → MySQL: 创建新问卷记录(使用 surveyData，status为originalStatus)
MySQL → 后端API: 返回新问卷
回收站页面 → API层: deleteFromRecycleBinApi(survey.id)
API层 → 后端API: DELETE /recycleBin/:id
后端API → MySQL: 删除回收站记录
MySQL → 后端API: 返回成功
后端API → 回收站页面: 返回操作结果
回收站页面 → 用户: 显示"问卷恢复成功"提示

用户 → 回收站页面: 点击"永久删除"按钮
回收站页面 → API层: deleteFromRecycleBinApi(id)
API层 → 后端API: DELETE /recycleBin/:id
后端API → MySQL: 查询并执行 destroy() 真删除
MySQL → 后端API: 返回成功
后端API → 回收站页面: 返回操作结果
回收站页面 → 用户: 显示"问卷已永久删除"提示

***时序图描述***
用户 → 前端界面: 触发删除/恢复/永久删除操作
前端界面 → 后端API: 调用对应接口(DELETE/POST)
后端API → MySQL: 执行软删除/恢复/真删除操作
MySQL → 后端API: 返回操作结果
后端API → 前端界面: 返回数据或操作结果
前端界面 → 用户: 显示对应提示信息
***end***


2、接口定义
表 5-15 问卷回收站管理接口表

接口名称 获取回收站列表接口
接口描述 查询回收站列表，非管理员仅查看自己的回收站项
URL {{baseurl}}/recycleBin?userId={userId}
method GET
请求参数 {"userId": "user_123"} (可选，管理员可用)
返回参数 {"success": true, "data": [{"id": "rb_1701234567890", "surveyId": "survey_123", "title": "用户体验调查", "originalStatus": "published", "deletedAt": "2024-01-15T10:30:00.000Z", "surveyData": {...}}, ...]}

接口名称 删除问卷接口（移入回收站）
接口描述 软删除问卷，将问卷移至回收站
URL {{baseurl}}/surveys/:id
method DELETE
请求参数 路径参数: id（问卷ID）
返回参数 {"success": true, "message": "问卷已移至回收站"}

接口名称 永久删除问卷接口
接口描述 从回收站永久删除问卷，数据无法恢复
URL {{baseurl}}/recycleBin/:id
method DELETE
请求参数 路径参数: id（回收站记录ID）
返回参数 {"success": true, "message": "永久删除成功"}

接口名称 恢复问卷接口
接口描述 从回收站恢复问卷，分两步：创建新问卷 + 删除回收站记录
URL {{baseurl}}/surveys (创建) + {{baseurl}}/recycleBin/:id (删除)
method POST + DELETE
请求参数 {"title": "...", "status": "originalStatus", "questionList": [...], ...} (从 surveyData 提取)
返回参数 创建: {"success": true, "data": {...}}，删除: {"success": true}

3、关键代码
代码 5-15 问卷回收站管理核心代码

// 数据库模型 - RecycleBin 表（RecycleBin.js）
const RecycleBin = sequelize.define("RecycleBin", {
  id: { type: DataTypes.STRING, primaryKey: true },
  surveyId: DataTypes.STRING,
  title: DataTypes.STRING,
  originalStatus: DataTypes.ENUM("draft", "pending", "published", "stopped"),
  surveyData: DataTypes.JSON, // 保存完整问卷数据
  userId: DataTypes.STRING,
  deletedBy: DataTypes.STRING,
  deletedAt: DataTypes.DATE,
});

// 软删除问卷到回收站（surveyController.js）
exports.deleteSurvey = async (req, res, next) => {
  const t = await sequelize.transaction();
  try {
    const survey = await Survey.findByPk(req.params.id);
    if (!survey) {
      await t.rollback();
      return res.status(404).json({ success: false, message: "问卷不存在" });
    }

    // 将问卷移到回收站
    const surveyData = survey.toJSON();
    await RecycleBin.create({
      id: `rb_${Date.now()}`,
      surveyId: survey.id,
      title: survey.title,
      originalStatus: survey.status,
      surveyData: surveyData, // 保存完整数据
      userId: survey.userId,
      deletedBy: req.user.id,
      deletedAt: new Date(),
    }, { transaction: t });

    // 从Survey表删除
    await survey.destroy({ transaction: t });
    await t.commit();

    res.json({ success: true, message: "问卷已移至回收站" });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};

// 获取回收站列表（recycleBin.js）
router.get("/", authenticate, async (req, res, next) => {
  try {
    const where = {};
    if (req.user.role !== "admin") {
      where.userId = req.user.id; // 非管理员只能看自己的
    } else if (req.query.userId) {
      where.userId = req.query.userId;
    }

    const items = await RecycleBin.findAll({
      where,
      order: [["deletedAt", "DESC"]],
    });

    res.json({ success: true, data: items });
  } catch (error) {
    next(error);
  }
});

// 永久删除（recycleBin.js）
router.delete("/:id", authenticate, async (req, res, next) => {
  try {
    const item = await RecycleBin.findByPk(req.params.id);
    if (!item) {
      return res.status(404).json({ success: false, message: "回收站项不存在" });
    }
    await item.destroy(); // 真删除
    res.json({ success: true, message: "永久删除成功" });
  } catch (error) {
    next(error);
  }
});

// 恢复问卷（TrashPage.vue）
const restoreSurvey = async (survey) => {
  try {
    await ElMessageBox.confirm(`确定要恢复问卷"${survey.title}"吗？`, "确认恢复");

    // 从 surveyData 提取完整数据
    const restoreData = {
      ...survey.surveyData,
      status: survey.originalStatus, // 恢复到删除前状态
    };

    // 重新创建问卷
    await createSurveyApi(restoreData);

    // 从回收站删除
    await deleteFromRecycleBinApi(survey.id);

    ElMessage.success("问卷恢复成功");
    await loadTrashedSurveys();
  } catch (error) {
    if (error !== "cancel") {
      ElMessage.error("恢复失败：" + error.message);
    }
  }
};

// 计算剩余天数（TrashPage.vue）
const getRemainingDays = (deletedAt) => {
  const deleteTime = new Date(deletedAt);
  const expiryTime = new Date(deleteTime.getTime() + 30 * 24 * 60 * 60 * 1000);
  const remaining = Math.ceil((expiryTime - Date.now()) / (1000 * 60 * 60 * 24));
  return Math.max(0, remaining);
};

const isExpiringSoon = (deletedAt) => {
  return getRemainingDays(deletedAt) <= 7;
};

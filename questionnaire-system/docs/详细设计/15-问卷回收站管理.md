问卷回收站管理
1、简要描述
（1）功能描述：回收站模块用于统一管理用户删除的问卷。系统采用“先入回收站，再决定恢复或永久删除”的机制，确保用户误删可逆，提高数据安全性。

（2）代码逻辑：用户在问卷列表点击"删除"时，后端开启数据库事务，查询问卷完整数据并转为JSON对象，在RecycleBin表创建记录保存surveyData、originalStatus、deletedAt 等字段，然后从Survey表删除原问卷记录，提交事务返回"问卷已移至回收站"。用户访问回收站页面时，前端调用getRecycleBinApi()获取数据，后端按删除时间倒序返回回收站列表（非管理员仅看自己的），前端计算剩余天数(30天-已过天数)并判断是否即将过期(≤7天)。恢复问卷时，从surveyData提取完整数据调用创建问卷接口，将问卷的数据拷贝一份到问卷列表中去，再调用永久删除接口删除该记录。

时序图描述
用户 → 问卷列表页面: 点击"删除"按钮
问卷列表页面 → API层: deleteSurveyApi(surveyId)
API层 → 后端API: DELETE /surveys/:id
后端API → surveyController: 调用 deleteSurvey
surveyController → MySQL: 开启事务并查询问卷完整数据
MySQL → surveyController: 返回问卷数据
surveyController → MySQL: 在 RecycleBin 表创建记录，从 Survey 表删除原问卷
surveyController → MySQL: 提交事务
surveyController → API层: 返回操作结果
API层 → 问卷列表页面: 返回成功
问卷列表页面 → 用户: 显示"问卷已移至回收站"提示

用户 → 回收站页面: 点击"恢复"按钮
回收站页面 → API层: createSurveyApi(restoreData)
API层 → 后端API: POST /surveys
后端API → MySQL: 创建新问卷记录(使用 surveyData，status为originalStatus)
MySQL → 后端API: 返回新问卷
回收站页面 → API层: deleteFromRecycleBinApi(survey.id)
API层 → 后端API: DELETE /recycleBin/:id
后端API → MySQL: 删除回收站记录
MySQL → 后端API: 返回成功
后端API → 回收站页面: 返回操作结果
回收站页面 → 用户: 显示"问卷恢复成功"提示

用户 → 回收站页面: 点击"永久删除"按钮
回收站页面 → API层: deleteFromRecycleBinApi(id)
API层 → 后端API: DELETE /recycleBin/:id
后端API → MySQL: 查询并执行 destroy() 真删除
MySQL → 后端API: 返回成功
后端API → 回收站页面: 返回操作结果
回收站页面 → 用户: 显示"问卷已永久删除"提示

***时序图描述***
用户 → 前端界面: 触发删除/恢复/永久删除操作
前端界面 → 后端API: 调用对应接口(DELETE/POST)
后端API → MySQL: 执行软删除/恢复/真删除操作
MySQL → 后端API: 返回操作结果
后端API → 前端界面: 返回数据或操作结果
前端界面 → 用户: 显示对应提示信息
***end***

***时序图最新描述***
    用户->>前端问卷管理页面: ① 点击"删除问卷"按钮
    前端问卷管理页面->>API层(survey.js): ② 调用删除问卷接口
    API层(survey.js)->>后端路由(surveys.js): ③ DELETE /surveys/:id
    后端路由(surveys.js)->>控制器(surveyController.js): ④ 调用deleteSurvey方法
    控制器(surveyController.js)->>数据库: ⑤ 创建RecycleBin记录并软删除Survey
    数据库-->>控制器(surveyController.js): ⑥ 返回操作结果
    控制器(surveyController.js)-->>前端问卷管理页面: ⑦ 返回成功消息
    前端问卷管理页面->>用户: ⑧ 显示"问卷已移至回收站"提示
    用户->>前端回收站页面: ⑨ 点击"恢复"按钮
    前端回收站页面->>API层(survey.js): ⑩ 调用创建问卷接口
    API层(survey.js)->>后端路由(surveys.js): ⑪ POST /surveys (使用surveyData恢复)
    后端路由(surveys.js)->>数据库: ⑫ 创建新问卷记录
    数据库-->>后端路由(surveys.js): ⑬ 返回新问卷
    前端回收站页面->>API层(recycleBin.js): ⑭ 调用删除回收站记录接口
    API层(recycleBin.js)->>后端路由(recycleBin.js): ⑮ DELETE /recycleBin/:id
    后端路由(recycleBin.js)->>数据库: ⑯ 删除RecycleBin记录
    数据库-->>前端回收站页面: ⑰ 返回操作结果
    前端回收站页面->>用户: ⑱ 显示"问卷恢复成功"提示
    用户->>前端回收站页面: ⑲ 点击"永久删除"按钮
    前端回收站页面->>API层(recycleBin.js): ⑳ 调用永久删除接口
    API层(recycleBin.js)->>后端路由(recycleBin.js): ㉑ DELETE /recycleBin/:id
    后端路由(recycleBin.js)->>数据库: ㉒ 执行destroy()真删除
    数据库-->>后端路由(recycleBin.js): ㉓ 返回删除结果
    后端路由(recycleBin.js)-->>前端回收站页面: ㉔ 返回成功响应
    前端回收站页面->>用户: ㉕ 显示"问卷已永久删除"提示
***end***


2、接口定义
表 5-15 问卷回收站管理接口表

接口名称 获取回收站列表接口
接口描述 查询回收站列表，非管理员仅查看自己的回收站项
URL {{baseurl}}/recycleBin?userId={userId}
method GET
请求参数 {"userId": "user_123"} (可选，管理员可用)
返回参数 {"success": true, "data": [{"id": "rb_1701234567890", "surveyId": "survey_123", "title": "用户体验调查", "originalStatus": "published", "deletedAt": "2024-01-15T10:30:00.000Z", "surveyData": {...}}, ...]}

接口名称 删除问卷接口（移入回收站）
接口描述 软删除问卷，将问卷移至回收站
URL {{baseurl}}/surveys/:id
method DELETE
请求参数 路径参数: id（问卷ID）
返回参数 {"success": true, "message": "问卷已移至回收站"}

接口名称 永久删除问卷接口
接口描述 从回收站永久删除问卷，数据无法恢复
URL {{baseurl}}/recycleBin/:id
method DELETE
请求参数 路径参数: id（回收站记录ID）
返回参数 {"success": true, "message": "永久删除成功"}

3、关键代码
代码 5-15 问卷回收站管理核心代码
// 软删除：写入回收站，删除原问卷
exports.deleteSurvey = async (req, res) => {
  const t = await sequelize.transaction();
  try {
    const survey = await Survey.findByPk(req.params.id);
    await RecycleBin.create({
      id: `rb_${Date.now()}`,
      surveyId: survey.id,
      title: survey.title,
      originalStatus: survey.status,
      surveyData: survey.toJSON(),
      userId: survey.userId,
      deletedAt: new Date(),
    }, { transaction: t });

    await survey.destroy({ transaction: t });
    await t.commit();
    res.json({ success: true, message: "问卷已移至回收站" });
  } catch (e) {
    await t.rollback();
    res.status(500).json({ success: false });
  }
};

// 获取回收站列表
router.get("/", authenticate, async (req, res) => {
  const where = req.user.role === "admin" ? {} : { userId: req.user.id };
  const list = await RecycleBin.findAll({ where, order: [["deletedAt", "DESC"]] });
  res.json({ success: true, data: list });
});

// 永久删除问卷
router.delete("/:id", authenticate, async (req, res) => {
  const item = await RecycleBin.findByPk(req.params.id);
  await item.destroy();
  res.json({ success: true, message: "永久删除成功" });
});

// 恢复问卷
async function restoreSurvey(item) {
  await createSurveyApi({ ...item.surveyData, status: item.originalStatus });
  await deleteFromRecycleBinApi(item.id);
}

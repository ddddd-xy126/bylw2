# 问卷回收站管理

## 功能描述

问卷回收站是问卷管理系统的安全机制,用于暂存已删除的问卷,防止误删导致数据永久丢失。用户删除问卷后,问卷不会立即从数据库中删除,而是移动到回收站(RecycleBin表),保留30天后自动清理。在此期间,用户可以随时恢复问卷到原状态,或选择永久删除。

主要功能特性:
- **软删除机制**: 删除问卷时自动移入回收站,保留完整的问卷数据
- **30天保留期**: 问卷在回收站保留30天,超期自动清理
- **恢复功能**: 支持单个恢复和批量恢复,恢复后问卷回到删除前的状态(草稿/待审核/已发布)
- **永久删除**: 支持从回收站永久删除问卷,删除后数据无法恢复
- **过期提醒**: 剩余7天及以下的问卷显示过期警告
- **批量操作**: 支持全选、批量恢复、批量永久删除
- **快捷键支持**: Ctrl+A全选、Ctrl+R恢复、Del删除、Esc取消

## 代码逻辑

### 1. 软删除流程

用户在问卷列表点击"删除"时:
1. 调用 `deleteSurvey` 接口,传入问卷ID
2. 后端开启数据库事务
3. 查询问卷完整数据,转为JSON对象
4. 在 RecycleBin 表创建记录:
   - `id`: 生成新ID (`rb_${Date.now()}`)
   - `surveyId`: 原问卷ID
   - `surveyData`: 完整问卷数据(JSON格式)
   - `originalStatus`: 删除前的状态
   - `deletedBy`: 删除操作者ID
   - `deletedAt`: 删除时间
5. 从 Survey 表删除原问卷记录
6. 提交事务,返回"问卷已移至回收站"

### 2. 查看回收站列表

用户访问回收站页面:
1. 调用 `getRecycleBinApi()` 获取回收站数据
2. 后端查询 RecycleBin 表,按删除时间倒序排列
3. 非管理员只能查看 `userId` 等于自己ID的记录
4. 前端接收数据后计算每个问卷的:
   - 剩余天数 = 30 - (当前时间 - 删除时间) / 24小时
   - 是否即将过期(剩余≤7天)
5. 渲染问卷列表,显示标题、分类、删除时间、剩余天数、原状态等信息

### 3. 恢复问卷

用户点击"恢复"按钮:
1. 弹出确认对话框,提示将恢复到原状态
2. 从回收站记录的 `surveyData` 字段提取完整问卷数据
3. 调用 `createSurveyApi` 重新创建问卷:
   - 使用原问卷的所有字段(标题、题目、分类等)
   - `status` 设置为 `originalStatus`(恢复到删除前状态)
   - 生成新的问卷ID
4. 调用 `deleteFromRecycleBinApi` 从回收站删除该记录
5. 刷新回收站列表,显示"问卷恢复成功"

注意: 恢复后的问卷会生成新ID,与原问卷ID不同

### 4. 永久删除

用户点击"永久删除"按钮:
1. 弹出警告对话框,提示"此操作不可撤销"
2. 用户确认后调用 `deleteFromRecycleBinApi(id)`
3. 后端从 RecycleBin 表中执行 `destroy()` 真删除
4. 数据被永久清除,无法恢复
5. 刷新回收站列表

### 5. 批量操作

**全选功能**:
- 勾选页面顶部的"全选"复选框
- 更新 `selectedIds` 数组为当前页所有问卷ID
- 批量操作按钮显示选中数量徽章

**批量恢复**:
- 遍历 `selectedIds` 数组
- 对每个问卷执行恢复流程
- 显示进度提示 "正在恢复问卷... (3/10)"
- 统计成功和失败数量
- 完成后显示汇总结果

**批量永久删除**:
- 弹出二次确认对话框
- 遍历 `selectedIds` 执行删除
- 显示进度和统计信息

### 6. 过期计算与提醒

计算剩余天数:
```javascript
const deleteTime = new Date(deletedAt);
const expiryTime = new Date(deleteTime.getTime() + 30 * 24 * 60 * 60 * 1000);
const remaining = Math.ceil((expiryTime - Date.now()) / (1000 * 60 * 60 * 24));
```

显示逻辑:
- 剩余 ≤ 7天: 显示橙色/红色"即将过期"标签
- 剩余 ≤ 7天: 显示警告提示框
- 统计卡片显示"即将过期"问卷数量

### 7. RecycleBin数据模型

RecycleBin表字段:
- `id`: 回收站记录ID (主键)
- `surveyId`: 原问卷ID
- `title`: 问卷标题
- `description`: 问卷描述
- `category`: 问卷分类
- `originalStatus`: 删除前状态 (draft/pending/published)
- `questions`: 题目数量
- `userId`: 问卷作者ID
- `surveyData`: 完整问卷数据(JSON,包含questionList等所有字段)
- `deletedBy`: 删除操作者ID
- `deletedAt`: 删除时间

## 时序图描述

### 删除问卷到回收站(软删除)

```
用户 → 问卷列表页面: 点击某个问卷的"删除"按钮
问卷列表页面 → 确认对话框: 弹出"确定删除"对话框
用户 → 确认对话框: 点击"确定"
确认对话框 → API层(survey.js): deleteSurveyApi(surveyId)
API层 → 后端路由: DELETE /surveys/:id
后端路由 → surveyController.deleteSurvey: 调用删除方法
surveyController.deleteSurvey → 数据库: 开启事务
surveyController.deleteSurvey → Survey表: findByPk(id)查询问卷完整数据
Survey表 → surveyController.deleteSurvey: 返回问卷数据survey
surveyController.deleteSurvey → surveyController.deleteSurvey: 转换为JSON对象surveyData
surveyController.deleteSurvey → RecycleBin表: create记录(包含surveyData, originalStatus, deletedAt)
surveyController.deleteSurvey → Survey表: destroy()删除原问卷
surveyController.deleteSurvey → 数据库: 提交事务
surveyController.deleteSurvey → 后端路由: 返回{success: true, message: "问卷已移至回收站"}
后端路由 → API层: 返回成功
API层 → 问卷列表页面: 返回删除结果
问卷列表页面 → 用户: 显示"问卷已移至回收站"提示
问卷列表页面 → 问卷列表页面: 刷新列表,该问卷从列表中消失
```

### 从回收站恢复问卷

```
用户 → 回收站页面: 点击某个问卷的"恢复"按钮
回收站页面 → 确认对话框: 弹出"确认恢复"对话框,显示原状态
用户 → 确认对话框: 点击"确定恢复"
确认对话框 → 回收站页面: 执行restoreSurvey方法
回收站页面 → 回收站页面: 从survey.surveyData提取完整问卷数据
回收站页面 → API层(survey.js): createSurveyApi(restoreData)
API层 → 后端路由: POST /surveys
后端路由 → surveyController.createSurvey: 调用创建问卷方法
surveyController.createSurvey → 数据库: 开启事务
surveyController.createSurvey → Survey表: create新问卷记录(使用恢复的数据)
surveyController.createSurvey → Survey表: 设置status为originalStatus
surveyController.createSurvey → 数据库: 提交事务
surveyController.createSurvey → 后端路由: 返回新创建的问卷
后端路由 → API层: 返回{success: true, data: survey}
API层 → 回收站页面: 返回创建成功
回收站页面 → API层(survey.js): deleteFromRecycleBinApi(survey.id)
API层 → 后端路由: DELETE /recycleBin/:id
后端路由 → RecycleBin表: destroy()删除回收站记录
后端路由 → API层: 返回{success: true}
API层 → 回收站页面: 返回删除成功
回收站页面 → 回收站页面: 刷新回收站列表
回收站页面 → 用户: 显示"问卷恢复成功"提示
```

### 批量恢复问卷

```
用户 → 回收站页面: 勾选多个问卷复选框
回收站页面 → 回收站页面: 更新selectedIds数组
用户 → 回收站页面: 点击"批量恢复"按钮
回收站页面 → 确认对话框: 弹出"确定恢复X个问卷"对话框
用户 → 确认对话框: 点击"确定恢复"
确认对话框 → 回收站页面: 执行batchRestore方法
回收站页面 → 回收站页面: 显示进度提示"正在恢复问卷...(0/5)"
回收站页面 → 循环遍历: 遍历selectedIds数组
循环遍历 → 单个问卷: 执行restoreSurvey逻辑(创建+删除)
单个问卷 → API层: createSurveyApi + deleteFromRecycleBinApi
API层 → 后端: 创建问卷 + 删除回收站记录
后端 → API层: 返回成功
API层 → 循环遍历: 成功计数+1,更新进度提示"(1/5)"
循环遍历 → 单个问卷: 处理下一个问卷
循环遍历 → 回收站页面: 所有问卷处理完成
回收站页面 → 回收站页面: 关闭进度提示
回收站页面 → 回收站页面: 刷新列表,清空selectedIds
回收站页面 → 用户: 显示汇总"成功恢复5个问卷"或"成功3个,失败2个"
```

### 永久删除问卷

```
用户 → 回收站页面: 点击某个问卷的"永久删除"按钮
回收站页面 → 警告对话框: 弹出"此操作不可撤销"警告
用户 → 警告对话框: 点击"确定删除"
警告对话框 → 回收站页面: 执行permanentlyDelete方法
回收站页面 → API层(survey.js): deleteFromRecycleBinApi(id)
API层 → 后端路由: DELETE /recycleBin/:id
后端路由 → RecycleBin表: findByPk(id)查询记录
RecycleBin表 → 后端路由: 返回回收站记录
后端路由 → RecycleBin表: destroy()真删除
RecycleBin表 → 后端路由: 删除成功
后端路由 → API层: 返回{success: true, message: "永久删除成功"}
API层 → 回收站页面: 返回删除结果
回收站页面 → 回收站页面: 刷新回收站列表
回收站页面 → 用户: 显示"问卷已永久删除"提示
```

## 接口定义

### 1. 获取回收站列表

**接口**: `GET /recycleBin`

**请求头**: `Authorization: Bearer <token>`

**查询参数**:
- `userId` (string, 可选) - 筛选指定用户的回收站项,管理员可用

**权限**: 用户只能查看自己的回收站,管理员可查看所有

**响应数据**:
```json
{
  "success": true,
  "data": [
    {
      "id": "rb_1701234567890",
      "surveyId": "survey_123",
      "title": "用户体验调查问卷",
      "description": "了解用户对产品的使用体验",
      "category": "用户研究",
      "originalStatus": "published",
      "questions": 10,
      "userId": "user_123",
      "deletedBy": "user_123",
      "deletedAt": "2024-01-15T10:30:00.000Z",
      "surveyData": {
        "id": "survey_123",
        "title": "用户体验调查问卷",
        "questionList": [...],
        "status": "published",
        "participantCount": 150,
        "averageRating": "4.50",
        ...
      }
    }
  ]
}
```

### 2. 删除问卷(移入回收站)

**接口**: `DELETE /surveys/:id`

**请求头**: `Authorization: Bearer <token>`

**权限**: 问卷作者或管理员

**响应数据**:
```json
{
  "success": true,
  "message": "问卷已移至回收站"
}
```

### 3. 永久删除问卷

**接口**: `DELETE /recycleBin/:id`

**请求头**: `Authorization: Bearer <token>`

**请求参数**:
- Path参数: `id` (string) - 回收站记录ID

**权限**: 记录所有者或管理员

**响应数据**:
```json
{
  "success": true,
  "message": "永久删除成功"
}
```

### 4. 恢复问卷(创建新问卷)

**接口**: `POST /surveys` (重新创建问卷)

**说明**: 恢复操作分两步:
1. 调用创建问卷接口,传入从 `surveyData` 提取的数据
2. 调用删除回收站记录接口,清除回收站项

**请求参数**: 参考问卷创建接口,使用 `surveyData` 中的完整数据

## 关键代码

### 后端 - 软删除问卷到回收站 (surveyController.js)

```javascript
exports.deleteSurvey = async (req, res, next) => {
  const t = await sequelize.transaction();

  try {
    const { id } = req.params;

    const survey = await Survey.findByPk(id);

    if (!survey) {
      await t.rollback();
      return res.status(404).json({
        success: false,
        message: "问卷不存在",
      });
    }

    // 检查权限
    if (survey.userId !== req.user.id && req.user.role !== "admin") {
      await t.rollback();
      return res.status(403).json({
        success: false,
        message: "无权删除此问卷",
      });
    }

    // 将问卷移到回收站
    const RecycleBin = require("../models").RecycleBin;
    const surveyData = survey.toJSON();
    await RecycleBin.create(
      {
        id: `rb_${Date.now()}`,
        surveyId: survey.id,
        title: survey.title,
        description: survey.description,
        category: survey.category,
        originalStatus: survey.status,
        questions: survey.questions,
        userId: survey.userId,
        authorId: survey.userId,
        surveyData: surveyData, // 保存完整问卷数据
        deletedBy: req.user.id,
        deletedAt: new Date(),
      },
      { transaction: t }
    );

    // 从Survey表删除
    await survey.destroy({ transaction: t });

    await t.commit();

    res.json({
      success: true,
      message: "问卷已移至回收站",
    });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};
```

### 后端 - 获取回收站列表 (recycleBin.js)

```javascript
router.get("/", authenticate, async (req, res, next) => {
  try {
    const { userId } = req.query;

    const where = {};
    if (userId) {
      where.userId = userId;
    } else if (req.user.role !== "admin") {
      // 非管理员只能看到自己的回收站
      where.userId = req.user.id;
    }

    const items = await RecycleBin.findAll({
      where,
      order: [["deletedAt", "DESC"]],
    });

    res.json({
      success: true,
      data: items,
    });
  } catch (error) {
    next(error);
  }
});
```

### 后端 - 永久删除 (recycleBin.js)

```javascript
router.delete("/:id", authenticate, async (req, res, next) => {
  try {
    const item = await RecycleBin.findByPk(req.params.id);

    if (!item) {
      return res.status(404).json({
        success: false,
        message: "回收站项不存在",
      });
    }

    // 真删除
    await item.destroy();

    res.json({
      success: true,
      message: "永久删除成功",
    });
  } catch (error) {
    next(error);
  }
});
```

### 前端 - 恢复问卷 (TrashPage.vue)

```javascript
const restoreSurvey = async (survey) => {
  try {
    await ElMessageBox.confirm(
      `确定要恢复问卷"${survey.title}"吗？恢复后问卷将回到${getOriginalStatus(
        survey.originalStatus
      )}状态。`,
      "确认恢复",
      {
        confirmButtonText: "确定恢复",
        cancelButtonText: "取消",
        type: "success",
      }
    );

    // 从surveyData提取完整问卷数据
    const restoreData = {
      title: survey.surveyData.title || survey.title,
      description: survey.surveyData.description || survey.description,
      category: survey.surveyData.category || survey.category,
      categoryId: survey.surveyData.categoryId,
      author: survey.surveyData.author,
      authorId: survey.surveyData.authorId || survey.authorId,
      questions: survey.surveyData.questions || survey.questions,
      duration: survey.surveyData.duration,
      status: survey.originalStatus, // 恢复到删除前的状态
      tags: survey.surveyData.tags || [],
      questionList: survey.surveyData.questionList || [],
      averageRating: survey.surveyData.averageRating || 0,
      participantCount: survey.surveyData.participantCount || 0,
    };

    // 重新创建问卷
    await createSurveyApi(restoreData);

    // 从回收站删除
    await deleteFromRecycleBinApi(survey.id);

    ElMessage.success("问卷恢复成功");
    await loadTrashedSurveys();
  } catch (error) {
    if (error !== "cancel") {
      console.error("恢复问卷失败:", error);
      ElMessage.error("恢复失败：" + error.message);
    }
  }
};
```

### 前端 - 计算剩余天数与过期提醒 (TrashPage.vue)

```javascript
const getRemainingDays = (deletedAt) => {
  const deleteTime = new Date(deletedAt);
  const expiryTime = new Date(deleteTime.getTime() + 30 * 24 * 60 * 60 * 1000);
  const remaining = Math.ceil(
    (expiryTime - Date.now()) / (1000 * 60 * 60 * 24)
  );
  return Math.max(0, remaining);
};

const isExpiringSoon = (deletedAt) => {
  return getRemainingDays(deletedAt) <= 7;
};

const getExpiryText = (deletedAt) => {
  const days = getRemainingDays(deletedAt);
  if (days === 0) return "今天过期";
  if (days <= 7) return `${days}天后过期`;
  return `${days}天后过期`;
};
```

### 前端 - 批量恢复 (TrashPage.vue)

```vue
<template>
  <el-button
    type="primary"
    :disabled="selectedIds.length === 0"
    @click="batchRestore"
  >
    批量恢复
    <el-badge v-if="selectedIds.length > 0" :value="selectedIds.length" />
  </el-button>
</template>

<script>
const batchRestore = async () => {
  if (selectedIds.value.length === 0) {
    ElMessage.warning("请先选择要恢复的问卷");
    return;
  }

  try {
    await ElMessageBox.confirm(
      `确定要恢复选中的 ${selectedIds.value.length} 个问卷吗？恢复后问卷将回到各自的原状态。`,
      "批量恢复",
      {
        confirmButtonText: "确定恢复",
        cancelButtonText: "取消",
        type: "success",
      }
    );

    loading.value = true;
    let successCount = 0;
    let failCount = 0;
    const totalCount = selectedIds.value.length;

    // 显示进度
    const progressMessage = ElMessage({
      message: `正在恢复问卷... (0/${totalCount})`,
      type: "info",
      duration: 0,
    });

    // 遍历恢复
    for (let i = 0; i < selectedIds.value.length; i++) {
      const id = selectedIds.value[i];
      const survey = trashedSurveys.value.find((s) => s.id === id);
      
      try {
        const restoreData = {
          title: survey.surveyData.title,
          status: survey.originalStatus,
          questionList: survey.surveyData.questionList,
          ...survey.surveyData,
        };
        
        await createSurveyApi(restoreData);
        await deleteFromRecycleBinApi(id);
        successCount++;
      } catch (error) {
        console.error(`恢复问卷 ${id} 失败:`, error);
        failCount++;
      }
      
      // 更新进度
      progressMessage.message = `正在恢复问卷... (${i + 1}/${totalCount})`;
    }

    progressMessage.close();
    
    // 显示结果
    if (failCount === 0) {
      ElMessage.success(`成功恢复 ${successCount} 个问卷`);
    } else {
      ElMessage.warning(`成功恢复 ${successCount} 个，失败 ${failCount} 个`);
    }

    selectedIds.value = [];
    await loadTrashedSurveys();
  } catch (error) {
    if (error !== "cancel") {
      ElMessage.error("批量恢复失败");
    }
  } finally {
    loading.value = false;
  }
};
</script>
```

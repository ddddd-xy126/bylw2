问卷浏览与搜索
1、简要描述
（1）功能描述:用户可以在问卷列表页面浏览平台上所有公开的问卷，并通过搜索框和分类按钮进行筛选。列表页面显示问卷的标题、描述、分类、参与人数、评分等信息，用户可以点击问卷卡片查看详情或开始答题。

（2）代码逻辑:
用户进入问卷列表页面（/surveys 路由），组件在 onMounted 生命周期钩子中调用 loadData 函数加载问卷列表和分类数据。系统通过调用 listSurveys 接口获取所有已发布且正在收集的问卷，通过 getCategoriesApi 接口获取所有分类信息，将数据存储到 Pinia store 中。页面渲染时，从 store 读取问卷列表，过滤出状态为 published 且 isCollecting 不为 false 的问卷进行展示。用户可以在搜索框中输入关键词，系统会实时过滤问卷标题、描述和标签中包含该关键词的问卷。用户也可以点击分类按钮，系统根据所选分类的 categoryId 过滤问卷列表。过滤后的问卷列表会按照当前排序方式（最新、最热、推荐）进行排序，并通过分页组件展示，每页显示 12 条问卷。用户点击问卷卡片时，系统路由跳转到问卷详情页（/surveys/:id）。

###问卷浏览与搜索时序图描述
用户 → List.vue: 进入问卷列表页面（/surveys 路由）
List.vue → List.vue: onMounted 生命周期钩子调用 loadData
loadData → 后端 /surveys: 发送 GET 请求获取问卷列表
后端 /surveys → surveyController.js: 调用 getSurveys 方法
surveyController.js → MySQL: 查询 surveys 表（status=published, isCollecting=true）
MySQL → surveyController.js: 返回问卷列表
surveyController.js → loadData: 返回问卷数据
loadData → 后端 /categories: 发送 GET 请求获取分类列表
后端 /categories → categoryController.js: 调用 getCategories 方法
categoryController.js → MySQL: 查询 categories 表
MySQL → categoryController.js: 返回分类列表
categoryController.js → loadData: 返回分类数据
loadData → Pinia store: 存储问卷和分类数据
List.vue → Pinia store: 读取问卷和分类数据
List.vue → List.vue: 过滤并渲染问卷列表
用户 → List.vue: 输入搜索关键词或选择分类
List.vue → List.vue: 实时过滤问卷列表（搜索/分类）
List.vue → 用户界面: 更新展示的问卷列表

2、接口定义
表 5-5 问卷浏览与搜索接口表
接口名称       获取问卷列表接口
接口描述       获取所有已发布的问卷列表，支持按状态、分类、搜索关键词等筛选
URL           {{baseurl}}/surveys
method        GET
请求参数       status: 问卷状态（published），categoryId: 分类ID，search: 搜索关键词，page: 页码，limit: 每页数量
返回参数        [{"id": "1", "title": "问卷标题", "description": "问卷描述", "categoryId": "1", "status": "published", "participantCount": 100, "averageRating": 4.5, ...}, ...]

接口名称       获取分类列表接口
接口描述       获取所有问卷分类，用于分类筛选按钮展示
URL           {{baseurl}}/categories
method        GET
请求参数       无
返回参数        [{"id": "1", "name": "教育培训", "slug": "education", ...}, ...]

3、关键代码
代码 5-5 问卷浏览与搜索核心实现代码

// 加载问卷和分类数据（useHomeLogic.js）
const loadData = async () => {
  loading.value = true;
  try {
    // 并发请求问卷列表和分类列表
    const [surveysData, categoriesData] = await Promise.all([
      listSurveys(),
      getCategoriesApi(),
    ]);

    // 存储到 Pinia store
    dataStore.setSurveys(surveysData || []);
    dataStore.setCategories(categoriesData || []);

    console.log("问卷列表已加载:", surveysData?.length || 0);
    console.log("分类列表已加载:", categoriesData?.length || 0);
  } catch (error) {
    console.error("加载数据失败:", error);
    ElMessage.error("加载数据失败");
  } finally {
    loading.value = false;
  }
};

// 搜索处理（List.vue）
const handleSearch = () => {
  currentPage.value = 1; // 重置页码
  // searchQuery 变化会触发 computed 重新计算
};

// 选择分类（List.vue）
const selectCategory = (catId) => {
  selectedCategory.value = catId;
  currentPage.value = 1; // 重置页码
  handleCategoryChange();
};

// 过滤和排序逻辑（List.vue）
const surveysToShow = computed(() => {
  const list = Array.isArray(surveys.value)
    ? surveys.value.filter(
        (s) => s.status === "published" && s.isCollecting !== false
      )
    : [];

  // 分类过滤
  let filtered = list;
  if (selectedCategory.value) {
    filtered = list.filter((s) => {
      const sid = getSurveyCategoryId(s);
      return sid ? sid === String(selectedCategory.value) : false;
    });
  }

  // 排序逻辑
  const result = [...filtered];
  switch (sortBy.value) {
    case "latest":
      result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      break;
    case "hot":
      result.sort(
        (a, b) => (b.participantCount || 0) - (a.participantCount || 0)
      );
      break;
  }
  return result;
});

// 后端获取问卷列表（surveyController.js）
exports.getSurveys = async (req, res, next) => {
  try {
    const { status, categoryId, search, sortBy = "createdAt", order = "DESC", page = 1, limit = 10 } = req.query;

    const where = {};
    if (status) where.status = status;
    if (categoryId) where.categoryId = categoryId;
    if (search) {
      where[Op.or] = [
        { title: { [Op.like]: `%${search}%` } },
        { description: { [Op.like]: `%${search}%` } },
      ];
    }

    const surveys = await Survey.findAndCountAll({
      where,
      include: [
        { model: User, as: "creator", attributes: ["id", "username", "avatar"] },
        { model: Category, as: "categoryInfo", attributes: ["id", "name", "slug"] },
      ],
      limit: parseInt(limit),
      offset: (page - 1) * limit,
      order: [[sortBy, order.toUpperCase()]],
    });

    res.json({ success: true, data: surveys.rows });
  } catch (error) {
    next(error);
  }
};

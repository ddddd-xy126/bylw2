修改个人信息
1、简要描述
（1）功能描述：用户可以在个人中心修改个人基本信息、头像和修改，包含用户名、邮箱、手机号、性别、年龄、城市、职业、个人简介和兴趣标签等基本信息。

（2）代码逻辑：
用户进入个人中心的个人信息页面，系统从Pinia store加载当前用户的基本信息并渲染到表单中。用户在个人中心页面，修改表单中的各项信息或者头像、密码后点击保存。前端对表单数据进行验证，验证通过后将更新数据通过HTTP请求发送到后端。后端接收请求后，验证用户登录状态，更新数据库中的用户记录，并检查资料完整度。若用户之前资料不完整，此次更新后达到100%完整度（所有必填字段均有值），系统自动为用户增加15积分，并记录积分历史。后端返回更新成功的响应，前端更新Pinia store中的用户信息，退出编辑模式，并显示成功提示（若获得积分则提示积分奖励信息）。

###修改个人信息时序图描述
用户 → InfoPage.vue: 点击保存按钮
InfoPage.vue → InfoPage.vue: 校验表单数据，检查资料完整度
InfoPage.vue → user.js: 调用修改个人信息接口
user.js → 后端API: 发送修改请求
后端API → auth.js: 验证Token有效性
auth.js → MySQL: 查询用户记录
auth.js → 后端API: 验证通过，获取用户信息
后端API → userController.js: 处理更新请求
userController.js → MySQL: 更新用户记录
MySQL → userController.js: 返回更新结果
userController.js → user.js: 返回成功响应和用户数据
user.js → InfoPage.vue: 返回更新后的用户信息
InfoPage.vue → userStore: 更新本地用户数据
InfoPage.vue → 用户: 显示成功提示

***时序图最新描述***
    用户->>前端InfoPage.vue: ① 点击保存按钮
    前端InfoPage.vue->>前端InfoPage.vue: ② 校验表单数据，检查资料完整度
    前端InfoPage.vue->>API层(user.js): ③ 调用修改个人信息接口
    API层(user.js)->>后端路由(users.js): ④ PATCH /users/:id
    后端路由(users.js)->>认证中间件(auth.js): ⑤ 验证Token有效性
    认证中间件(auth.js)->>数据库: ⑥ 查询用户记录
    数据库-->>认证中间件(auth.js): ⑦ 返回用户信息
    认证中间件(auth.js)->>控制器(userController.js): ⑧ 验证通过
    控制器(userController.js)->>数据库: ⑨ 更新用户记录
    数据库-->>控制器(userController.js): ⑩ 返回更新结果
    控制器(userController.js)-->>前端InfoPage.vue: ⑪ 返回成功响应
    前端InfoPage.vue->>Pinia(userStore): ⑫ 更新本地用户数据
    前端InfoPage.vue-->>用户: ⑬ 显示成功提示
***end***

2、接口定义
表 5-3 修改个人信息接口表
接口名称       更新用户资料接口
接口描述       用户更新个人信息时调用接口，支持修改基本信息、头像、密码
URL           {{baseurl}}/users/:id
method        PUT
请求参数       {"username": "newname", "email": "new@example.com", "phone": "13800138000", "gender": "male", "age": 25, "city": "北京", "profession": "工程师", "bio": "个人简介", "tags": ["技术", "旅行"], "avatar": "https://...", "password": "newpassword123"}
返回参数        {"success": true, "message": "资料更新成功", "data": {"id": "123", "username": "newname", "email": "new@example.com", ...}}

3、关键代码
代码 5-3 修改个人信息核心实现代码
// 更新用户资料（userController.js）
exports.updateUser = async (req, res, next) => {
  try {
    const userId = req.params.id;
    const updates = req.body;

    // 不允许修改敏感字段
    delete updates.id;
    delete updates.role;

    const user = await User.findByPk(userId);
    if (!user) {
      return res.status(404).json({
        success: false,
        message: "用户不存在",
      });
    }

    // 如果更新密码，会触发 User Model 的 beforeUpdate hook 自动加密
    await user.update(updates);

    res.json({
      success: true,
      data: user.toSafeObject(),
    });
  } catch (error) {
    next(error);
  }
};

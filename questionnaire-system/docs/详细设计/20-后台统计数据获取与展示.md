# 后台统计数据获取与展示

## 1、简要描述

### （1）功能描述
后台统计数据获取与展示功能为管理员提供系统运营的全局数据视图,通过聚合查询用户、问卷、答题、评论等核心业务数据,生成仪表板统计报表。管理员可在后台首页查看系统总体数据(总用户数、总问卷数、总答题数、待审核问卷数等),以及最近7天的增长趋势数据,帮助管理员快速掌握系统运营状态、用户活跃度和内容生产情况。

统计数据包括两大类:总体统计(累计数据)和近期统计(时间范围内的增量数据)。系统通过并发查询多个数据表,使用聚合函数COUNT统计记录数,并根据时间范围条件筛选近期数据,最终将统计结果按类别整合返回给前端。前端接收数据后,使用图表组件(如ECharts、Element Plus统计卡片)进行可视化展示,支持数据卡片、折线图、柱状图等多种展示形式。

### （2）代码逻辑
管理员访问后台首页时,前端自动调用 `GET /api/admin/dashboard/stats` 接口获取统计数据。后端控制器使用Promise.all并发执行多个COUNT查询,分别统计User、Survey、Answer、Comment表的总记录数,以及状态为pending的问卷数量。

对于近期数据统计,后端计算当前时间前7天的日期节点,使用Sequelize的Op.gte(大于等于)操作符筛选createdAt或submittedAt字段在该时间范围内的记录,再执行COUNT查询。所有查询结果通过Promise.all并发执行,避免顺序查询导致的性能瓶颈。

后端将统计结果按total(总体统计)和recent(近期统计)两个维度分组,返回JSON响应。前端接收数据后,将数值绑定到仪表板组件的data属性,使用计算属性格式化展示(如千分位分隔、百分比增长率计算等),并通过图表库渲染可视化图表。

### 后台统计数据获取与展示时序图描述
```
管理员 → 后台首页: 访问管理后台首页
后台首页 → adminController: GET /api/admin/dashboard/stats
adminController → MySQL: 并发执行统计查询
    并发查询1: SELECT COUNT(*) FROM users
    并发查询2: SELECT COUNT(*) FROM surveys
    并发查询3: SELECT COUNT(*) FROM answers
    并发查询4: SELECT COUNT(*) FROM comments
    并发查询5: SELECT COUNT(*) FROM surveys WHERE status='pending'
    并发查询6: SELECT COUNT(*) FROM users WHERE createdAt >= 7天前
    并发查询7: SELECT COUNT(*) FROM surveys WHERE createdAt >= 7天前
    并发查询8: SELECT COUNT(*) FROM answers WHERE submittedAt >= 7天前
MySQL → adminController: 返回所有查询结果
adminController → adminController: 整合统计数据(total + recent)
adminController → 后台首页: 返回统计数据JSON
后台首页 → 图表组件: 渲染数据卡片和图表
图表组件 → 管理员: 显示仪表板统计视图
```

## 2、接口定义

**表 5-20 后台统计数据接口表**

| 接口名称 | 获取仪表板统计数据接口 |
|---------|-------------------|
| 接口描述 | 管理员访问后台首页时调用,获取系统总体统计和近期增长数据 |
| URL | {{baseurl}}/admin/dashboard/stats |
| method | GET |
| 请求参数 | 无 (需携带管理员Token) |
| 返回参数 | `{ "success": true, "data": { "total": { "users": 1523, "surveys": 342, "answers": 8976, "comments": 562, "pendingSurveys": 12 }, "recent": { "users": 45, "surveys": 23, "answers": 267 } } }` |

## 3、关键代码

**代码 5-20 后台统计数据获取核心实现代码**

```javascript
// 获取仪表板统计数据 (adminController.js)
exports.getDashboardStats = async (req, res, next) => {
  try {
    // 并发查询总体统计数据
    const [
      totalUsers,
      totalSurveys,
      totalAnswers,
      totalComments,
      pendingSurveys,
    ] = await Promise.all([
      User.count(),
      Survey.count(),
      Answer.count(),
      Comment.count(),
      Survey.count({ where: { status: "pending" } }),
    ]);

    // 计算最近7天的时间节点
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    // 并发查询近期统计数据
    const [recentUsers, recentSurveys, recentAnswers] = await Promise.all([
      User.count({ where: { createdAt: { [Op.gte]: sevenDaysAgo } } }),
      Survey.count({ where: { createdAt: { [Op.gte]: sevenDaysAgo } } }),
      Answer.count({ where: { submittedAt: { [Op.gte]: sevenDaysAgo } } }),
    ]);

    res.json({
      success: true,
      data: {
        total: {
          users: totalUsers,
          surveys: totalSurveys,
          answers: totalAnswers,
          comments: totalComments,
          pendingSurveys,
        },
        recent: {
          users: recentUsers,
          surveys: recentSurveys,
          answers: recentAnswers,
        },
      },
    });
  } catch (error) {
    next(error);
  }
};
```

ç§¯åˆ†ä¸Žæˆå°±å¾½ç« ç³»ç»Ÿ
1ã€ç®€è¦æè¿°
ï¼ˆ1ï¼‰åŠŸèƒ½æè¿°ï¼šç§¯åˆ†ä¸Žæˆå°±å¾½ç« ç³»ç»Ÿæ˜¯é—®å·å¹³å°çš„æ¿€åŠ±æœºåˆ¶ï¼Œé€šè¿‡ç»™äºˆç”¨æˆ·ç§¯åˆ†å¥–åŠ±å’Œè§£é”æˆå°±å¾½ç« ï¼Œé¼“åŠ±ç”¨æˆ·ç§¯æžå‚ä¸Žé—®å·å¡«å†™ã€åˆ›å»ºé—®å·ã€å®Œå–„èµ„æ–™ç­‰è¡Œä¸ºã€‚
ï¼ˆ2ï¼‰ä»£ç é€»è¾‘ï¼š
ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­æ‰§è¡Œå„ç±»æ“ä½œï¼ˆå¦‚æ³¨å†Œã€å®Œæˆé—®å·ã€åˆ›å»ºé—®å·ã€æäº¤å®¡æ ¸ç­‰ï¼‰æ—¶ï¼ŒåŽç«¯å¯¹åº”çš„æŽ§åˆ¶å™¨æ–¹æ³•ä¼šè°ƒç”¨User.increment('points', {by: pointsEarned})å¢žåŠ ç”¨æˆ·ç§¯åˆ†ï¼ŒåŒæ—¶åœ¨æ•°æ®åº“åˆ›å»ºPointHistoryè®°å½•ä¿å­˜ç§¯åˆ†æ•°é‡ã€åŽŸå› æè¿°ã€ç±»åž‹å’Œåˆ›å»ºæ—¶é—´ã€‚ç”¨æˆ·ç­‰çº§æ ¹æ®å½“å‰ç§¯åˆ†æ€»æ•°è‡ªåŠ¨è®¡ç®—ï¼Œå…¬å¼ä¸ºï¼šç­‰çº§= Math.floor(ç§¯åˆ†/500) + 1ï¼Œå‰ç«¯åœ¨ä¸ªäººæˆå°±é¡µé¢é€šè¿‡è®¡ç®—å®žæ—¶æ˜¾ç¤ºç”¨æˆ·ç­‰çº§ï¼Œæ— éœ€åŽç«¯å­˜å‚¨ã€‚ç³»ç»Ÿé¢„å®šä¹‰å¤šä¸ªæˆå°±å¾½ç« ï¼Œæ¯ä¸ªå¾½ç« æœ‰ç±»åž‹å’Œè¦æ±‚ã€‚ç”¨æˆ·çš„å·²è§£é”å¾½ç« IDå­˜å‚¨åœ¨Userè¡¨çš„unlockedBadgeså­—æ®µä¸­ã€‚ç”¨æˆ·è®¿é—®ä¸ªäººæˆå°±é¡µé¢æ—¶ï¼Œå‰ç«¯èŽ·å–æ‰€æœ‰å¾½ç« å®šä¹‰å’Œç”¨æˆ·çš„unlockedBadgesæ•°ç»„ï¼Œé€šè¿‡è®¡ç®—ç”¨æˆ·å½“å‰å„é¡¹ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚å·²å®Œæˆé—®å·æ•°ã€åˆ›å»ºé—®å·æ•°ã€è¿žç»­ç™»å½•å¤©æ•°ç­‰ï¼‰ï¼Œå¯¹æ¯”æ¯ä¸ªå¾½ç« çš„è¦æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°è§£é”æ¡ä»¶ã€‚è‹¥æ»¡è¶³æ¡ä»¶ä¸”ç”¨æˆ·æœªè§£é”è¯¥å¾½ç« ï¼Œå‰ç«¯è‡ªåŠ¨å°†å¾½ç« IDæ·»åŠ åˆ°unlockedBadgesæ•°ç»„å¹¶æ›´æ–°ç”¨æˆ·ç§¯åˆ†ï¼Œæ›´æ–°åŽçš„æ•°æ®åŒæ­¥åˆ°åŽç«¯ï¼ŒåŒæ—¶æ˜¾ç¤ºå¾½ç« è§£é”åŠ¨ç”»å’Œç§¯åˆ†å¥–åŠ±æç¤ºã€‚å‰ç«¯é¡µé¢æ ¹æ® unlockedBadgesæ•°ç»„å’Œå¾½ç« å®šä¹‰æ•°æ®ï¼Œå¯¹æ¯”æ˜¾ç¤ºæ¯ä¸ªå¾½ç« çš„è§£é”çŠ¶æ€å’Œè¿›åº¦ã€‚

**_æ—¶åºå›¾æè¿°_**

**æµç¨‹ä¸€ï¼šç”¨æˆ·æ“ä½œèŽ·å–ç§¯åˆ†**
ç”¨æˆ·->>å‰ç«¯é¡µé¢: â‘  æ‰§è¡Œç‰¹å®šæ“ä½œï¼ˆå®Œæˆé—®å·ã€åˆ›å»ºé—®å·ç­‰ï¼‰
å‰ç«¯é¡µé¢->>APIå±‚: â‘¡ è°ƒç”¨æ“ä½œç›¸å…³æŽ¥å£ï¼ˆå¦‚submitAnswerï¼‰
APIå±‚->>åŽç«¯è·¯ç”±: â‘¢ POSTè¯·æ±‚åˆ°å¯¹åº”è·¯ç”±
åŽç«¯è·¯ç”±->>æŽ§åˆ¶å™¨(å¦‚answerController.js): â‘£ è°ƒç”¨æŽ§åˆ¶å™¨æ–¹æ³•å¤„ç†ä¸šåŠ¡
æŽ§åˆ¶å™¨->>æ•°æ®åº“: â‘¤ åˆ›å»ºä¸šåŠ¡è®°å½•ï¼ˆAnswerç­‰ï¼‰ã€æ›´æ–°User.pointså­—æ®µã€åˆ›å»ºPointHistoryè®°å½•
æ•°æ®åº“-->>æŽ§åˆ¶å™¨: â‘¥ è¿”å›žæ“ä½œç»“æžœ
æŽ§åˆ¶å™¨-->>å‰ç«¯é¡µé¢: â‘¦ è¿”å›ž{success: true, pointsEarned: 10}
å‰ç«¯é¡µé¢->>ç”¨æˆ·: â‘§ æ˜¾ç¤ºæ“ä½œæˆåŠŸå’Œç§¯åˆ†èŽ·å–æç¤º

**æµç¨‹äºŒï¼šè®¿é—®æˆå°±é¡µé¢æŸ¥çœ‹ç§¯åˆ†åŽ†å²**
ç”¨æˆ·->>å‰ç«¯æˆå°±é¡µé¢(AchievementsPage.vue): â‘¨ è®¿é—®ä¸ªäººæˆå°±é¡µé¢
å‰ç«¯æˆå°±é¡µé¢->>APIå±‚: â‘© GET /badgesï¼ˆèŽ·å–æ‰€æœ‰å¾½ç« å®šä¹‰ï¼‰
APIå±‚->>åŽç«¯è·¯ç”±(badges.js): â‘ª è½¬å‘è¯·æ±‚
åŽç«¯è·¯ç”±->>æ•°æ®åº“: â‘« æŸ¥è¯¢Badgeè¡¨æ‰€æœ‰è®°å½•
æ•°æ®åº“-->>å‰ç«¯æˆå°±é¡µé¢: â‘¬ è¿”å›žå¾½ç« å®šä¹‰åˆ—è¡¨[{id, name, type, requirement, points}]
å‰ç«¯æˆå°±é¡µé¢->>APIå±‚: â‘­ GET /users/:idï¼ˆèŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
APIå±‚->>åŽç«¯è·¯ç”±(users.js): â‘® è½¬å‘è¯·æ±‚
åŽç«¯è·¯ç”±->>æ•°æ®åº“: â‘¯ æŸ¥è¯¢Userè¡¨ï¼ŒèŽ·å–pointså’ŒunlockedBadgeså­—æ®µ
æ•°æ®åº“-->>å‰ç«¯æˆå°±é¡µé¢: â‘° è¿”å›žç”¨æˆ·æ•°æ®{points, unlockedBadges: ["badge_id1", "badge_id2"]}
å‰ç«¯æˆå°±é¡µé¢->>å‰ç«¯æˆå°±é¡µé¢: â‘± è®¡ç®—ç”¨æˆ·å„é¡¹ç»Ÿè®¡æ•°æ®ï¼ˆå®Œæˆé—®å·æ•°ã€åˆ›å»ºæ•°ç­‰ï¼‰
å‰ç«¯æˆå°±é¡µé¢->>å‰ç«¯æˆå°±é¡µé¢: â‘² å¯¹æ¯”unlockedBadgesæ•°ç»„ï¼Œåˆ†ç¦»å·²è§£é”å’Œæœªè§£é”å¾½ç« 
å‰ç«¯æˆå°±é¡µé¢->>å‰ç«¯æˆå°±é¡µé¢: â‘³ æ£€æŸ¥æœªè§£é”å¾½ç« ï¼Œå¯¹æ¯”å½“å‰è¿›åº¦ä¸Žrequirementåˆ¤æ–­æ˜¯å¦è¾¾åˆ°è§£é”æ¡ä»¶
å‰ç«¯æˆå°±é¡µé¢->>APIå±‚: ã‰‘ ï¼ˆå¦‚æœ‰æ–°è§£é”ï¼‰PATCH /users/:id æ›´æ–°unlockedBadgesæ•°ç»„å’Œpoints
APIå±‚->>åŽç«¯è·¯ç”±: ã‰’ è½¬å‘æ›´æ–°è¯·æ±‚
åŽç«¯è·¯ç”±->>æ•°æ®åº“: ã‰“ æ›´æ–°Userè¡¨å¯¹åº”è®°å½•
æ•°æ®åº“-->>å‰ç«¯æˆå°±é¡µé¢: ã‰” è¿”å›žæ›´æ–°æˆåŠŸ
å‰ç«¯æˆå°±é¡µé¢->>ç”¨æˆ·: ã‰• æ˜¾ç¤ºå¾½ç« è§£é”åŠ¨ç”»ã€ç§¯åˆ†å¥–åŠ±æç¤º
å‰ç«¯æˆå°±é¡µé¢->>ç”¨æˆ·: ã‰– æ¸²æŸ“å¾½ç« å¡ç‰‡ï¼ˆçŠ¶æ€ã€è¿›åº¦æ¡"5/10"ã€æè¿°ï¼‰
**_end_**

2ã€æŽ¥å£å®šä¹‰
è¡¨ 5-16 ç§¯åˆ†ä¸Žæˆå°±å¾½ç« ç³»ç»ŸæŽ¥å£è¡¨

æŽ¥å£åç§° èŽ·å–ç§¯åˆ†åŽ†å²æŽ¥å£
æŽ¥å£æè¿° æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†å˜åŠ¨åŽ†å²è®°å½•ï¼Œæ”¯æŒåˆ†é¡µ
URL {{baseurl}}/users/:id/point-history?page=1&limit=20
method GET
è¯·æ±‚å‚æ•° {"page": 1, "limit": 20} (å¯é€‰)
è¿”å›žå‚æ•° {"success": true, "data": {"history": [{"id": "ph_123", "userId": "user_123", "points": 10, "reason": "å®Œæˆé—®å·", "type": "earn", "createdAt": "..."}], "total": 50, "page": 1, "totalPages": 3}}

æŽ¥å£åç§° èŽ·å–æ‰€æœ‰å¾½ç« å®šä¹‰æŽ¥å£
æŽ¥å£æè¿° æŸ¥è¯¢ç³»ç»Ÿæ‰€æœ‰æˆå°±å¾½ç« å®šä¹‰
URL {{baseurl}}/badges
method GET
è¯·æ±‚å‚æ•° æ— 
è¿”å›žå‚æ•° [{"id": "badge_survey_10", "name": "é—®å·è¾¾äºº", "description": "å®Œæˆ 10 ä»½é—®å·", "type": "survey_count", "requirement": 10, "points": 20, "icon": "ðŸ†"}, ...]

æŽ¥å£åç§° èŽ·å–ç”¨æˆ·ä¿¡æ¯æŽ¥å£ï¼ˆå«å¾½ç« æ•°æ®ï¼‰
æŽ¥å£æè¿° æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…å«å·²è§£é”å¾½ç« IDæ•°ç»„
URL {{baseurl}}/users/:id
method GET
è¯·æ±‚å‚æ•° æ— 
è¿”å›žå‚æ•° {"id": "user_123", "username": "å¼ ä¸‰", "points": 350, "unlockedBadges": ["badge_survey_10", "badge_login_7"], "completedSurveys": [], "continuousLoginDays": 5, ...}

æŽ¥å£åç§° æ›´æ–°ç”¨æˆ·å¾½ç« æ•°æ®æŽ¥å£
æŽ¥å£æè¿° æ›´æ–°ç”¨æˆ·å·²è§£é”å¾½ç« å’Œç§¯åˆ†ï¼ˆå‰ç«¯å¾½ç« è§£é”æ—¶è°ƒç”¨ï¼‰
URL {{baseurl}}/users/:id
method PATCH
è¯·æ±‚å‚æ•° {"unlockedBadges": ["badge_survey_10", "badge_login_7", "badge_create_5"], "points": 420}
è¿”å›žå‚æ•° {"success": true, "data": {...}}

3ã€å…³é”®ä»£ç 
ä»£ç  5-16 ç§¯åˆ†ä¸Žæˆå°±å¾½ç« ç³»ç»Ÿæ ¸å¿ƒä»£ç 

// èŽ·å–ç§¯åˆ†åŽ†å² (userController.js)
exports.getPointHistory = async (req, res, next) => {
const { page = 1, limit = 20 } = req.query;
const history = await PointHistory.findAndCountAll({
where: { userId: req.params.id },
limit: parseInt(limit),
offset: (page - 1) \* limit,
order: [["createdAt", "DESC"]],
});

res.json({
success: true,
data: {
history: history.rows,
total: history.count,
page: parseInt(page),
},
});
};

// ç­‰çº§è®¡ç®— (AchievementsPage.vue)
const getUserLevel = computed(() => {
  return Math.floor((userStats.value.points || 0) / 500) + 1;
});

// å‰ç«¯æ£€æŸ¥å¹¶è‡ªåŠ¨è§£é”å¾½ç«  (AchievementsPage.vue)
const checkAndUnlockBadges = async () => {
  try {
    const userId = userStore.userId;
    const newlyUnlocked = [];

    // æ£€æŸ¥æ¯ä¸ªå¾½ç« çš„è§£é”æ¡ä»¶
    for (const badge of allBadges.value) {
      // å¦‚æžœå·²ç»è§£é”ï¼Œè·³è¿‡
      if (userUnlockedBadgeIds.value.includes(badge.id)) {
        continue;
      }

      // æ ¹æ®å¾½ç« ç±»åž‹æ£€æŸ¥æ˜¯å¦åº”è¯¥è§£é”
      const currentProgress = getCurrentProgress(badge);
      const shouldUnlock = currentProgress >= badge.requirement;

      if (shouldUnlock) {
        newlyUnlocked.push(badge);
        userUnlockedBadgeIds.value.push(badge.id);
      }
    }

    // å¦‚æžœæœ‰æ–°è§£é”çš„å¾½ç« ï¼Œæ›´æ–°ç”¨æˆ·æ•°æ®
    if (newlyUnlocked.length > 0) {
      // è®¡ç®—æ–°å¢žçš„ç§¯åˆ†
      const addedPoints = newlyUnlocked.reduce((sum, badge) => sum + badge.points, 0);
      const newPoints = userStats.value.points + addedPoints;

      // æ›´æ–°æ•°æ®åº“ä¸­çš„ç”¨æˆ·æ•°æ®
      await apiClient.patch(`/users/${userId}`, {
        unlockedBadges: userUnlockedBadgeIds.value,
        points: newPoints,
      });

      // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
      userStats.value.points = newPoints;

      // æ˜¾ç¤ºè§£é”æç¤º
      for (const badge of newlyUnlocked) {
        ElMessage.success({
          message: `ðŸŽ‰ æ­å–œè§£é”å¾½ç« ï¼š${badge.name}ï¼èŽ·å¾— ${badge.points} ç§¯åˆ†`,
          duration: 3000,
        });
      }
    }
  } catch (error) {
    console.error("æ£€æŸ¥å¾½ç« è§£é”å¤±è´¥:", error);
  }
};

// èŽ·å–å½“å‰è¿›åº¦ (AchievementsPage.vue)
const getCurrentProgress = (badge) => {
  switch (badge.type) {
    case "survey_count":
      return userStats.value.completedSurveys;
    case "create_count":
      return answerStats.value.createCount;
    case "continuous_login":
      return answerStats.value.continuousLoginDays;
    case "total_points":
      return userStats.value.points;
    // ... å…¶ä»–å¾½ç« ç±»åž‹çš„è¿›åº¦è®¡ç®—
    default:
      return 0;
  }
};

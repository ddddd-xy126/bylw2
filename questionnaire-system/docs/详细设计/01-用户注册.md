用户注册
1、简要描述
（1）功能描述：系统新用户注册时，需要填写邮箱、用户名、昵称、密码来创建账号。系统对用户输入进行严格验证，确保用户名和邮箱的唯一性，并使用 bcrypt 算法对密码进行加密存储。一旦注册成功，用户即可凭借该账户登录平台，且系统会自动将用户跳转至登录界面。
（2）代码逻辑：
用户在注册页面的对应输入框内，依次填写邮箱、用户名、昵称、密码，点击注册按钮，前端验证必填的字段前端会立即将用户填写的数据通过 HTTP 请求传输到后端服务器。后端服务器接收到用户所填数据后，会先格式验证，确保信息符合既定格式规范后，在进行检索数据库，以确认所提供的用户名和邮箱是否已经存在。若用户名或邮箱存在，向前端返回错误提示信息。若未被占用，且通过各项验证，后端则将用户信息存储至数据库中，创建用户记录。完成上述操作后，后端会把注册结果反馈给前端。前端依据接收到的结果，展示相应提示信息。若注册成功自动跳转到登录页，并清空注册表单。

###用户注册时序图描述
用户 → LoginPage.vue: 填写注册信息（邮箱、用户名、昵称、密码）并点击注册
LoginPage.vue → auth.js: 调用 register API
auth.js → 后端路由 (POST /auth/register): 发送 HTTP POST 请求
后端路由 (routes/auth.js) → validateRegister 中间件: 验证数据格式（用户名、邮箱、密码）
validateRegister 中间件 → authController.js: 验证通过，转发到 authController.register
authController.js → MySQL: 查询用户名是否已存在
MySQL → authController.js: 返回查询结果
authController.js → MySQL: 查询邮箱是否已存在
MySQL → authController.js: 返回查询结果
authController.js → authController.js: 通过验证，使用 bcrypt 加密密码
authController.js → MySQL: 创建用户记录（包含初始积分 100、默认头像等）
MySQL → authController.js: 返回创建结果
authController.js → MySQL: 创建积分历史记录（注册奖励 100 积分）
MySQL → authController.js: 返回创建结果
authController.js → authController.js: 生成 JWT Token
authController.js → auth.js: 返回注册成功响应（Token 和用户信息）
auth.js → LoginPage.vue: 返回注册结果
LoginPage.vue → 用户界面: 显示成功提示并自动跳转到登录页

2、接口定义
表 5-1 用户注册接口表
接口名称 注册接口
接口描述 用户点击注册时调用接口，可以创建新的平台账户
URL {{baseurl}}/auth/register
method POST
请求参数 {"username": "testuser","password": "password123","email":"test@example.com","nickname": " 测试用户"}
返回参数 {"success": true, "message": "注册成功"}

3、关键代码
代码 5-1 用户注册核心实现代码
// 前端调用注册接口（api/auth.js）
export async function register(data) {
return apiClient.post('/auth/register', data);
}

// 后端注册控制器（authController.js）
exports.register = async (req, res, next) => {
try {
const { username, email, password, nickname } = req.body;

    // 检查用户名是否已存在（主要检查）
    const existingUsername = await User.findOne({
      where: { username },
    });

    if (existingUsername) {
      return res.status(400).json({
        success: false,
        message: "用户名已存在，请重新输入",
      });
    }

    // 如果提供了邮箱，检查邮箱是否已存在
    if (email) {
      const existingEmail = await User.findOne({
        where: { email },
      });

      if (existingEmail) {
        return res.status(400).json({
          success: false,
          message: "邮箱已存在",
        });
      }
    }

    // 创建用户（密码会通过 User Model 的 beforeCreate hook 自动加密）
    const user = await User.create({
      id: Date.now().toString(), // 使用时间戳生成 ID
      username,
      email: email || `${username}@example.com`, // 如果没有邮箱，生成默认邮箱
      password,
      nickname: nickname || username,
      points: 100, // 注册赠送 100 积分
      avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
    });

    // 记录积分历史
    await PointHistory.create({
      id: `ph_${Date.now()}`,
      userId: user.id,
      points: 100,
      reason: "注册奖励",
      type: "earn",
    });

    // 生成 Token
    const token = jwt.sign({ id: user.id, role: user.role }, jwtConfig.secret, {
      expiresIn: jwtConfig.expiresIn,
    });

    res.status(201).json({
      success: true,
      message: "注册成功",
      data: {
        token,
        user: user.toSafeObject(),
      },
    });

} catch (error) {
next(error);
}
};

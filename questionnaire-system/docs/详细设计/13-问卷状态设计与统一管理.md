问卷状态设计与统一管理
1、简要描述
（1）功能描述：问卷状态管理通过统一的 status 字段控制问卷生命周期，包括草稿(draft)、待审核(pending)、已发布(published)、已停止(stopped)、已拒绝(rejected)五种状态。

（2）代码逻辑：问卷的状态管理通过一个统一的 status 字段来控制问卷的整个流程，包括草稿、待审核、已发布、已停止和已拒绝五种状态。数据库中的 status 字段用枚举类型定义，默认是草稿，以保证所有问卷都有明确的状态。在使用中，前端会根据不同页面的需要，把当前需要的状态参数传给后端接口，从而获取草稿列表、审核列表或已发布列表等。后端在查询时会根据 status、分类、作者或关键词等条件进行过滤，并返回对应的问卷数据。状态的更新由 updateSurvey 接口完成：用户在前端进行问卷状态变更操作的按钮时，系统会把新的状态传给后端，后端在数据库里读取问卷当前状态、判断是否允许切换，并完成状态修改。

时序图描述

用户 → 前端界面: 触发状态相关操作
前端界面 → 后端 API: 调用对应接口（查询/更新）
后端 API → MySQL: 查询或更新问卷状态
MySQL → 后端 API: 返回操作结果
后端 API → 前端界面: 返回数据或操作结果
前端界面 → 用户: 显示对应界面或提示信息

***时序图最新描述***
    用户->>前端界面: ① 触发状态筛选操作
    前端界面->>API层(survey.js): ② 调用获取问卷列表接口
    API层(survey.js)->>后端路由(surveys.js): ③ GET /surveys?status={status}
    后端路由(surveys.js)->>控制器(surveyController.js): ④ 调用getSurveys方法
    控制器(surveyController.js)->>数据库: ⑤ 按status等条件查询Survey表
    数据库-->>控制器(surveyController.js): ⑥ 返回问卷列表
    控制器(surveyController.js)-->>前端界面: ⑦ 返回筛选结果
    前端界面->>用户: ⑧ 显示对应状态的问卷列表
    用户->>前端界面: ⑨ 点击状态变更按钮
    前端界面->>API层(survey.js): ⑩ 调用更新问卷接口
    API层(survey.js)->>后端路由(surveys.js): ⑪ PUT /surveys/:id
    后端路由(surveys.js)->>控制器(surveyController.js): ⑫ 调用updateSurvey方法
    控制器(surveyController.js)->>数据库: ⑬ 更新status字段
    数据库-->>控制器(surveyController.js): ⑭ 返回更新结果
    控制器(surveyController.js)-->>前端界面: ⑮ 返回操作结果
    前端界面->>用户: ⑯ 显示状态变更成功提示
***end***

2、接口定义
表 5-13 问卷状态管理接口表

接口名称 获取问卷列表接口（按状态筛选）
接口描述 按状态筛选问卷列表，支持分类、作者、搜索等组合条件
URL {{baseurl}}/surveys?status={status}&userId={userId}
method GET
请求参数 {"status": "published", "userId": "user_123", "page": 1, "limit": 10}
返回参数 {"success": true, "data": [{"id": "1701234567890", "title": "用户体验调查", "status": "published", "publishedAt": "2024-01-15T10:30:00.000Z", "creator": {...}, "categoryInfo": {...}}, ...]}

接口名称 更新问卷状态接口
接口描述 更新问卷状态
URL {{baseurl}}/surveys/:id
method PUT
请求参数 {"status": "published"}
返回参数 {"success": true, "message": "问卷更新成功", "data": {"id": "1701234567890", "status": "published", "publishedAt": "2024-01-15T14:20:00.000Z", "pointsEarned": 0}}

3、关键代码
代码 5-13 问卷状态管理核心代码

// 数据库模型 - 状态枚举定义（Survey.js）
const Survey = sequelize.define("Survey", {
status: {
type: DataTypes.ENUM("draft", "pending", "published", "stopped", "rejected"),
defaultValue: "draft",
},
publishedAt: DataTypes.DATE,
participantCount: {
type: DataTypes.INTEGER,
defaultValue: 0,
},
});

// 按状态筛选问卷列表（surveyController.js）
exports.getSurveys = async (req, res, next) => {
const { status, category, userId, search, page = 1, limit = 10 } = req.query;
const where = {};

if (status) where.status = status;
if (category) where.category = category;
if (userId) where.userId = userId;
if (search) {
where[Op.or] = [
{ title: { [Op.like]: `%${search}%` } },
{ description: { [Op.like]: `%${search}%` } },
];
}

const surveys = await Survey.findAndCountAll({
where,
include: [
{ model: User, as: "creator", attributes: ["id", "username", "nickname", "avatar"] },
{ model: Category, as: "categoryInfo", attributes: ["id", "name", "slug"] },
],
limit: parseInt(limit),
offset: (page - 1) \* limit,
order: [["createdAt", "DESC"]],
});

res.json({ success: true, data: surveys.rows });
};

# 问卷状态设计与统一管理

## 功能描述

问卷状态管理是问卷系统的核心功能之一,通过统一的状态字段 `status` 来管理问卷的完整生命周期。系统定义了五种问卷状态:草稿(draft)、待审核(pending)、已发布(published)、已停止(stopped)和已拒绝(rejected),不同状态的问卷在前端页面中以不同方式展示和操作。

状态转换流程:
- **草稿(draft)**: 用户创建问卷初始状态,可编辑修改
- **待审核(pending)**: 用户提交审核,等待管理员审批
- **已发布(published)**: 管理员审核通过,问卷正式上线
- **已停止(stopped)**: 已发布问卷可暂停收集数据
- **已拒绝(rejected)**: 审核不通过,退回草稿状态

状态管理的关键特性:
- 数据库层面使用 ENUM 枚举类型确保状态值合法性
- 前端根据不同状态展示对应的标签、图标和操作按钮
- 状态变更触发积分奖励机制(如提交审核奖励5积分)
- 不同状态的问卷支持不同的操作权限

## 代码逻辑

### 1. 数据库模型定义

在 Survey 模型中,`status` 字段定义为 ENUM 枚举类型:
- 允许值: "draft", "pending", "published", "stopped", "rejected"
- 默认值: "draft"
- 确保数据完整性,防止非法状态值

### 2. 问卷列表筛选

后端 `getSurveys` 控制器支持按状态筛选:
- 接收 `status` 查询参数
- 构建 WHERE 条件: `if (status) where.status = status`
- 支持与其他条件(分类、作者、模板等)组合筛选
- 返回符合条件的问卷列表

### 3. 问卷创建与状态设置

创建问卷时支持指定初始状态:
- 默认为 "draft" 草稿状态
- 用户提交审核时设置为 "pending"
- 管理员创建时可直接设置为 "published"
- 根据不同状态触发不同的积分奖励:
  - draft: 3积分
  - pending: 5积分
  - published(管理员): 3积分

### 4. 状态更新与转换

问卷状态可以通过 `updateSurvey` 接口更新:
- **草稿→待审核**: 用户提交审核,奖励5积分
- **待审核→草稿**: 用户撤回或管理员拒绝
- **待审核→已发布**: 管理员审核通过,记录发布时间
- **已发布→已停止**: 暂停数据收集
- **已停止→已发布**: 继续收集数据

状态转换时的业务逻辑:
- 记录 `publishedAt` 发布时间(首次发布时)
- 触发积分奖励(特定状态转换)
- 创建积分历史记录
- 数据库事务保证一致性

### 5. 前端状态展示

前端根据 `status` 字段展示不同的UI:

**已发布问卷 (published)**:
- 标签: 绿色 `<el-tag type="success">已发布</el-tag>`
- 图标: 绿色打勾 `<CircleCheck />`
- 操作: 查看数据、查看评论、停止收集、删除

**待审核问卷 (pending)**:
- 标签: 橙色 `<el-tag type="warning">待审核</el-tag>`
- 图标: 时钟 `<Clock />`
- 操作: 预览、撤回、联系管理员
- 显示审核进度条(50%等待状态)

**草稿问卷 (draft)**:
- 标签: 灰色 `<el-tag type="info">草稿</el-tag>`
- 图标: 文档 `<Document />`
- 操作: 编辑、提交审核、删除

**已停止问卷 (stopped)**:
- 在已发布列表中特殊样式标记
- 操作: 继续收集、查看数据(只读)

### 6. 页面路由与状态对应

用户中心问卷管理分页面展示:
- `/user/questionnaires/published`: 展示 `status=published` 的问卷
- `/user/questionnaires/pending`: 展示 `status=pending` 的问卷
- `/user/questionnaires/draft`: 展示 `status=draft` 的问卷

每个页面调用 API 时传递对应的状态参数:
```javascript
const data = await getUserSurveysApi(userId, "published");
const data = await getUserSurveysApi(userId, "pending");
```

## 时序图描述

### 用户提交问卷审核(草稿→待审核)

```
用户 → 前端Vue组件: 点击"提交审核"按钮
前端Vue组件 → API层(questionnaire.js): updateQuestionnaireApi(id, {status: "pending"})
API层 → 后端路由(/surveys/:id): PUT请求,携带status="pending"
后端路由 → surveyController.updateSurvey: 调用更新问卷方法
surveyController.updateSurvey → 数据库: 开启事务
surveyController.updateSurvey → Survey表: 查询问卷当前状态
Survey表 → surveyController.updateSurvey: 返回问卷(oldStatus="draft")
surveyController.updateSurvey → surveyController.updateSurvey: 判断状态转换(draft→pending)
surveyController.updateSurvey → Survey表: 更新status为"pending"(事务中)
surveyController.updateSurvey → User表: 增加用户积分+5(事务中)
surveyController.updateSurvey → PointHistory表: 创建积分历史记录(事务中)
surveyController.updateSurvey → 数据库: 提交事务
surveyController.updateSurvey → 后端路由: 返回更新结果
后端路由 → API层: 返回{success: true, data: survey}
API层 → 前端Vue组件: 返回更新后的问卷数据
前端Vue组件 → 用户: 显示"提交成功,等待审核"提示,跳转到待审核页面
```

### 管理员审核通过(待审核→已发布)

```
管理员 → 管理后台: 点击"审核通过"按钮
管理后台 → API层: updateQuestionnaireApi(id, {status: "published"})
API层 → 后端路由: PUT /surveys/:id
后端路由 → surveyController.updateSurvey: 调用更新方法
surveyController.updateSurvey → 数据库: 开启事务
surveyController.updateSurvey → Survey表: 查询问卷(oldStatus="pending")
surveyController.updateSurvey → Survey表: 更新status为"published"
surveyController.updateSurvey → Survey表: 设置publishedAt为当前时间(首次发布)
surveyController.updateSurvey → 数据库: 提交事务
surveyController.updateSurvey → 后端路由: 返回更新结果
后端路由 → API层: 返回成功
API层 → 管理后台: 返回更新数据
管理后台 → 管理员: 显示"审核通过"提示
管理后台 → 系统: 可选:发送通知给问卷作者
```

### 前端按状态加载问卷列表

```
用户 → 前端页面: 访问"已发布问卷"页面(/user/questionnaires/published)
前端页面 → API层(survey.js): getUserSurveysApi(userId, "published")
API层 → 后端路由: GET /surveys?userId=xxx&status=published
后端路由 → surveyController.getSurveys: 调用获取列表方法
surveyController.getSurveys → surveyController.getSurveys: 构建WHERE条件{userId, status: "published"}
surveyController.getSurveys → Survey表: findAndCountAll(where条件+分页+排序)
surveyController.getSurveys → User表: 关联查询creator(作者信息)
surveyController.getSurveys → Category表: 关联查询categoryInfo(分类信息)
Survey表 → surveyController.getSurveys: 返回问卷列表数组
surveyController.getSurveys → 后端路由: 返回{success: true, data: surveys}
后端路由 → API层: 返回问卷数组
API层 → 前端页面: 返回已发布问卷列表
前端页面 → 前端页面: 渲染列表,显示绿色"已发布"标签
前端页面 → 用户: 展示已发布问卷,每项显示数据统计和操作按钮
```

## 接口定义

### 1. 获取问卷列表(按状态筛选)

**接口**: `GET /surveys`

**查询参数**:
- `status` (string, 可选) - 筛选状态: "draft" | "pending" | "published" | "stopped" | "rejected"
- `userId` (string, 可选) - 筛选作者
- `category` (string, 可选) - 筛选分类
- `search` (string, 可选) - 搜索关键词
- `page` (number, 可选) - 页码,默认1
- `limit` (number, 可选) - 每页数量,默认10
- `sortBy` (string, 可选) - 排序字段,默认"createdAt"
- `order` (string, 可选) - 排序方向,"ASC" | "DESC",默认"DESC"

**响应数据**:
```json
{
  "success": true,
  "data": [
    {
      "id": "1701234567890",
      "userId": "user_123",
      "title": "用户体验调查问卷",
      "description": "了解用户对产品的使用体验",
      "status": "published",
      "category": "用户研究",
      "questions": 10,
      "participantCount": 256,
      "answerCount": 189,
      "averageRating": "4.50",
      "favoriteCount": 45,
      "publishedAt": "2024-01-15T10:30:00.000Z",
      "createdAt": "2024-01-10T08:00:00.000Z",
      "creator": {
        "id": "user_123",
        "username": "zhangsan",
        "nickname": "张三",
        "avatar": "avatar_url"
      },
      "categoryInfo": {
        "id": "cat_1",
        "name": "用户研究",
        "slug": "user-research"
      }
    }
  ]
}
```

### 2. 创建问卷(指定初始状态)

**接口**: `POST /surveys`

**请求头**: `Authorization: Bearer <token>`

**请求参数**:
- `title` (string, 必填) - 问卷标题
- `description` (string, 可选) - 问卷描述
- `category` (string, 可选) - 分类
- `questionList` (array, 必填) - 题目列表
- `status` (string, 可选) - 初始状态,默认"draft"
- `duration` (number, 可选) - 预计时长(分钟)
- `tags` (array, 可选) - 标签数组
- `settings` (object, 可选) - 问卷设置

**请求示例**:
```json
{
  "title": "用户体验调查问卷",
  "description": "了解用户对产品的使用体验",
  "category": "用户研究",
  "status": "pending",
  "questionList": [
    {
      "id": 1,
      "type": "single",
      "title": "您对我们的产品满意吗？",
      "options": [
        {"id": "yes", "text": "满意"},
        {"id": "no", "text": "不满意"}
      ]
    }
  ],
  "duration": 10
}
```

**响应数据**:
```json
{
  "success": true,
  "message": "问卷创建成功",
  "data": {
    "id": "1701234567890",
    "status": "pending",
    "pointsEarned": 5,
    "title": "用户体验调查问卷",
    "createdAt": "2024-01-15T10:30:00.000Z"
  }
}
```

### 3. 更新问卷状态

**接口**: `PUT /surveys/:id`

**请求头**: `Authorization: Bearer <token>`

**请求参数**:
- `status` (string, 必填) - 新状态值
- 其他可选字段: title, description, questionList等

**请求示例**:
```json
{
  "status": "published"
}
```

**权限要求**:
- 问卷作者或管理员可更新
- 某些状态转换仅管理员可执行(如pending→published)

**响应数据**:
```json
{
  "success": true,
  "message": "问卷更新成功",
  "data": {
    "id": "1701234567890",
    "status": "published",
    "publishedAt": "2024-01-15T14:20:00.000Z",
    "pointsEarned": 0
  }
}
```

## 关键代码

### 数据库模型 - 状态枚举定义 (Survey.js)

```javascript
const Survey = sequelize.define(
  "Survey",
  {
    // ...其他字段
    status: {
      type: DataTypes.ENUM(
        "draft",      // 草稿
        "pending",    // 待审核
        "published",  // 已发布
        "stopped",    // 已停止
        "rejected"    // 已拒绝
      ),
      defaultValue: "draft",
    },
    isTemplate: {
      type: DataTypes.BOOLEAN,
      defaultValue: false,
    },
    participantCount: {
      type: DataTypes.INTEGER,
      defaultValue: 0,
      comment: "参与人数",
    },
    publishedAt: DataTypes.DATE,  // 发布时间
  },
  {
    tableName: "surveys",
  }
);
```

### 后端 - 按状态筛选问卷列表 (surveyController.js)

```javascript
exports.getSurveys = async (req, res, next) => {
  try {
    const {
      status,
      category,
      categoryId,
      isTemplate,
      authorId,
      userId,
      search,
      sortBy = "createdAt",
      order = "DESC",
      page = 1,
      limit = 10,
    } = req.query;

    const where = {};

    // 构建筛选条件
    if (status) where.status = status;
    if (category) where.category = category;
    if (categoryId) where.categoryId = categoryId;
    if (authorId) where.userId = authorId;
    if (userId) where.userId = userId;
    if (isTemplate !== undefined) where.isTemplate = isTemplate === "true";
    if (search) {
      where[Op.or] = [
        { title: { [Op.like]: `%${search}%` } },
        { description: { [Op.like]: `%${search}%` } },
      ];
    }

    const surveys = await Survey.findAndCountAll({
      where,
      include: [
        {
          model: User,
          as: "creator",
          attributes: ["id", "username", "nickname", "avatar"],
        },
        {
          model: Category,
          as: "categoryInfo",
          attributes: ["id", "name", "slug"],
        },
      ],
      limit: parseInt(limit),
      offset: (page - 1) * limit,
      order: [[sortBy, order.toUpperCase()]],
    });

    res.json({
      success: true,
      data: surveys.rows,
    });
  } catch (error) {
    next(error);
  }
};
```

### 后端 - 状态更新与积分奖励 (surveyController.js)

```javascript
exports.updateSurvey = async (req, res, next) => {
  const t = await sequelize.transaction();

  try {
    const { id } = req.params;
    const { title, description, status, questionList } = req.body;

    const survey = await Survey.findByPk(id);
    if (!survey) {
      await t.rollback();
      return res.status(404).json({
        success: false,
        message: "问卷不存在",
      });
    }

    // 权限检查
    if (survey.userId !== req.user.id && req.user.role !== "admin") {
      await t.rollback();
      return res.status(403).json({
        success: false,
        message: "无权修改此问卷",
      });
    }

    const oldStatus = survey.status;
    const newStatus = status || oldStatus;

    // 积分奖励逻辑
    const PointHistory = require("../models").PointHistory;
    let pointsEarned = 0;
    let rewardReason = "";

    // 从草稿提交审核,奖励5积分
    if (oldStatus === "draft" && newStatus === "pending") {
      pointsEarned = 5;
      rewardReason = `提交问卷《${title || survey.title}》审核`;
    }

    await survey.update(
      {
        title,
        description,
        questionList,
        status: newStatus,
        // 首次发布时记录发布时间
        ...(newStatus === "published" &&
          !survey.publishedAt && { publishedAt: new Date() }),
      },
      { transaction: t }
    );

    // 创建积分记录
    if (pointsEarned > 0) {
      await req.user.increment("points", { by: pointsEarned, transaction: t });
      await PointHistory.create(
        {
          id: `ph_${Date.now()}`,
          userId: req.user.id,
          points: pointsEarned,
          reason: rewardReason,
          type: "earn",
        },
        { transaction: t }
      );
    }

    await t.commit();

    res.json({
      success: true,
      message: "问卷更新成功",
      data: { ...survey.toJSON(), pointsEarned },
    });
  } catch (error) {
    await t.rollback();
    next(error);
  }
};
```

### 前端 - 待审核问卷页面展示 (PendingPage.vue)

```vue
<template>
  <div class="pending-page">
    <!-- 问卷列表 -->
    <div class="survey-list" v-loading="loading">
      <div v-for="survey in filteredSurveys" :key="survey.id" class="survey-item">
        <div class="survey-main">
          <!-- 状态图标 -->
          <div class="survey-icon">
            <el-icon size="24" color="#E6A23C">
              <Clock />
            </el-icon>
          </div>

          <div class="survey-info">
            <!-- 标题和状态标签 -->
            <div class="survey-header">
              <h3>{{ survey.title }}</h3>
              <el-tag size="small" type="warning">待审核</el-tag>
            </div>

            <!-- 审核进度 -->
            <div class="review-progress">
              <span class="progress-label">审核进度</span>
              <span class="progress-status">等待管理员审核中...</span>
              <el-progress
                :percentage="50"
                status="warning"
                :stroke-width="6"
              />
            </div>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="survey-actions">
          <el-button type="success" @click="viewSurvey(survey.id)">
            预览
          </el-button>
          <el-button type="warning" @click="withdrawSurvey(survey.id)">
            撤回
          </el-button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { getUserSurveysApi } from "@/api/survey";

const loadPendingSurveys = async () => {
  const userId = userStore.profile?.id;
  // 使用API获取当前用户的待审核问卷
  const allSurveys = await getUserSurveysApi(userId, "pending");
  pendingSurveys.value = allSurveys;
};
</script>
```

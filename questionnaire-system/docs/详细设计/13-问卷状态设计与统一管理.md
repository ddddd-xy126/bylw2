问卷状态设计与统一管理
1、简要描述
（1）功能描述：问卷状态管理通过统一的 status 字段控制问卷生命周期，包括草稿(draft)、待审核(pending)、已发布(published)、已停止(stopped)、已拒绝(rejected)五种状态。

（2）代码逻辑：问卷的状态管理通过一个统一的 status 字段来控制问卷的整个流程，包括草稿、待审核、已发布、已停止和已拒绝五种状态。数据库中的 status 字段用枚举类型定义，默认是草稿，以保证所有问卷都有明确的状态。在使用中，前端会根据不同页面的需要，把当前需要的状态参数传给后端接口，从而获取草稿列表、审核列表或已发布列表等。后端在查询时会根据 status、分类、作者或关键词等条件进行过滤，并返回对应的问卷数据。状态的更新由 updateSurvey 接口完成：用户在前端点击“提交审核”等按钮时，系统会把新的状态传给后端，后端在数据库事务里读取问卷当前状态、判断是否允许切换，并完成状态修改；例如草稿提交审核时，会同时更新状态并给用户增加对应积分。管理员在后台审核时也是通过同样的更新接口把问卷状态改成已发布。用户进入“已发布问卷”页面时，前端根据 userId 和 status=published 调用查询接口获取结果，再显示带有“已发布”标识的问卷列表。这样，问卷从草稿到发布的整个流程都通过同一个字段和统一的接口来管理，状态切换清晰、处理逻辑一致。

时序图描述
用户 → 前端页面: 点击"提交审核"按钮
前端页面 → API 层: updateQuestionnaireApi(id, {status: "pending"})
API 层 → 后端 API: PUT /surveys/:id（携带 status="pending"）
后端 API → surveyController: 调用 updateSurvey
surveyController → MySQL: 开启事务并查询问卷当前状态
MySQL → surveyController: 返回问卷（oldStatus="draft"）
surveyController → surveyController: 判断状态转换（draft→pending，奖励 5 积分）
surveyController → MySQL: 更新 status、增加积分、创建积分记录（事务中）
surveyController → MySQL: 提交事务
surveyController → API 层: 返回操作结果
API 层 → 前端页面: 返回更新后的问卷数据
前端页面 → 用户界面: 显示"提交成功，等待审核"并跳转到待审核页面

管理员 → 管理后台: 点击"审核通过"按钮
管理后台 → 后端 API: PUT /surveys/:id（status="published"）
后端 API → MySQL: 开启事务，更新 status 和 publishedAt
MySQL → 后端 API: 返回更新结果
后端 API → 管理后台: 返回操作成功
管理后台 → 管理员: 显示"审核通过"提示

用户 → 前端页面: 访问"已发布问卷"页面
前端页面 → 后端 API: GET /surveys?userId=xxx&status=published
后端 API → MySQL: 查询问卷列表（关联作者和分类信息）
MySQL → 后端 API: 返回问卷数组
后端 API → 前端页面: 返回已发布问卷列表
前端页面 → 用户界面: 渲染列表，显示绿色"已发布"标签

***时序图描述***
用户/管理员 → 前端界面: 触发状态相关操作
前端界面 → 后端API: 调用对应接口（查询/更新）
后端API → MySQL: 查询或更新问卷状态
MySQL → 后端API: 返回操作结果
后端API → 前端界面: 返回数据或操作结果
前端界面 → 用户/管理员: 显示对应界面或提示信息
***end***


2、接口定义
表 5-13 问卷状态管理接口表

接口名称 获取问卷列表接口（按状态筛选）
接口描述 按状态筛选问卷列表，支持分类、作者、搜索等组合条件
URL {{baseurl}}/surveys?status={status}&userId={userId}
method GET
请求参数 {"status": "published", "userId": "user_123", "page": 1, "limit": 10}
返回参数 {"success": true, "data": [{"id": "1701234567890", "title": "用户体验调查", "status": "published", "publishedAt": "2024-01-15T10:30:00.000Z", "creator": {...}, "categoryInfo": {...}}, ...]}

接口名称 创建问卷接口（指定初始状态）
接口描述 创建问卷并指定初始状态，触发积分奖励
URL {{baseurl}}/surveys
method POST
请求参数 {"title": "用户体验调查", "category": "用户研究", "status": "pending", "questionList": [...], "duration": 10}
返回参数 {"success": true, "message": "问卷创建成功", "data": {"id": "1701234567890", "status": "pending", "pointsEarned": 5}}

接口名称 更新问卷状态接口
接口描述 更新问卷状态，状态转换时触发积分奖励和发布时间记录
URL {{baseurl}}/surveys/:id
method PUT
请求参数 {"status": "published"}
返回参数 {"success": true, "message": "问卷更新成功", "data": {"id": "1701234567890", "status": "published", "publishedAt": "2024-01-15T14:20:00.000Z", "pointsEarned": 0}}

3、关键代码
代码 5-13 问卷状态管理核心代码

// 数据库模型 - 状态枚举定义（Survey.js）
const Survey = sequelize.define("Survey", {
status: {
type: DataTypes.ENUM("draft", "pending", "published", "stopped", "rejected"),
defaultValue: "draft",
},
publishedAt: DataTypes.DATE,
participantCount: {
type: DataTypes.INTEGER,
defaultValue: 0,
},
});

// 按状态筛选问卷列表（surveyController.js）
exports.getSurveys = async (req, res, next) => {
const { status, category, userId, search, page = 1, limit = 10 } = req.query;
const where = {};

if (status) where.status = status;
if (category) where.category = category;
if (userId) where.userId = userId;
if (search) {
where[Op.or] = [
{ title: { [Op.like]: `%${search}%` } },
{ description: { [Op.like]: `%${search}%` } },
];
}

const surveys = await Survey.findAndCountAll({
where,
include: [
{ model: User, as: "creator", attributes: ["id", "username", "nickname", "avatar"] },
{ model: Category, as: "categoryInfo", attributes: ["id", "name", "slug"] },
],
limit: parseInt(limit),
offset: (page - 1) \* limit,
order: [["createdAt", "DESC"]],
});

res.json({ success: true, data: surveys.rows });
};

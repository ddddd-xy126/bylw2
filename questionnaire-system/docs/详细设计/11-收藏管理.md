收藏管理
1、简要描述
（1）功能描述：用户管理个人收藏，包含添加、删除、查看收藏列表等功能。

（2）代码逻辑：
用户在问卷列表或详情页点击收藏按钮，前端调用 toggleFavorite 函数处理收藏操作。系统首先检查用户是否已登录，未登录则提示登录。已登录用户系统调用 isFavorite 函数检查当前问卷是否已收藏，该函数遍历用户的收藏列表（userStore.favorites），比较 questionnaireId 或 surveyId 与目标问卷 ID 是否匹配。如果已收藏，系统调用 removeFavoriteApi 接口取消收藏：前端发送 GET 请求查询收藏记录（/favorites?userId={userId}&surveyId={surveyId}），获取收藏记录 ID 后发送 DELETE 请求删除记录（/favorites/{id}），后端 toggleFavorite 方法在 Favorite 表中查找并删除记录，同时将 Survey 表中的 favoriteCount 字段减 1。删除成功后前端调用 userStore.removeFavorite 从本地收藏列表移除该问卷，显示"取消收藏成功"提示。如果未收藏，系统调用 addFavoriteApi 接口添加收藏：前端发送 POST 请求到 /favorites 接口，请求体包含 userId 和 surveyId，后端 toggleFavorite 方法在 Favorite 表中创建新记录（id 格式为 fav*{timestamp}*{userId}），同时将 Survey 表中的 favoriteCount 字段加 1。添加成功后前端重新调用 getFavoritesApi 接口获取完整的收藏列表（包含问卷详细信息），后端通过 include 关联查询返回收藏记录和对应的 survey 对象，前端格式化数据后更新 userStore.favorites，显示"收藏成功"提示。整个过程中，前端通过 isFavorite 函数实时判断收藏状态，动态切换收藏按钮的图标和样式。

###收藏管理时序图描述
用户 → 前端页面: 点击收藏按钮
前端页面 → useHomeLogic.js: 调用 toggleFavorite
useHomeLogic.js → useHomeLogic.js: 检查用户是否已登录
useHomeLogic.js → useHomeLogic.js: 调用 isFavorite 检查收藏状态
useHomeLogic.js → userStore: 遍历 favorites 数组比较问卷 ID
userStore → useHomeLogic.js: 返回收藏状态（true/false）
useHomeLogic.js → user.js: 调用 removeFavoriteApi（已收藏）或 addFavoriteApi（未收藏）
user.js → 后端 /favorites: 发送 GET 请求查询收藏记录（取消收藏）
后端 /favorites → MySQL: 查询 favorites 表
MySQL → 后端 /favorites: 返回收藏记录
user.js → 后端 /favorites/{id}: 发送 DELETE 请求删除记录
后端 /favorites/{id} → surveyController.js: 调用 toggleFavorite 方法
surveyController.js → MySQL: 删除 Favorite 记录并减少 Survey.favoriteCount
MySQL → surveyController.js: 返回删除结果
surveyController.js → user.js: 返回成功响应
user.js → useHomeLogic.js: 返回操作结果
useHomeLogic.js → userStore: 调用 removeFavorite 移除本地收藏
useHomeLogic.js → 用户界面: 显示"取消收藏成功"提示
user.js → 后端 /favorites: 发送 POST 请求添加收藏（添加收藏）
后端 /favorites → surveyController.js: 调用 toggleFavorite 方法
surveyController.js → MySQL: 创建 Favorite 记录并增加 Survey.favoriteCount
MySQL → surveyController.js: 返回创建结果
surveyController.js → user.js: 返回成功响应
user.js → 后端 /favorites: 发送 GET 请求获取完整收藏列表
后端 /favorites → MySQL: 查询 favorites 表并关联 surveys 表
MySQL → 后端 /favorites: 返回收藏列表和问卷详情
user.js → useHomeLogic.js: 返回收藏列表
useHomeLogic.js → userStore: 更新 favorites 数组
useHomeLogic.js → 用户界面: 显示"收藏成功"提示

**_代码逻辑_**
当用户在问卷列表页或详情页点击收藏按钮时，前端首先通过登录状态判断用户是否具备收藏权限，未登录用户将收到提示信息。对于已登录的用户，系统通过本地的收藏列表（userStore.favorites）判断当前问卷是否已被收藏，并据此执行对应的接口调用：若问卷已收藏，则向后端发送取消收藏请求，后端删除相关收藏记录并同步减少该问卷的收藏计数；若问卷未收藏，则向后端发送新增收藏请求，后端创建新的收藏记录并增加收藏计数。操作完成后，前端根据后端的响应结果实时更新 Pinia 中的收藏列表，使本地状态与服务器保持一致，同时更新页面上的收藏按钮样式并向用户展示相应的反馈信息（如“收藏成功”或“取消收藏成功”）。整个过程通过本地的 isFavorite 判断实现收藏状态的动态切换，从而保持界面展示与实际数据状态的一致性。
**end**

**_时序图最新描述_**
用户->>前端页面SurveyCardEnhanced.vue: ① 点击收藏按钮
前端页面SurveyCardEnhanced.vue->>前端 useHomeLogic.js: ② 调用 toggleFavorite 函数
前端 useHomeLogic.js->>userStore: ③ 检查当前收藏状态
userStore-->>前端 useHomeLogic.js: ④ 返回收藏状态(已收藏/未收藏)
前端 useHomeLogic.js->>API 层(user.js): ⑤ 根据状态调用对应 API
API 层(user.js)->>后端路由(favorites.js): ⑥ DELETE/POST /favorites
后端路由(favorites.js)->>控制器(surveyController.js): ⑦ 调用 toggleFavorite 方法
控制器(surveyController.js)->>数据库: ⑧ 更新 Favorite 表和 Survey.favoriteCount
数据库-->>控制器(surveyController.js): ⑨ 返回操作结果
控制器(surveyController.js)-->>前端 useHomeLogic.js: ⑩ 返回成功响应
前端 useHomeLogic.js->>userStore: ⑪ 更新本地收藏状态
前端 useHomeLogic.js->>用户界面: ⑫ 显示操作成功提示
**_end_**

2、接口定义
表 5-11 收藏管理接口表
接口名称 获取收藏列表接口
接口描述 获取用户的所有收藏问卷，包含关联的问卷详细信息
URL {{baseurl}}/favorites?userId={userId}
method GET
请求参数 userId: 用户 ID
返回参数 {"success": true, "data": [{"id": "fav_123", "userId": "1", "surveyId": "10", "createdAt": "2024-01-01T00:00:00Z", "survey": {"id": "10", "title": "问卷标题", "description": "问卷描述", "category": "调查", "status": "active"}}]}

接口名称 添加收藏接口
接口描述 用户收藏问卷，自动增加问卷收藏数
URL {{baseurl}}/favorites
method POST
请求参数 {"surveyId": "10"}
返回参数 {"success": true, "message": "收藏成功", "data": {"id": "fav_1234567890_user1", "userId": "user1", "surveyId": "10", "createdAt": "2024-01-01T00:00:00Z"}}

接口名称 取消收藏接口
接口描述 用户取消收藏问卷，自动减少问卷收藏数
URL {{baseurl}}/favorites/{id}
method DELETE
请求参数 id: 收藏记录 ID
返回参数 {"success": true, "message": "取消收藏成功"}

3、关键代码
代码 5-11 收藏管理核心实现代码

// 检查收藏状态（useHomeLogic.js）
const isFavorite = (surveyId) => {
return userStore.favorites.some(
(fav) => fav.surveyId == surveyId
);
};

// 切换收藏状态（useHomeLogic.js）
const toggleFavorite = async (surveyId) => {
if (isFavorite(surveyId)) {
await removeFavoriteApi(userId, surveyId);
userStore.removeFavorite(surveyId);
ElMessage.success("取消收藏成功");
} else {
await addFavoriteApi(userId, surveyId);
const favorites = await getFavoritesApi(userId);
userStore.setUserData({ favorites });
ElMessage.success("收藏成功");
}
};

// 添加收藏（favorites.js）
router.post("/", authenticate, async (req, res, next) => {
const { surveyId } = req.body;
const favorite = await Favorite.create({
id: `fav_${Date.now()}_${req.user.id}`,
userId: req.user.id,
surveyId,
});
await Survey.findByPk(surveyId).then(s => s.increment("favoriteCount"));
res.status(201).json({ success: true, data: favorite });
});

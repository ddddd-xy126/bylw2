评论管理
1、简要描述
（1）功能描述：评论管理功能允许用户在完成问卷填写后对问卷进行评论和评分。系统支持评论发布、评论展示以及评论删除。评论数据包含内容、评分、评论用户信息等。

（2）代码逻辑：
用户进入问卷详情页面后，组件会在生命周期钩子中调用加载函数获取该问卷的所有评论。前端通过 GET /comments/survey/:surveyId 接口从后端获取评论列表；后端在 Comment 表中查询并关联 User 表，按时间倒序返回评论数据。

当用户提交评论时，前端调用 POST /comments/survey/:surveyId 接口，将评论内容与评分发送到后端。后端在事务中创建评论记录，并根据新的评分更新问卷的平均评分与评分人数，成功后返回新评论数据。前端刷新列表并提示成功。

删除评论时，系统调用 DELETE /comments/:id 接口，后端验证评论是否存在，并检查权限（作者或管理员）后执行删除操作。前端随后刷新评论列表并显示成功提示。

###评论管理时序图描述
评论展示流程

用户 → 前端页面：进入问卷详情页面
前端页面 → loadComments：触发加载评论列表
loadComments → 后端 API（GET /comments/survey/:surveyId）：请求评论数据
后端 API → MySQL：查询 Comment 表并关联 User 表
MySQL → 后端 API：返回评论列表
后端 API → 前端页面：返回评论数据
前端页面 → UI：渲染评论列表

发表评论流程

用户 → 前端页面：点击“发表评论”
前端页面 → createCommentApi：提交评论与评分
createCommentApi → 后端 API（POST /comments/survey/:surveyId）：发送评论数据
后端 API → MySQL：创建评论记录（事务）
后端 API → MySQL：更新问卷评分信息
MySQL → 后端 API：返回创建结果
后端 API → 前端页面：返回新评论数据
前端页面 → UI：刷新评论列表并提示成功

删除评论流程

用户 → 前端页面：点击“删除评论”
前端页面 → deleteCommentApi
deleteCommentApi → 后端 API（DELETE /comments/:id）：发送删除请求
后端 API → MySQL：验证权限并删除评论
MySQL → 后端 API：返回删除结果
后端 API → 前端页面：返回成功标识
前端页面 → UI：刷新评论列表并提示成功

2、接口定义
表 5-12 评论管理接口表
接口名称 获取评论列表接口
接口描述 查询指定问卷的所有评论，包含评论者信息
URL {{baseurl}}/comments/survey/:surveyId
method GET
请求参数 surveyId: 问卷 ID, page: 页码(可选), limit: 每页数量(可选)
返回参数 {"success": true, "data": {"comments": [{"id": "cmt_123", "userId": "user_123", "content": "问卷很好", "rating": 5, "createdAt": "2024-01-15T10:30:00Z", "user": {"id": "user_123", "username": "zhangsan", "nickname": "张三"}}], "total": 25, "page": 1}}

接口名称 发表评论接口
接口描述 用户发表评论和评分，自动更新问卷平均评分
URL {{baseurl}}/comments/survey/:surveyId
method POST
请求参数 {"content": "问卷设计很好", "rating": 5}
返回参数 {"success": true, "message": "评论发表成功", "data": {"id": "cmt_123", "userId": "user_123", "surveyId": "survey_456", "content": "问卷设计很好", "rating": 5, "createdAt": "2024-01-15T10:30:00Z"}}

接口名称 删除评论接口
接口描述 用户删除自己的评论，管理员可删除任意评论
URL {{baseurl}}/comments/:id
method DELETE
请求参数 id: 评论 ID
返回参数 {"success": true, "message": "评论删除成功"}

3、关键代码
代码 5-12 评论管理核心实现代码

// 加载评论列表（SurveyDetail.vue）
const loadComments = async () => {
const response = await getSurveyCommentsApi(surveyId);
comments.value = response.comments || [];
};

// 发表评论（survey.js）
export async function createCommentApi(id, data) {
const response = await apiClient.post(`/comments/survey/${id}`, {
content: data.content,
rating: data.rating || 5,
});
return response;
}

// 删除评论（commentController.js）
exports.deleteComment = async (req, res, next) => {
const { id } = req.params;
const comment = await Comment.findByPk(id);
if (!comment) {
return res.status(404).json({ success: false, message: "评论不存在" });
}
if (comment.userId !== req.user.id && req.user.role !== "admin") {
return res.status(403).json({ success: false, message: "无权删除此评论" });
}
await comment.destroy();
res.json({ success: true, message: "评论删除成功" });
};

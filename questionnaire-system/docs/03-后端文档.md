# é—®å·ç³»ç»Ÿ - åç«¯æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

åç«¯é‡‡ç”¨ **Express + Sequelize + MySQL** æ„å»ºçš„ RESTful API æœåŠ¡ï¼Œæä¾›å®Œæ•´çš„æ•°æ®å­˜å‚¨ã€ä¸šåŠ¡é€»è¾‘å’Œç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆã€‚

### æŠ€æœ¯æ ˆ

- **Web æ¡†æ¶**: Express 4.x
- **ORM**: Sequelize 6.x
- **æ•°æ®åº“**: MySQL 5.7+
- **è®¤è¯**: JWT (JSON Web Token)
- **å¯†ç åŠ å¯†**: bcrypt
- **æ•°æ®éªŒè¯**: express-validator
- **å®‰å…¨**: helmet, cors
- **PDF ç”Ÿæˆ**: PDFKit
- **AI æœåŠ¡**: Coze API
- **ç¯å¢ƒå˜é‡**: dotenv

---

## ğŸ—‚ï¸ ç›®å½•ç»“æ„

```
server/
â”œâ”€â”€ config/                         # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ database.js                 # Sequelize æ•°æ®åº“é…ç½®
â”‚   â””â”€â”€ jwt.js                      # JWT é…ç½® (å¯†é’¥ã€è¿‡æœŸæ—¶é—´)
â”‚
â”œâ”€â”€ controllers/                    # æ§åˆ¶å™¨ (ä¸šåŠ¡é€»è¾‘å±‚)
â”‚   â”œâ”€â”€ authController.js           # è®¤è¯æ§åˆ¶å™¨ (ç™»å½•ã€æ³¨å†Œã€Tokenåˆ·æ–°)
â”‚   â”œâ”€â”€ userController.js           # ç”¨æˆ·æ§åˆ¶å™¨ (ç”¨æˆ·ä¿¡æ¯ã€ç»Ÿè®¡)
â”‚   â”œâ”€â”€ surveyController.js         # é—®å·æ§åˆ¶å™¨ (CRUDã€ç»Ÿè®¡)
â”‚   â”œâ”€â”€ answerController.js         # ç­”æ¡ˆæ§åˆ¶å™¨ (æäº¤ã€æŸ¥è¯¢)
â”‚   â”œâ”€â”€ commentController.js        # è¯„è®ºæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ categoryController.js       # åˆ†ç±»æ§åˆ¶å™¨
â”‚   â””â”€â”€ adminController.js          # ç®¡ç†å‘˜æ§åˆ¶å™¨ (å®¡æ ¸ã€ç®¡ç†)
â”‚
â”œâ”€â”€ middleware/                     # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.js                     # è®¤è¯ä¸­é—´ä»¶ (JWT éªŒè¯ã€æƒé™æ£€æŸ¥)
â”‚   â”œâ”€â”€ validator.js                # æ•°æ®éªŒè¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ errorHandler.js             # å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚
â”œâ”€â”€ models/                         # æ•°æ®æ¨¡å‹ (Sequelize)
â”‚   â”œâ”€â”€ index.js                    # æ¨¡å‹æ±‡æ€»ã€å…³è”å…³ç³»å®šä¹‰
â”‚   â”œâ”€â”€ User.js                     # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ Survey.js                   # é—®å·æ¨¡å‹
â”‚   â”œâ”€â”€ Answer.js                   # ç­”æ¡ˆæ¨¡å‹
â”‚   â”œâ”€â”€ Comment.js                  # è¯„è®ºæ¨¡å‹
â”‚   â”œâ”€â”€ Favorite.js                 # æ”¶è—æ¨¡å‹
â”‚   â”œâ”€â”€ Category.js                 # åˆ†ç±»æ¨¡å‹
â”‚   â”œâ”€â”€ Badge.js                    # å¾½ç« æ¨¡å‹
â”‚   â”œâ”€â”€ UserBadge.js                # ç”¨æˆ·å¾½ç« å…³è”æ¨¡å‹
â”‚   â”œâ”€â”€ PointHistory.js             # ç§¯åˆ†å†å²æ¨¡å‹
â”‚   â”œâ”€â”€ AdminActivity.js            # ç®¡ç†å‘˜æ´»åŠ¨æ—¥å¿—æ¨¡å‹
â”‚   â”œâ”€â”€ Announcement.js             # å…¬å‘Šæ¨¡å‹
â”‚   â”œâ”€â”€ RecycleBin.js               # å›æ”¶ç«™æ¨¡å‹
â”‚   â””â”€â”€ Report.js                   # æŠ¥å‘Šæ¨¡å‹
â”‚
â”œâ”€â”€ routes/                         # è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ auth.js                     # è®¤è¯è·¯ç”± (/api/auth)
â”‚   â”œâ”€â”€ users.js                    # ç”¨æˆ·è·¯ç”± (/api/users)
â”‚   â”œâ”€â”€ surveys.js                  # é—®å·è·¯ç”± (/api/surveys)
â”‚   â”œâ”€â”€ answers.js                  # ç­”æ¡ˆè·¯ç”± (/api/answers)
â”‚   â”œâ”€â”€ comments.js                 # è¯„è®ºè·¯ç”± (/api/comments)
â”‚   â”œâ”€â”€ categories.js               # åˆ†ç±»è·¯ç”± (/api/categories)
â”‚   â”œâ”€â”€ favorites.js                # æ”¶è—è·¯ç”± (/api/favorites)
â”‚   â”œâ”€â”€ badges.js                   # å¾½ç« è·¯ç”± (/api/badges)
â”‚   â”œâ”€â”€ reports.js                  # æŠ¥å‘Šè·¯ç”± (/api/reports)
â”‚   â”œâ”€â”€ announcements.js            # å…¬å‘Šè·¯ç”± (/api/announcements)
â”‚   â”œâ”€â”€ recycleBin.js               # å›æ”¶ç«™è·¯ç”± (/api/recycleBin)
â”‚   â””â”€â”€ admin.js                    # ç®¡ç†å‘˜è·¯ç”± (/api/admin)
â”‚
â”œâ”€â”€ services/                       # å¤–éƒ¨æœåŠ¡
â”‚   â””â”€â”€ cozeService.js              # Coze AI æœåŠ¡ (æŠ¥å‘Šç”Ÿæˆ)
â”‚
â”œâ”€â”€ utils/                          # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ createPdf.js                # PDF ç”Ÿæˆå·¥å…·
â”‚
â”œâ”€â”€ fonts/                          # PDF å­—ä½“æ–‡ä»¶
â”‚
â”œâ”€â”€ migrations/                     # æ•°æ®è¿ç§»è„šæœ¬
â”‚   â””â”€â”€ import-from-json.js         # ä» db.json å¯¼å…¥æ•°æ®
â”‚
â”œâ”€â”€ app.js                          # Express åº”ç”¨é…ç½®
â”œâ”€â”€ server.js                       # æœåŠ¡å™¨å…¥å£
â”œâ”€â”€ package.json                    # ä¾èµ–é…ç½®
â”œâ”€â”€ .env                            # ç¯å¢ƒå˜é‡ (ä¸æäº¤åˆ° Git)
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1ï¸âƒ£ è®¤è¯æ¨¡å— (`controllers/authController.js`)

#### ç”¨æˆ·æ³¨å†Œ

- **å¯†ç åŠ å¯†**: ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç 
- **å”¯ä¸€æ€§éªŒè¯**: ç”¨æˆ·åã€é‚®ç®±å”¯ä¸€
- **åˆå§‹æ•°æ®**: èµ é€åˆå§‹ç§¯åˆ†ã€é»˜è®¤å¤´åƒ
- **è‡ªåŠ¨ç™»å½•**: æ³¨å†ŒæˆåŠŸåè¿”å› Token

```javascript
exports.register = async (req, res, next) => {
  try {
    const { username, password, email, nickname } = req.body;

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    const existingUser = await User.findOne({ where: { username } });
    if (existingUser) {
      return res.status(400).json({ message: "ç”¨æˆ·åå·²å­˜åœ¨" });
    }

    // åˆ›å»ºç”¨æˆ· (å¯†ç ä¼šåœ¨ beforeCreate hook ä¸­è‡ªåŠ¨åŠ å¯†)
    const user = await User.create({
      id: generateId(),
      username,
      password,
      email,
      nickname: nickname || username,
      points: 100, // åˆå§‹ç§¯åˆ†
      role: "user",
    });

    // ç”Ÿæˆ Token
    const token = jwt.sign(
      { id: user.id, role: user.role },
      process.env.JWT_SECRET,
      { expiresIn: "7d" }
    );

    res.json({
      success: true,
      data: { token, user: user.toSafeObject() },
    });
  } catch (error) {
    next(error);
  }
};
```

#### ç”¨æˆ·ç™»å½•

- **å¯†ç éªŒè¯**: bcrypt æ¯”å¯¹
- **ç”Ÿæˆ Token**: JWT ç­¾å
- **æ›´æ–°ç™»å½•ä¿¡æ¯**: æœ€åç™»å½•æ—¶é—´ã€IP

```javascript
exports.login = async (req, res, next) => {
  try {
    const { username, password } = req.body;

    // æŸ¥æ‰¾ç”¨æˆ·
    const user = await User.findOne({ where: { username } });
    if (!user) {
      return res.status(401).json({ message: "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯" });
    }

    // éªŒè¯å¯†ç 
    const isValid = await user.validatePassword(password);
    if (!isValid) {
      return res.status(401).json({ message: "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯" });
    }

    // æ£€æŸ¥æ˜¯å¦è¢«å°ç¦
    if (user.banned) {
      return res.status(403).json({ message: "è´¦å·å·²è¢«å°ç¦" });
    }

    // æ›´æ–°ç™»å½•ä¿¡æ¯
    await user.update({
      lastLoginAt: new Date(),
      lastLoginIp: req.ip,
      loginCount: user.loginCount + 1,
    });

    // ç”Ÿæˆ Token
    const token = jwt.sign(
      { id: user.id, role: user.role },
      process.env.JWT_SECRET,
      { expiresIn: "7d" }
    );

    res.json({
      success: true,
      data: { token, user: user.toSafeObject() },
    });
  } catch (error) {
    next(error);
  }
};
```

---

### 2ï¸âƒ£ é—®å·æ¨¡å— (`controllers/surveyController.js`)

#### è·å–é—®å·åˆ—è¡¨

- **åˆ†é¡µ**: æ”¯æŒ pageã€limit å‚æ•°
- **ç­›é€‰**: æŒ‰åˆ†ç±»ã€çŠ¶æ€ã€ä½œè€…ç­›é€‰
- **æœç´¢**: æŒ‰æ ‡é¢˜ã€æè¿°å…³é”®è¯æœç´¢
- **æ’åº**: æœ€æ–°ã€æœ€çƒ­ã€è¯„åˆ†æ’åº

```javascript
exports.getSurveys = async (req, res, next) => {
  try {
    const {
      page = 1,
      limit = 10,
      category,
      status = "published",
      keyword,
      sort = "createdAt",
    } = req.query;

    const whereClause = { status };

    if (category && category !== "all") {
      whereClause.category = category;
    }

    if (keyword) {
      whereClause[Op.or] = [
        { title: { [Op.like]: `%${keyword}%` } },
        { description: { [Op.like]: `%${keyword}%` } },
      ];
    }

    const { count, rows } = await Survey.findAndCountAll({
      where: whereClause,
      include: [
        {
          model: User,
          as: "creator",
          attributes: ["id", "username", "nickname", "avatar"],
        },
        {
          model: Category,
          as: "categoryInfo",
          attributes: ["id", "name", "slug"],
        },
      ],
      order: [[sort, "DESC"]],
      limit: parseInt(limit),
      offset: (parseInt(page) - 1) * parseInt(limit),
    });

    res.json({
      success: true,
      data: {
        surveys: rows,
        total: count,
        page: parseInt(page),
        totalPages: Math.ceil(count / parseInt(limit)),
      },
    });
  } catch (error) {
    next(error);
  }
};
```

#### åˆ›å»ºé—®å·

- **æ•°æ®éªŒè¯**: å¿…å¡«å­—æ®µã€é¢˜ç›®æ•°é‡
- **ID ç”Ÿæˆ**: å”¯ä¸€ ID
- **åˆå§‹çŠ¶æ€**: draft (è‰ç¨¿) æˆ– pending (å¾…å®¡æ ¸)

```javascript
exports.createSurvey = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      title,
      description,
      category,
      categoryId,
      questionList,
      settings,
      tags,
      status = "draft",
    } = req.body;

    const survey = await Survey.create({
      id: generateId(),
      userId,
      title,
      description,
      category,
      categoryId,
      questionList,
      settings,
      tags,
      questions: questionList.length,
      status,
      publishedAt: status === "published" ? new Date() : null,
    });

    res.json({
      success: true,
      data: survey,
    });
  } catch (error) {
    next(error);
  }
};
```

#### æ›´æ–°é—®å·

- **æƒé™æ£€æŸ¥**: åªèƒ½æ›´æ–°è‡ªå·±çš„é—®å·
- **çŠ¶æ€é™åˆ¶**: å·²å‘å¸ƒçš„é—®å·éƒ¨åˆ†å­—æ®µä¸å¯ä¿®æ”¹

```javascript
exports.updateSurvey = async (req, res, next) => {
  try {
    const { id } = req.params;
    const userId = req.user.id;

    const survey = await Survey.findByPk(id);
    if (!survey) {
      return res.status(404).json({ message: "é—®å·ä¸å­˜åœ¨" });
    }

    // æƒé™æ£€æŸ¥
    if (survey.userId !== userId && req.user.role !== "admin") {
      return res.status(403).json({ message: "æ— æƒé™ä¿®æ”¹æ­¤é—®å·" });
    }

    await survey.update(req.body);

    res.json({
      success: true,
      data: survey,
    });
  } catch (error) {
    next(error);
  }
};
```

---

### 3ï¸âƒ£ ç­”æ¡ˆæ¨¡å— (`controllers/answerController.js`)

#### æäº¤ç­”æ¡ˆ

- **ç­”æ¡ˆä¿å­˜**: JSON æ ¼å¼å­˜å‚¨
- **é—®å·ç»Ÿè®¡æ›´æ–°**: å¢åŠ å‚ä¸äººæ•°ã€å›ç­”æ•°
- **ç§¯åˆ†å¥–åŠ±**: ç­”é¢˜åèµ é€ç§¯åˆ†
- **é‡å¤æ£€æµ‹**: é˜²æ­¢é‡å¤æäº¤

```javascript
exports.submitAnswer = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const { surveyId, surveyTitle, answers, score, result, duration } =
      req.body;

    // æ£€æŸ¥æ˜¯å¦å·²ç­”è¿‡
    const existingAnswer = await Answer.findOne({
      where: { userId, surveyId },
    });

    if (existingAnswer) {
      return res.status(400).json({ message: "æ‚¨å·²ç»å›ç­”è¿‡æ­¤é—®å·" });
    }

    // åˆ›å»ºç­”æ¡ˆ
    const answer = await Answer.create({
      id: generateId(),
      userId,
      surveyId,
      surveyTitle,
      answers,
      score,
      result,
      duration,
      submittedAt: new Date(),
    });

    // æ›´æ–°é—®å·ç»Ÿè®¡
    const survey = await Survey.findByPk(surveyId);
    if (survey) {
      await survey.update({
        participants: survey.participants + 1,
        responses: survey.responses + 1,
        answerCount: survey.answerCount + 1,
      });
    }

    // èµ é€ç§¯åˆ†
    const user = await User.findByPk(userId);
    await user.update({ points: user.points + 10 });
    await PointHistory.create({
      userId,
      points: 10,
      action: "å®Œæˆé—®å·",
      description: `å®Œæˆé—®å·ã€Š${surveyTitle}ã€‹`,
    });

    res.json({
      success: true,
      data: answer,
    });
  } catch (error) {
    next(error);
  }
};
```

---

### 4ï¸âƒ£ AI æŠ¥å‘Šæ¨¡å— (`controllers/reportController.js` & `services/cozeService.js`)

#### ç”ŸæˆæŠ¥å‘Š

- **Coze API è°ƒç”¨**: åŸºäºç”¨æˆ·ä¿¡æ¯å’Œç­”æ¡ˆç”Ÿæˆä¸ªæ€§åŒ–æŠ¥å‘Š
- **å¼‚æ­¥å¤„ç†**: åå°ç”Ÿæˆï¼Œè½®è¯¢çŠ¶æ€
- **çŠ¶æ€ç®¡ç†**: generating -> completed / failed

**Coze æœåŠ¡** (`services/cozeService.js`):

```javascript
const { CozeAPI, ChatEventType } = require("@coze/api");

const client = new CozeAPI({
  token: process.env.COZE_API_KEY,
});

async function generatePersonalReport(userProfile, survey, answers) {
  try {
    // æ„é€ æç¤ºè¯
    const prompt = `
      ç”¨æˆ·ä¿¡æ¯:
      - æ˜µç§°: ${userProfile.nickname}
      - å¹´é¾„: ${userProfile.age}
      - æ€§åˆ«: ${userProfile.gender}
      - èŒä¸š: ${userProfile.profession}
      - åŸå¸‚: ${userProfile.city}
      - ä¸ªäººç®€ä»‹: ${userProfile.bio}
      - æ ‡ç­¾: ${userProfile.tags?.join(", ")}
      
      é—®å·: ${survey.title}
      åˆ†ç±»: ${survey.category}
      
      ç”¨æˆ·ç­”æ¡ˆ:
      ${answers.map((a, i) => `${i + 1}. ${a.question}: ${a.text}`).join("\n")}
      
      è¯·ç”Ÿæˆä¸€ä»½ä¸ªæ€§åŒ–çš„åˆ†ææŠ¥å‘Šã€‚
    `;

    // è°ƒç”¨ Coze API
    const stream = await client.chat.stream({
      bot_id: process.env.COZE_BOT_ID,
      user_id: userProfile.username,
      additional_messages: [
        {
          role: "user",
          content: prompt,
          content_type: "text",
        },
      ],
    });

    let reportContent = "";

    for await (const chunk of stream) {
      if (chunk.event === ChatEventType.CONVERSATION_MESSAGE_DELTA) {
        reportContent += chunk.data.content;
      }
    }

    return reportContent;
  } catch (error) {
    console.error("Coze API è°ƒç”¨å¤±è´¥:", error);
    throw new Error("AI æŠ¥å‘Šç”Ÿæˆå¤±è´¥");
  }
}

module.exports = { generatePersonalReport };
```

#### ä¸‹è½½æŠ¥å‘Š (PDF)

- **PDF ç”Ÿæˆ**: ä½¿ç”¨ PDFKit
- **ä¸­æ–‡æ”¯æŒ**: ä½¿ç”¨æ€æºå­—ä½“
- **æµå¼ä¸‹è½½**: Stream æ–¹å¼è¿”å›

**PDF å·¥å…·** (`utils/createPdf.js`):

```javascript
const PDFDocument = require("pdfkit");
const fs = require("fs");
const path = require("path");

async function createPdf(data) {
  return new Promise((resolve, reject) => {
    const doc = new PDFDocument();
    const filename = `report_${Date.now()}.pdf`;
    const filepath = path.join(__dirname, "../temp", filename);

    // æ³¨å†Œä¸­æ–‡å­—ä½“
    doc.registerFont(
      "SourceHanSans",
      path.join(__dirname, "../fonts/SourceHanSansCN-Regular.otf")
    );

    const stream = fs.createWriteStream(filepath);
    doc.pipe(stream);

    // æ ‡é¢˜
    doc
      .font("SourceHanSans")
      .fontSize(20)
      .text(data.title, { align: "center" });

    doc.moveDown();

    // å‰¯æ ‡é¢˜
    doc.fontSize(14).text(data.subtitle);
    doc.moveDown();

    // å†…å®¹
    doc.fontSize(12).text(data.content, {
      align: "left",
      lineGap: 5,
    });

    doc.end();

    stream.on("finish", () => resolve(filepath));
    stream.on("error", reject);
  });
}

module.exports = createPdf;
```

---

### 5ï¸âƒ£ ç®¡ç†å‘˜æ¨¡å— (`controllers/adminController.js`)

#### ä»ªè¡¨æ¿ç»Ÿè®¡

- **ç”¨æˆ·ç»Ÿè®¡**: æ€»æ•°ã€æ–°å¢ã€æ´»è·ƒ
- **é—®å·ç»Ÿè®¡**: æ€»æ•°ã€å¾…å®¡æ ¸ã€å·²å‘å¸ƒ
- **ç­”é¢˜ç»Ÿè®¡**: æ€»æ•°ã€ä»Šæ—¥
- **è¶‹åŠ¿å›¾æ•°æ®**: 7 å¤©/30 å¤©è¶‹åŠ¿

```javascript
exports.getDashboardStats = async (req, res, next) => {
  try {
    // ç”¨æˆ·ç»Ÿè®¡
    const totalUsers = await User.count();
    const todayUsers = await User.count({
      where: {
        createdAt: {
          [Op.gte]: new Date(new Date().setHours(0, 0, 0, 0)),
        },
      },
    });

    // é—®å·ç»Ÿè®¡
    const totalSurveys = await Survey.count();
    const pendingSurveys = await Survey.count({ where: { status: "pending" } });
    const publishedSurveys = await Survey.count({
      where: { status: "published" },
    });

    // ç­”é¢˜ç»Ÿè®¡
    const totalAnswers = await Answer.count();
    const todayAnswers = await Answer.count({
      where: {
        submittedAt: {
          [Op.gte]: new Date(new Date().setHours(0, 0, 0, 0)),
        },
      },
    });

    res.json({
      success: true,
      data: {
        users: { total: totalUsers, today: todayUsers },
        surveys: {
          total: totalSurveys,
          pending: pendingSurveys,
          published: publishedSurveys,
        },
        answers: { total: totalAnswers, today: todayAnswers },
      },
    });
  } catch (error) {
    next(error);
  }
};
```

#### é—®å·å®¡æ ¸

- **å®¡æ ¸æ“ä½œ**: é€šè¿‡ (published) / æ‹’ç» (rejected)
- **å®¡æ ¸æ„è§**: è®°å½•å®¡æ ¸ç†ç”±
- **é€šçŸ¥**: é€šçŸ¥é—®å·åˆ›å»ºè€… (å¯é€‰)

```javascript
exports.reviewSurvey = async (req, res, next) => {
  try {
    const { id } = req.params;
    const { action, reason } = req.body; // action: 'approve' | 'reject'

    const survey = await Survey.findByPk(id);
    if (!survey) {
      return res.status(404).json({ message: "é—®å·ä¸å­˜åœ¨" });
    }

    const newStatus = action === "approve" ? "published" : "rejected";

    await survey.update({
      status: newStatus,
      publishedAt: action === "approve" ? new Date() : null,
    });

    // è®°å½•ç®¡ç†å‘˜æ“ä½œ
    await AdminActivity.create({
      adminId: req.user.id,
      action: `å®¡æ ¸é—®å·: ${action === "approve" ? "é€šè¿‡" : "æ‹’ç»"}`,
      targetType: "survey",
      targetId: id,
      details: reason,
    });

    res.json({
      success: true,
      message: `é—®å·å·²${action === "approve" ? "é€šè¿‡" : "æ‹’ç»"}å®¡æ ¸`,
    });
  } catch (error) {
    next(error);
  }
};
```

---

## ğŸ” ä¸­é—´ä»¶è¯¦è§£

### è®¤è¯ä¸­é—´ä»¶ (`middleware/auth.js`)

```javascript
const jwt = require("jsonwebtoken");

// JWT è®¤è¯
exports.authenticate = (req, res, next) => {
  try {
    const token = req.headers.authorization?.replace("Bearer ", "");

    if (!token) {
      return res.status(401).json({ message: "æœªæä¾›è®¤è¯ä»¤ç‰Œ" });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded; // { id, role }
    next();
  } catch (error) {
    return res.status(401).json({ message: "æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ" });
  }
};

// å¯é€‰è®¤è¯ (ä¸å¼ºåˆ¶è¦æ±‚ç™»å½•)
exports.optionalAuth = (req, res, next) => {
  try {
    const token = req.headers.authorization?.replace("Bearer ", "");
    if (token) {
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      req.user = decoded;
    }
  } catch (error) {
    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
  }
  next();
};

// ç®¡ç†å‘˜æƒé™æ£€æŸ¥
exports.requireAdmin = (req, res, next) => {
  if (req.user.role !== "admin") {
    return res.status(403).json({ message: "éœ€è¦ç®¡ç†å‘˜æƒé™" });
  }
  next();
};
```

---

### éªŒè¯ä¸­é—´ä»¶ (`middleware/validator.js`)

```javascript
const { body, param, query, validationResult } = require("express-validator");

// éªŒè¯ç»“æœæ£€æŸ¥
const validate = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }
  next();
};

// ç™»å½•éªŒè¯
exports.validateLogin = [
  body("username").notEmpty().withMessage("ç”¨æˆ·åä¸èƒ½ä¸ºç©º"),
  body("password").notEmpty().withMessage("å¯†ç ä¸èƒ½ä¸ºç©º"),
  validate,
];

// æ³¨å†ŒéªŒè¯
exports.validateRegister = [
  body("username")
    .isLength({ min: 3, max: 20 })
    .withMessage("ç”¨æˆ·åé•¿åº¦ä¸º 3-20 ä¸ªå­—ç¬¦")
    .matches(/^[a-zA-Z0-9_]+$/)
    .withMessage("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿"),
  body("password").isLength({ min: 6 }).withMessage("å¯†ç è‡³å°‘ 6 ä¸ªå­—ç¬¦"),
  body("email").optional().isEmail().withMessage("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"),
  validate,
];

// é—®å·éªŒè¯
exports.validateSurvey = [
  body("title").notEmpty().withMessage("é—®å·æ ‡é¢˜ä¸èƒ½ä¸ºç©º"),
  body("questionList").isArray({ min: 1 }).withMessage("è‡³å°‘éœ€è¦ä¸€ä¸ªé—®é¢˜"),
  validate,
];

// ID éªŒè¯
exports.validateId = [
  param("id").notEmpty().withMessage("ID ä¸èƒ½ä¸ºç©º"),
  validate,
];

// åˆ†é¡µéªŒè¯
exports.validatePagination = [
  query("page").optional().isInt({ min: 1 }).toInt(),
  query("limit").optional().isInt({ min: 1, max: 100 }).toInt(),
  validate,
];
```

---

### é”™è¯¯å¤„ç†ä¸­é—´ä»¶ (`middleware/errorHandler.js`)

```javascript
module.exports = (err, req, res, next) => {
  console.error("é”™è¯¯:", err);

  // Sequelize éªŒè¯é”™è¯¯
  if (err.name === "SequelizeValidationError") {
    return res.status(400).json({
      success: false,
      message: "æ•°æ®éªŒè¯å¤±è´¥",
      errors: err.errors.map((e) => e.message),
    });
  }

  // Sequelize å”¯ä¸€æ€§çº¦æŸé”™è¯¯
  if (err.name === "SequelizeUniqueConstraintError") {
    return res.status(400).json({
      success: false,
      message: "æ•°æ®å·²å­˜åœ¨",
      field: err.errors[0]?.path,
    });
  }

  // JWT é”™è¯¯
  if (err.name === "JsonWebTokenError") {
    return res.status(401).json({
      success: false,
      message: "æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ",
    });
  }

  // é»˜è®¤é”™è¯¯
  res.status(err.status || 500).json({
    success: false,
    message: err.message || "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
  });
};
```

---

## ğŸ—„ï¸ æ•°æ®åº“é…ç½®

### Sequelize é…ç½® (`config/database.js`)

```javascript
const { Sequelize } = require("sequelize");

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    dialect: "mysql",
    logging: process.env.NODE_ENV === "development" ? console.log : false,
    pool: {
      max: 5, // æœ€å¤§è¿æ¥æ•°
      min: 0, // æœ€å°è¿æ¥æ•°
      acquire: 30000, // è·å–è¿æ¥è¶…æ—¶æ—¶é—´
      idle: 10000, // è¿æ¥ç©ºé—²è¶…æ—¶æ—¶é—´
    },
    timezone: "+08:00",
    define: {
      timestamps: true,
      underscored: false,
      freezeTableName: true,
    },
  }
);

module.exports = sequelize;
```

---

## ğŸš€ åº”ç”¨å¯åŠ¨

### Express åº”ç”¨ (`app.js`)

```javascript
const express = require("express");
const cors = require("cors");
const helmet = require("helmet");
const errorHandler = require("./middleware/errorHandler");

const app = express();

// å®‰å…¨ä¸­é—´ä»¶
app.use(helmet());

// CORS
app.use(
  cors({
    origin: ["http://localhost:5173", "http://localhost:3000"],
    credentials: true,
  })
);

// Body è§£æ
app.use(express.json({ limit: "10mb" }));
app.use(express.urlencoded({ extended: true }));

// è·¯ç”±
app.use("/api/auth", require("./routes/auth"));
app.use("/api/users", require("./routes/users"));
app.use("/api/surveys", require("./routes/surveys"));
app.use("/api/answers", require("./routes/answers"));
app.use("/api/comments", require("./routes/comments"));
app.use("/api/categories", require("./routes/categories"));
app.use("/api/favorites", require("./routes/favorites"));
app.use("/api/badges", require("./routes/badges"));
app.use("/api/reports", require("./routes/reports"));
app.use("/api/announcements", require("./routes/announcements"));
app.use("/api/admin", require("./routes/admin"));

// é”™è¯¯å¤„ç†
app.use(errorHandler);

module.exports = app;
```

### æœåŠ¡å™¨å…¥å£ (`server.js`)

```javascript
require("dotenv").config();
const app = require("./app");
const sequelize = require("./config/database");

const PORT = process.env.PORT || 3000;

// æ•°æ®åº“è¿æ¥å’Œè¡¨åŒæ­¥
sequelize
  .sync({ alter: true })
  .then(() => {
    console.log("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ");

    app.listen(PORT, () => {
      console.log(`ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${PORT}`);
    });
  })
  .catch((err) => {
    console.error("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:", err);
    process.exit(1);
  });
```

---

## ğŸ“¦ éƒ¨ç½²å»ºè®®

### ç¯å¢ƒå˜é‡ (`.env`)

```env
# æ•°æ®åº“
DB_HOST=localhost
DB_PORT=3306
DB_NAME=questionnaire_db
DB_USER=root
DB_PASSWORD=your_password

# JWT
JWT_SECRET=your_secret_key_here
JWT_EXPIRES_IN=7d

# æœåŠ¡å™¨
PORT=3000
NODE_ENV=production

# Coze API
COZE_API_KEY=your_coze_api_key
COZE_BOT_ID=your_bot_id
```

### PM2 éƒ¨ç½²

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨åº”ç”¨
pm2 start server.js --name questionnaire-api

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs

# é‡å¯
pm2 restart questionnaire-api
```

---

## ğŸ” API å“åº”æ ¼å¼

### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": { ... },
  "message": "æ“ä½œæˆåŠŸ"
}
```

### é”™è¯¯å“åº”

```json
{
  "success": false,
  "message": "é”™è¯¯ä¿¡æ¯",
  "errors": [ ... ]
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025 å¹´ 12 æœˆ 1 æ—¥
